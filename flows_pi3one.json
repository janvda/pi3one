[{"id":"9ec36226.6064b","type":"tab","label":"nodeMCU","disabled":false,"info":""},{"id":"7fdd45e3.83045c","type":"tab","label":"credentials","disabled":false,"info":""},{"id":"fed72f15.8d836","type":"tab","label":"arp-scan","disabled":false,"info":""},{"id":"f4083ef1.c832a","type":"tab","label":"slack cv channel","disabled":false,"info":""},{"id":"bb5e766d.b0bbe8","type":"tab","label":"slackbot","disabled":false,"info":""},{"id":"56164435.31050c","type":"tab","label":"ui aiy","disabled":false,"info":""},{"id":"35b4329c.b0c8fe","type":"tab","label":"de mol","disabled":true,"info":""},{"id":"19233749.06c6d9","type":"tab","label":"conversation","disabled":true,"info":""},{"id":"604db05c.f6f11","type":"tab","label":"aiy2slack","disabled":true,"info":""},{"id":"c7bb51ea.b7706","type":"tab","label":"ui weather"},{"id":"ae997a8f.fef6b8","type":"tab","label":"ui emoncms"},{"id":"d9c9b8f2.5b1738","type":"tab","label":"ui power"},{"id":"cbb123e.ff1e2e","type":"tab","label":"ui status"},{"id":"d448e38d.8eb16","type":"tab","label":"ui status2"},{"id":"e6728257.d2c86","type":"tab","label":"ui ventilator"},{"id":"7fa2194.bf802e8","type":"tab","label":"ui cv","disabled":false,"info":""},{"id":"d3bff47.a17e508","type":"tab","label":"pi cpu temp"},{"id":"89ac662.0a2c798","type":"tab","label":"openweather"},{"id":"21777d41.84c182","type":"tab","label":"emoncms"},{"id":"669ca4d9.6412bc","type":"tab","label":"emonTh/Tx","disabled":false,"info":""},{"id":"83200356.0ef81","type":"tab","label":"3ch wifi relay"},{"id":"70877b4a.1bbb44","type":"tab","label":"cv calendar"},{"id":"9519878f.6ae678","type":"tab","label":"kodi"},{"id":"4bf9468a.f3a898","type":"tab","label":"bme280"},{"id":"3f0318fd.5897c8","type":"tab","label":"power consumption"},{"id":"212e34f.4a0cfcc","type":"tab","label":"my public ip address","disabled":false,"info":""},{"id":"d00c308a.cf163","type":"tab","label":"IBM Cloud","disabled":false,"info":""},{"id":"9a70cce2.ab388","type":"tab","label":"Flow 1","disabled":true,"info":""},{"id":"86117963.0fe068","type":"tab","label":"Quantum Tweet Tone","disabled":true,"info":""},{"id":"589de0d1.83cae","type":"emoncms-server","z":"","server":"http://localhost/emoncms","name":"pi3one emoncms"},{"id":"c01dc48e.9149f8","type":"ui_tab","z":"","name":"CV","icon":"dashboard","order":7},{"id":"26bbff78.ed3c6","type":"ui_group","z":"","name":"invoer","tab":"c01dc48e.9149f8","disp":true,"width":"6"},{"id":"37779cb4.2ff4e4","type":"ui_group","z":"","name":"Status","tab":"c01dc48e.9149f8","disp":true,"width":"6"},{"id":"9c9ae2bc.63652","type":"mqtt-broker","z":"","broker":"192.168.1.131","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"e8a1e039.d2ddb","type":"ui_tab","z":"","name":"Status","icon":"dashboard","order":4},{"id":"3d9accab.6c2634","type":"ui_group","z":"","name":"Kelder","tab":"e8a1e039.d2ddb","order":2,"disp":true,"width":"3"},{"id":"a5cd413.e0d49c","type":"ui_group","z":"","name":"Temp","tab":"e8a1e039.d2ddb","order":3,"disp":true,"width":"3"},{"id":"dfabd96f.d0b918","type":"ui_group","z":"","name":"Vochtigheid","tab":"e8a1e039.d2ddb","order":4,"disp":true,"width":"3"},{"id":"f2cec1e7.bc085","type":"ui_group","z":"","name":"Electriciteit","tab":"e8a1e039.d2ddb","order":1,"disp":true,"width":"4"},{"id":"ec772749.149488","type":"ui_group","z":"","name":"Home Power Consumption","tab":"ec3541ea.2b297","order":1,"disp":true,"width":"7"},{"id":"ea983e7d.03c39","type":"ui_group","z":"","name":"Solar Power Generation","tab":"ec3541ea.2b297","order":2,"disp":true,"width":"7"},{"id":"ec3541ea.2b297","type":"ui_tab","z":"d9c9b8f2.5b1738","name":"Power","icon":"power","order":3},{"id":"ed98cf29.79e9e","type":"ui_group","z":"","name":"Barometer","tab":"e8a1e039.d2ddb","order":6,"disp":true,"width":"3"},{"id":"e100e6d5.3b9a78","type":"ui_tab","z":"","name":"Ventilator","icon":"dashboard","order":6},{"id":"51a17efa.1c638","type":"ui_group","z":"","name":"invoer","tab":"e100e6d5.3b9a78","order":1,"disp":true,"width":"4"},{"id":"f628845.5523878","type":"ui_group","z":"","name":"Status","tab":"e100e6d5.3b9a78","order":2,"disp":true,"width":"5"},{"id":"d0b9b2cd.d453d","type":"ui_group","z":"","name":"Abs. Vochtigheid","tab":"e8a1e039.d2ddb","order":5,"disp":true,"width":"4"},{"id":"304bc08.37fbf4","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"Helvetica Neue","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"Helvetica Neue"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"2ffa32f8.185ace","type":"ui_group","z":"","name":"Home Consumption & Generation","tab":"ec3541ea.2b297","order":3,"disp":true,"width":"14"},{"id":"172cc9ae.c0d246","type":"ui_tab","z":"","name":"status 2","icon":"dashboard","order":5},{"id":"83960579.c80148","type":"ui_group","z":"","name":"network devices","tab":"172cc9ae.c0d246","order":1,"disp":true,"width":"9"},{"id":"c75b2ad7.9d6f98","type":"ui_group","z":"","name":"Absolute Vochtigheid","tab":"e100e6d5.3b9a78","order":3,"disp":true,"width":"12"},{"id":"1136228c.3d68bd","type":"ui_group","z":"","name":"emoncms chart","tab":"6a24cd4a.de7ef4","order":4,"disp":false,"width":"20"},{"id":"3bbe7a3b.70c496","type":"ui_group","z":"","name":"chart selector","tab":"6a24cd4a.de7ef4","order":3,"disp":false,"width":"3"},{"id":"859d9075.9393c","type":"ui_group","z":"","name":"chart category selector","tab":"6a24cd4a.de7ef4","order":2,"disp":false,"width":"2"},{"id":"93ffe36a.9369f","type":"ui_group","z":"","name":"device selector","tab":"6a24cd4a.de7ef4","order":1,"disp":false,"width":"1"},{"id":"6a24cd4a.de7ef4","type":"ui_tab","z":"","name":"emoncms","icon":"dashboard","order":2},{"id":"f0778f34.31c0b","type":"ui_tab","z":"","name":"borsbeek","icon":"dashboard","order":1},{"id":"3d15fa9f.dfffe6","type":"ui_group","z":"","name":"buienradar","tab":"f0778f34.31c0b","order":2,"disp":true,"width":"7"},{"id":"5d9dca08.657f84","type":"ui_group","z":"","name":"rain expectations","tab":"f0778f34.31c0b","order":3,"disp":false,"width":"4"},{"id":"1d6cbfef.15f53","type":"ui_group","z":"","name":"borsbeek 48 hours forecast","tab":"f0778f34.31c0b","order":4,"disp":false,"width":"16"},{"id":"355d00d6.9da31","type":"ui_group","z":"","name":"forecast 48h chart","tab":"f0778f34.31c0b","order":1,"disp":false,"width":"9"},{"id":"6e76318c.44294","type":"google-credentials","z":0,"displayName":"Jan Van den Audenaerde"},{"id":"d4b7b30a.7abac","type":"sqlitedb","z":"","db":"/mnt/wd1tb_media/media/data/sqlite/nodered_jvda.db"},{"id":"2165c3e7.72140c","type":"slackbot-controller","z":"","name":"stemija","bot_token":"xoxb-260893882374-kmNnsoh5w3T4mef3j3zJVkZ8"},{"id":"33c793c6.f46c9c","type":"ui_group","z":"","name":"roos = °T kamer jade","tab":"c01dc48e.9149f8","order":3,"disp":true,"width":"6"},{"id":"6866c6a8.3d4518","type":"ui_tab","z":"","name":"AIY","icon":"dashboard","order":8},{"id":"2fdf50c.264aab","type":"ui_group","z":"","name":"OK google","tab":"6866c6a8.3d4518","order":3,"disp":true,"width":"6"},{"id":"fe02baf8.ead938","type":"ui_group","z":"","name":"stemija","tab":"6866c6a8.3d4518","order":2,"disp":true,"width":"6"},{"id":"d387f35b.da6a6","type":"slackbot-controller","z":"","name":"stemija slackbot","bot_token":"xoxb-260893882374-sOx3ETMKVqkDvOxmHtV5NOqy"},{"id":"db6af561.c39d68","type":"ui_group","z":"","name":"Snowboy","tab":"6866c6a8.3d4518","order":1,"disp":true,"width":"6"},{"id":"65c19335.9c7b5c","type":"ui_group","z":"","name":"Volume","tab":"6866c6a8.3d4518","order":4,"disp":true,"width":"6"},{"id":"c155bcf2.3fab9","type":"mqtt-broker","z":"","name":"pi3three mqtt broker","broker":"192.168.1.33","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"d3c6a10d.5a408","type":"twitter-credentials","z":"","screen_name":"pi3one"},{"id":"1a76d143.cc0e7f","type":"ui_tab","z":"","name":"Water Meter","icon":"dashboard","order":9},{"id":"819fde39.8d275","type":"ui_group","z":"","name":"charts","tab":"1a76d143.cc0e7f","order":5,"disp":false,"width":"7","collapse":false},{"id":"4fce2e4b.e9118","type":"ui_group","z":"","name":"measure pulses","tab":"1a76d143.cc0e7f","order":3,"disp":true,"width":"7","collapse":false},{"id":"f3a00a41.9ff0d8","type":"wiotp-credentials","z":"","name":"Watson IoT (pi3one)","org":"eoxoyz","serverName":"eoxoyz.messaging.internetofthings.ibmcloud.com","devType":"pi","devId":"pi3one","keepalive":"60","cleansession":false,"tls":"","usetls":false},{"id":"1b6e52cb.30e93d","type":"ui_group","z":"","name":"chart last day","tab":"1a76d143.cc0e7f","order":2,"disp":false,"width":"10","collapse":false},{"id":"f50c0ee3.d016b","type":"ui_group","z":"","name":"gauge","tab":"1a76d143.cc0e7f","order":4,"disp":false,"width":"3","collapse":false},{"id":"f50c02cd.1436a","type":"ui_group","z":"","name":"chart last hour","tab":"1a76d143.cc0e7f","order":1,"disp":false,"width":"20","collapse":false},{"id":"dbb0c636.8308f8","type":"exec","z":"fed72f15.8d836","command":"arp-scan --localnet --ignoredups","addpay":false,"append":"","useSpawn":"","timer":"","oldrc":false,"name":"arp-scan","x":202.1999969482422,"y":114.19999694824219,"wires":[["ce9615c9.d681a8","14de4cc.88f58b3"],["7bbee7a6.61e6c8"],["a9e1df05.ad856"]]},{"id":"4e5d70a1.6ebaa","type":"inject","z":"fed72f15.8d836","name":"every 5 minutes","topic":"","payload":"","payloadType":"none","repeat":"300","crontab":"","once":false,"x":141.1999969482422,"y":77.19999694824219,"wires":[["dbb0c636.8308f8"]]},{"id":"7bbee7a6.61e6c8","type":"debug","z":"fed72f15.8d836","name":"stderr","active":false,"console":"false","complete":"true","x":387.1999969482422,"y":100.19999694824219,"wires":[]},{"id":"a9e1df05.ad856","type":"debug","z":"fed72f15.8d836","name":"return code","active":false,"console":"false","complete":"true","x":407.1999969482422,"y":128.1999969482422,"wires":[]},{"id":"ce9615c9.d681a8","type":"debug","z":"fed72f15.8d836","name":"stdout","active":false,"console":"false","complete":"true","x":388.1999969482422,"y":69.19999694824219,"wires":[]},{"id":"14de4cc.88f58b3","type":"function","z":"fed72f15.8d836","name":"arp-scan output to json","func":"// FYI Here below an example of the arp-scan output\n//======= example arp-scan output starts on next line\n//Interface: eth0, datalink type: EN10MB (Ethernet)\n//Starting arp-scan 1.8.1 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)\n//192.168.1.1     6c:2e:85:17:50:04       SAGEMCOM\n//192.168.1.10    80:c1:6e:ed:63:b8       (Unknown)\n// ...\n//192.168.1.29    8c:70:5a:72:d0:9c       (Unknown) (DUP: 2)\n//\n//12 packets received by filter, 0 packets dropped by kernel\n//Ending arp-scan 1.8.1: 256 hosts scanned in 4.096 seconds (62.50 hosts/sec). 11 responded\n//\n//====== example arp-scan finishes on previous line\n\n \nvar lines=msg.payload.split('\\n');\nvar parts;\nvar newMsg = { payload: {MAC_IP_list:[]} };\n\n// Validate arp-scan output: checks that the number of lines corresponds to packets received.\nif (lines.length < 6) {\n    node.error(\"arps-scan output less than 6 lines:\");\n    node.error(msg.payload);\n    return;\n}\n\nvar hosts_responded = lines[lines.length-2].split('hosts/sec). ')[1].split(' responded')[0];\nif (isNaN(Number(hosts_responded))){\n    node.error(\"hosts responded (=\" + hosts_responded + \") is not a number.\");\n    node.error(msg.payload);\n    return;\n}\n\nif (hosts_responded != (lines.length-6) ){\n    node.error(hosts_responded + \" hosts responded doesn't match arp-scan line count:\" + lines.length);\n    node.error(msg.payload);\n    return;\n}\n\nvar packets_received = Number(lines[lines.length-3].split(' packets received by filter')[0]);\n\n// log warning in case hosts responded doesn't match packets received.\nif (hosts_responded != packets_received) {\n    node.warn(\"hosts responded (=\" + hosts_responded + \") != packets received (=\" + packets_received + \")\");\n}\n\n// skip the first 2 lines and last 3 lines\nfor (var i = 2 ; i <lines.length-4; i++){\n    parts = lines[i].split('\\t');\n    //node.warn(\"IP=\"+ parts[0] + \", MAC=\" + parts[1]);\n    newMsg.payload.MAC_IP_list.push( { IP:parts[0], MAC:parts[1] } );\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":398.1999969482422,"y":162.1999969482422,"wires":[["d66fc2b6.59927","1ae06886.3723a7"]]},{"id":"d66fc2b6.59927","type":"debug","z":"fed72f15.8d836","name":"arp scan json output","active":true,"console":"false","complete":"true","x":654.2000122070312,"y":165.1999969482422,"wires":[]},{"id":"1ae06886.3723a7","type":"function","z":"fed72f15.8d836","name":"add hostname","func":"var MAC_to_hostname = [ \n    {MAC:\"e0:b9:e5:af:af:90\" , hostname:\"bbox_jan\"}, // new bbox install at 2017-06-12\n    {MAC:\"e2:b9:e5:af:af:99\" , hostname:\"bbox_jan_62\" },  // bbox is also using IP 192.168.1.62 for this mac\n    {MAC:\"e2:b9:e5:af:af:90\" , hostname:\"bbox_jan_63\" },  // bbox is also using IP 192.168.1.63 for this mac\n    {MAC:\"c4:e9:84:2d:0e:28\" , hostname:\"TL-WPA4220\"},  // powerline extender6\n    {MAC:\"c4:e9:84:2d:0e:9c\" , hostname:\"TL-WPA4220_2\"}, // 2nd // powerline extender6\n    {MAC:\"18:59:33:13:9d:fb\" , hostname:\"cisco_switch\"},\n    {MAC:\"b8:27:eb:4c:14:2d\" , hostname:\"raspberrypi\"},\n    {MAC:\"b8:27:eb:5b:31:bb\" , hostname:\"pi3one\"},\n    {MAC:\"b8:27:eb:49:f1:cd\" , hostname:\"pi3two\"},\n    {MAC:\"b8:27:eb:79:80:3f\" , hostname:\"pi3three\" }, // ethernet\n    {MAC:\"b8:27:eb:2c:d5:6a\" , hostname:\"pi3three\" }, // wifi\n    {MAC:\"00:50:43:01:c1:e6\" , hostname:\"sheevaplug\"},\n    // {MAC:\"18:fe:34:a0:28:3d\" , hostname:\"wifi_relay_cv\"},  // disabled as located on another subnet\n    {MAC:\"00:90:a9:d8:7c:0c\" , hostname:\"WD\"}, // NAS\n    {MAC:\"9c:c7:d1:e8:a9:be\" , hostname:\"TV_sharp\"},\n    {MAC:\"58:bd:a3:7b:65:52\" , hostname:\"Wii\" },  // \n    {MAC:\"80:c1:6e:ed:63:b8\" , hostname:\"chitzen\"},\n    {MAC:\"34:23:87:7a:e5:8b\" , hostname:\"SonyLaptop\"},\n    {MAC:\"8c:70:5a:72:d0:9c\" , hostname:\"OldLaptopJanWerk\"}, // wifi\n    {MAC:\"00:21:CC:C4:95:47\" , hostname:\"OldLaptopJanWerk\"}, // ethernet \n    {MAC:\"50:7B:9D:E8:1A:57\" , hostname:\"LaptopJanWerk\"}, // ethernet 50-7B-9D-E8-1A-57\n    {MAC:\"44:85:00:77:c2:57\" , hostname:\"LaptopJanWerk\"}, // wifi MAC_44_85_00_77_c2_57\n    {MAC:\"00:16:CF:5B:4D:5A\" , hostname:\"oudeLaptopJan\"}, // wifi\n    {MAC:\"00:16:41:ab:18:94\" , hostname:\"oudeLaptopJan\"}, // ethernet\n    {MAC:\"78:92:9C:00:F5:B6\" , hostname:\"LaptopJade\"}, // wifi \n    {MAC:\"00:13:33:9a:bd:82\" , hostname:\"LaptopJade\"}, // wifi2 (akoya has 2 wifi)\n    {MAC:\"00:26:2D:C5:4D:35\" , hostname:\"LaptopJade\"}, // ethernet\n    {MAC:\"38:B1:DB:E6:43:97\" , hostname:\"LaptopJadeAlex\"}, // wifi \n    {MAC:\"b8:ee:65:3a:76:c0\" , hostname:\"LaptopMirkoSterre\"}, // ethernet\n    {MAC:\"ac:2b:6e:c0:01:e8\" , hostname:\"LaptopSterre\"}, // wifi\n    {MAC:\"b4:30:52:83:1f:eb\" , hostname:\"HuaweiSterre\"}, \n    {MAC:\"70:72:3c:ea:77:5d\" , hostname:\"OudeHuaweiJan\"},\n    {MAC:\"5c:b5:24:97:09:a9\" , hostname:\"SonyGsmMarleen\" },\n    {MAC:\"88:e8:7f:d7:db:d1\" , hostname:\"iphoneMarleen\" }, // added 2018-01-18\n    {MAC:\"ac:fd:ec:4e:d1:e4\" , hostname:\"oude_iphoneMarleen\" }, // renamed: old name \"iphoneMarleen\"\n    {MAC:\"84:8e:0c:5a:34:d8\" , hostname:\"iphoneJade\" },\n    {MAC:\"2c:33:61:82:cc:67\" , hostname:\"iphone7Jade\" },    \n    {MAC:\"48:e9:f1:16:1f:33\" , hostname:\"ipodMirko\" },\n    {MAC:\"88:11:96:a6:d6:fd\" , hostname:\"gsmMirko\" }, // added 2018-10-17\n    {MAC:\"08:60:6E:AB:A3:31\" , hostname:\"tabletNexus\"},\n    {MAC:\"2c:0e:3d:5d:b4:1c\" , hostname:\"S7Jan\"},\n    {MAC:\"d4:ae:05:8a:3a:a9\" , hostname:\"tabletSamsung\"},\n    {MAC:\"d0:2b:20:f0:1b:8d\" , hostname:\"iphone8Jan\"}\n    ];\n\nfor (var i=0; i<msg.payload.MAC_IP_list.length; i++){\n    var l_hostname = \"MAC_\"+msg.payload.MAC_IP_list[i].MAC.replace(/:/g,\"_\");\n    // Find Hostname for MAC\n    for (var j=0; j<MAC_to_hostname.length; j++){\n        if (MAC_to_hostname[j].MAC.toLowerCase()==\n                                          msg.payload.MAC_IP_list[i].MAC.toLowerCase()){\n            l_hostname = MAC_to_hostname[j].hostname;\n            break; // jump out of inner for loop\n        }\n    }\n    msg.payload.MAC_IP_list[i].hostname=l_hostname;\n}\nreturn msg;","outputs":1,"noerr":0,"x":386.1999969482422,"y":193.1999969482422,"wires":[["cfd22518.f3a0f8","78c44597.bf5dcc"]]},{"id":"cfd22518.f3a0f8","type":"debug","z":"fed72f15.8d836","name":"... plus hostname","active":true,"console":"false","complete":"true","x":606.1999969482422,"y":195.1999969482422,"wires":[]},{"id":"78c44597.bf5dcc","type":"function","z":"fed72f15.8d836","name":"hosts online (=1), not online (=0)[ ","func":"var MAC_to_hostname = [ \n    {MAC:\"e0:b9:e5:af:af:90\" , hostname:\"bbox_jan\"},\n    {MAC:\"e2:b9:e5:af:af:99\" , hostname:\"bbox_jan_62\" },  // bbox is also using IP 192.168.1.62 for this mac\n    {MAC:\"e2:b9:e5:af:af:90\" , hostname:\"bbox_jan_63\" },  // bbox is also using IP 192.168.1.63 for this mac\n    {MAC:\"c4:e9:84:2d:0e:28\" , hostname:\"TL-WPA4220\"},  // powerline extender6\n    {MAC:\"c4:e9:84:2d:0e:9c\" , hostname:\"TL-WPA4220_2\"}, // 2nd // powerline extender6\n    {MAC:\"18:59:33:13:9d:fb\" , hostname:\"cisco_switch\"},\n    {MAC:\"b8:27:eb:4c:14:2d\" , hostname:\"raspberrypi\"},\n    {MAC:\"b8:27:eb:5b:31:bb\" , hostname:\"pi3one\"},\n    {MAC:\"b8:27:eb:49:f1:cd\" , hostname:\"pi3two\"},\n    {MAC:\"b8:27:eb:79:80:3f\" , hostname:\"pi3three\" }, // ethernet\n    {MAC:\"b8:27:eb:2c:d5:6a\" , hostname:\"pi3three\" }, // wifi\n    {MAC:\"00:50:43:01:c1:e6\" , hostname:\"sheevaplug\"},\n    // {MAC:\"18:fe:34:a0:28:3d\" , hostname:\"wifi_relay_cv\"},  // disabled as located on another subnet\n    {MAC:\"00:90:a9:d8:7c:0c\" , hostname:\"WD\"}, // NAS\n    {MAC:\"9c:c7:d1:e8:a9:be\" , hostname:\"TV_sharp\"},\n    {MAC:\"58:bd:a3:7b:65:52\" , hostname:\"Wii\" },  // \n    {MAC:\"80:c1:6e:ed:63:b8\" , hostname:\"chitzen\"},\n    {MAC:\"34:23:87:7a:e5:8b\" , hostname:\"SonyLaptop\"},\n    {MAC:\"8c:70:5a:72:d0:9c\" , hostname:\"OldLaptopJanWerk\"}, // wifi\n    {MAC:\"00:21:CC:C4:95:47\" , hostname:\"OldLaptopJanWerk\"}, // ethernet \n    {MAC:\"50:7B:9D:E8:1A:57\" , hostname:\"LaptopJanWerk\"}, // ethernet 50-7B-9D-E8-1A-57\n    {MAC:\"44:85:00:77:c2:57\" , hostname:\"LaptopJanWerk\"}, // wifi MAC_44_85_00_77_c2_57\n    {MAC:\"00:16:CF:5B:4D:5A\" , hostname:\"oudeLaptopJan\"}, // wifi\n    {MAC:\"00:16:41:ab:18:94\" , hostname:\"oudeLaptopJan\"}, // ethernet\n    {MAC:\"78:92:9C:00:F5:B6\" , hostname:\"LaptopJade\"}, // wifi\n    {MAC:\"00:26:2D:C5:4D:35\" , hostname:\"LaptopJade\"}, // ethernet\n    {MAC:\"00:13:33:9a:bd:82\" , hostname:\"LaptopJade\"}, // wifi2 (akoya has 2 wifi)\n    {MAC:\"38:B1:DB:E6:43:97\" , hostname:\"LaptopJadeAlex\"}, // wifi \n    {MAC:\"b8:ee:65:3a:76:c0\" , hostname:\"LaptopMirkoSterre\"}, // ethernet\n    {MAC:\"ac:2b:6e:c0:01:e8\" , hostname:\"LaptopSterre\"}, // wifi\n    {MAC:\"b4:30:52:83:1f:eb\" , hostname:\"HuaweiSterre\"}, \n    {MAC:\"70:72:3c:ea:77:5d\" , hostname:\"OudeHuaweiJan\"},\n    {MAC:\"5c:b5:24:97:09:a9\" , hostname:\"SonyGsmMarleen\" },\n    {MAC:\"88:e8:7f:d7:db:d1\" , hostname:\"iphoneMarleen\" }, // added 2018-01-18\n    {MAC:\"ac:fd:ec:4e:d1:e4\" , hostname:\"oude_iphoneMarleen\" }, // renamed: old name \"iphoneMarleen\"\n    {MAC:\"84:8e:0c:5a:34:d8\" , hostname:\"iphoneJade\" },\n    {MAC:\"2c:33:61:82:cc:67\" , hostname:\"iphone7Jade\" },\n    {MAC:\"48:e9:f1:16:1f:33\" , hostname:\"ipodMirko\" },\n    {MAC:\"88:11:96:a6:d6:fd\" , hostname:\"gsmMirko\" }, // added 2018-10-17\n    {MAC:\"08:60:6E:AB:A3:31\" , hostname:\"tabletNexus\"},\n    {MAC:\"2c:0e:3d:5d:b4:1c\" , hostname:\"S7Jan\"},\n    {MAC:\"d4:ae:05:8a:3a:a9\" , hostname:\"tabletSamsung\"},\n    {MAC:\"d0:2b:20:f0:1b:8d\" , hostname:\"iphone8Jan\"}\n    ];\n\n    \nvar newMsg = { \n nodegroup: \"7\",\n payload: {}};\n \n// set state for list of hostnames\nfor (var i=0; i<MAC_to_hostname.length;i++) {\n   newMsg.payload[MAC_to_hostname[i].hostname]=0;\n   for (var j=0; j<msg.payload.MAC_IP_list.length; j++) {\n       if (msg.payload.MAC_IP_list[j].hostname == MAC_to_hostname[i].hostname ) {\n           newMsg.payload[MAC_to_hostname[i].hostname]=1; break;\n       }\n   }\n}\n\nnewMsg.payload.pi3one=1; // arp-scan doesn't give results for itself\n\n// context variables needs to use the proper interface\nif (!context.init){\n    context.unknown_macs= [];\n    context.init = 1;\n}\n\n// reset state to 0\nfor (var k=0;k<context.unknown_macs.length;k++){\n    context.unknown_macs[k].prev_state =  context.unknown_macs[k].state;\n    context.unknown_macs[k].state=0;\n}\n\n// set state to 1\nfor (var l=0;l<msg.payload.MAC_IP_list.length; l++) {\n    if (msg.payload.MAC_IP_list[l].hostname.substr(0,4) == \"MAC_\" ){\n        var found = 0;\n        for (var k=0;k<context.unknown_macs.length;k++){\n             if (context.unknown_macs[k].hostname == msg.payload.MAC_IP_list[l].hostname){\n                 context.unknown_macs[k].state = 1;\n                 found = 1; break;\n             }\n        }\n        if (! found){\n            context.unknown_macs.push( { hostname:msg.payload.MAC_IP_list[l].hostname , \n                                         prev_state:0,\n                                         state:1 });\n        }\n    }\n}\n//node.warn(context.unknown_macs);\n\nvar newMsg2 = { payload : {} };\nfor (var k=0;k<context.unknown_macs.length;k++){\n    var l_hostname   = context.unknown_macs[k].hostname;\n    var l_prev_state = context.unknown_macs[k].prev_state;\n    var l_state      = context.unknown_macs[k].state;\n    \n    newMsg.payload[l_hostname]=l_state;\n    \n    if (l_prev_state != l_state){\n        newMsg2.payload[l_hostname]=l_state;\n    }\n}\n\n// set TV_sharp_smorgens which is true if the TV is on and it is still morning.\nvar current_hour = new Date().getHours();\nvar tis_smorgens = (( current_hour >= 5 ) && (current_hour <= 13 ) );\nnewMsg.payload.TV_sharp_smorgens = ( tis_smorgens && newMsg.payload.TV_sharp ? 1 : 0 );\n    \nreturn [ newMsg, newMsg2 ];","outputs":"2","noerr":0,"x":420,"y":240,"wires":[["99f27a5b.40f368","c3881eee.a2eb6"],["71527b7f.ddaaa4","1d24869d.fdf609"]]},{"id":"99f27a5b.40f368","type":"debug","z":"fed72f15.8d836","name":"emoncms input","active":true,"console":"false","complete":"true","x":740,"y":240,"wires":[]},{"id":"f7d53443.67ec88","type":"ping","z":"fed72f15.8d836","name":"ping \"3-channel wifi relay\" in basement","host":"192.168.42.60","timer":"300","x":150,"y":440,"wires":[["714d3c16.9b3364","8fe64985.786fa8"]]},{"id":"2d1b2a38.5e5cb6","type":"debug","z":"fed72f15.8d836","name":"\"wifi_relay_cv\" emon input","active":true,"console":"false","complete":"true","x":757.5,"y":468.3999481201172,"wires":[]},{"id":"714d3c16.9b3364","type":"function","z":"fed72f15.8d836","name":"\"wifi relay cv\" emon input","func":"var wifi_relay_cv_status = ( msg.payload === false ? 0 : 1 );\n\nvar newMsg = { \n nodegroup: \"7\",\n payload: {\"wifi_relay_cv\": wifi_relay_cv_status }};\n \n \nreturn newMsg;","outputs":1,"noerr":0,"x":442.50001525878906,"y":439.5999755859375,"wires":[["2d1b2a38.5e5cb6","c3881eee.a2eb6"]]},{"id":"8fe64985.786fa8","type":"debug","z":"fed72f15.8d836","name":"ping response","active":true,"console":"false","complete":"true","x":204.5,"y":410.39996337890625,"wires":[]},{"id":"cda4519a.14246","type":"comment","z":"fed72f15.8d836","name":"Prerequisites for this flow","info":"1. arp-scan should be installed :\n```sudo apt-get install arp-scan```\n2. all users (not only root) should be allowed to execute \"ping\" command:\n```sudo setcap cap_net_raw=ep /bin/ping```\n3. all users (not only root) should be allowed to execute \"arp-scan\" command:\n```sudo setcap cap_net_raw=ep /usr/bin/arp-scan```\n\nNote that as an alternative for point 3: it is also possible to launch \nthe arp-scan with sudo but this approach is not chosen as this\nresulted each time in several extra log lines in the nodered log file.\n\n# Notes\n**At 2018-01-24**: I have added following arp-scan option \n```\n--ignoredups\n```\nas I have seen that some hosts return duplicate lines.\nSee example below.\n```\n192.168.1.29    b8:ee:65:3a:76:c0       (Unknown)\n192.168.1.46    b4:30:52:83:1f:eb       (Unknown)\n192.168.1.46    b4:30:52:83:1f:eb       (Unknown) (DUP: 2)\n```","x":126.5,"y":30,"wires":[]},{"id":"e5fb73a7.20b6d","type":"debug","z":"89ac662.0a2c798","name":"","active":true,"console":"false","complete":"true","x":343.2000274658203,"y":124.7498779296875,"wires":[]},{"id":"3d996843.891ea8","type":"function","z":"89ac662.0a2c798","name":"extract temp, humidity, windspeed, pressure, clouds","func":"var newMsg = { \n nodegroup: \"6\",\n payload:\n  {temp:      Math.round( (msg.data.main.temp-273.15)       * 100 ) / 100,\n   temp_min:  Math.round( (msg.data.main.temp_min-273.15)   * 100 ) / 100,\n   temp_max:  Math.round( (msg.data.main.temp_max-273.15)   * 100 ) / 100,\n   pressure:  msg.data.main.pressure,\n   humidity:  msg.data.main.humidity,\n   // windspeed in mph\n   wind_speed:Math.round( (msg.data.wind.speed * 1.609344 ) * 100 ) / 100,\n   wind_deg:msg.data.wind.deg,\n   clouds:msg.data.clouds.all\n  }};\n   \n// remember temperature\nglobal.set(\"outside_temp\", newMsg.payload.temp);\nglobal.set(\"outside_humidity\", newMsg.payload.humidity);\n  \n  \nreturn newMsg;","outputs":1,"noerr":0,"x":301.70001220703125,"y":155.4998779296875,"wires":[["979b3a7e.4ef8d8","9568e68d.f98338"]]},{"id":"979b3a7e.4ef8d8","type":"debug","z":"89ac662.0a2c798","name":"","active":false,"console":"false","complete":"true","x":503.7000274658203,"y":121.9998779296875,"wires":[]},{"id":"d626f0ec.cb686","type":"openweathermap","z":"89ac662.0a2c798","name":"my openweather","wtype":"current","lon":"4.45127","lat":"51.166969","city":"","country":"","language":"en","x":158.45001220703125,"y":124.4998779296875,"wires":[["e5fb73a7.20b6d","3d996843.891ea8"]]},{"id":"6b16a64a.b49e08","type":"inject","z":"89ac662.0a2c798","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"x":130.70000457763672,"y":93.24987888336182,"wires":[["d626f0ec.cb686"]]},{"id":"1af0d509.9cb87b","type":"comment","z":"89ac662.0a2c798","name":"retrieve openweather data and publish on emoncms","info":"","x":211.03337860107422,"y":40,"wires":[]},{"id":"a57190bd.cde9b","type":"emoncms","z":"21777d41.84c182","name":"local emoncms","emonServer":"589de0d1.83cae","nodegroup":"","datatype":"legacy","x":360.50010681152344,"y":140.60000610351562,"wires":[]},{"id":"79dec3f7.55210c","type":"link in","z":"21777d41.84c182","name":"to my emoncms","links":["2f35744a.a4b80c","366b49a2.6c53b6","6402749.d0dad8c","91056def.461fc","9471dcd1.342ea","a507d943.700588","b44eb838.507e08","c3881eee.a2eb6","f62cf426.7009d8","f807b019.eafb7","2d2dcce2.c01534","dd97b43c.bb76f8","8a5bebd1.286f98","23ba6cbc.1ed024","3b2a4a8.a94c5b6","a4c75f96.8df92","e6138e9d.01533"],"x":222.50001525878906,"y":140.5999984741211,"wires":[["a57190bd.cde9b","20159c7c.1dbd84"]]},{"id":"20159c7c.1dbd84","type":"debug","z":"21777d41.84c182","name":"to emoncms","active":true,"console":"false","complete":"true","x":350,"y":100,"wires":[]},{"id":"f62cf426.7009d8","type":"link out","z":"89ac662.0a2c798","name":"from openweather","links":["79dec3f7.55210c","f59c1140.680b4","c2ac5027.0b21","69ee7cc0.51a134","9d4d0159.7a062","54c13ed9.2bced"],"x":575,"y":260,"wires":[]},{"id":"c3881eee.a2eb6","type":"link out","z":"fed72f15.8d836","name":"from arp-scan","links":["79dec3f7.55210c","9a39cfe6.00f66"],"x":656.5,"y":424.99998474121094,"wires":[]},{"id":"bf617b45.b168e8","type":"mqtt in","z":"669ca4d9.6412bc","name":"emonTh - node 23","topic":"emonhub/rx/23/values","qos":"0","broker":"9c9ae2bc.63652","x":150.50006103515625,"y":130.2000274658203,"wires":[["996d2d6d.8778f","1814ee63.df6602","adda148e.6ee598"]]},{"id":"d0625115.b7188","type":"mqtt in","z":"669ca4d9.6412bc","name":"emonTx - node 10","topic":"emonhub/rx/10/values","qos":"0","broker":"9c9ae2bc.63652","x":148.50001525878906,"y":36.19999694824219,"wires":[["58551b6e.5c8374","b55692da.a56d6"]]},{"id":"996d2d6d.8778f","type":"function","z":"669ca4d9.6412bc","name":"extract and store temp, humidity","func":"//  the temperature is the first element in the payload\n//  the humidity is the third element in the payload\nvar temp     = parseFloat(msg.payload.split(\",\")[0]);\nvar humidity = parseFloat(msg.payload.split(\",\")[2]);\n\nglobal.set(\"emonTh_node23_temp\",temp);\nmsg.payload= { \"temp\": temp,\n               \"humidity\" : humidity };\n    \nreturn msg;","outputs":1,"noerr":0,"x":398.9501190185547,"y":162.2000494003296,"wires":[["a2e882db.b4f9e","b9f7e129.07c3e"]]},{"id":"a2e882db.b4f9e","type":"debug","z":"669ca4d9.6412bc","name":"","active":false,"console":"false","complete":"payload","x":610.7500610351562,"y":121.60004425048828,"wires":[]},{"id":"58551b6e.5c8374","type":"debug","z":"669ca4d9.6412bc","name":"emonTx - node 10","active":false,"console":"false","complete":"true","x":361.5000762939453,"y":34.600006103515625,"wires":[]},{"id":"ba3a7f9f.7d489","type":"mqtt in","z":"669ca4d9.6412bc","name":"emonTh - node 24","topic":"emonhub/rx/24/values","qos":"0","broker":"9c9ae2bc.63652","x":130,"y":420,"wires":[["c0ab7f94.27cd","b106bd5c.778e1","863b71a9.c250c"]]},{"id":"c0ab7f94.27cd","type":"debug","z":"669ca4d9.6412bc","name":"emonTh - node 24","active":true,"console":"false","complete":"true","x":334.00001525878906,"y":419.3999938964844,"wires":[]},{"id":"1814ee63.df6602","type":"debug","z":"669ca4d9.6412bc","name":"emonTh - node 23","active":true,"console":"false","complete":"true","x":357.7500762939453,"y":124.35003471374512,"wires":[]},{"id":"dad36045.68a4e","type":"debug","z":"83200356.0ef81","name":"http relay status response","active":true,"console":"false","complete":"true","x":672.3944625854492,"y":569.6944838762283,"wires":[]},{"id":"6f24cfa8.486bb","type":"http request","z":"83200356.0ef81","name":"http get relay status","method":"GET","ret":"obj","url":"192.168.42.60/control/relay.cgi?state","tls":"","x":427.6167411804199,"y":569.2500449419022,"wires":[["dad36045.68a4e","9529fd39.ae938"]]},{"id":"6bada890.a644b8","type":"inject","z":"83200356.0ef81","name":"every minute","topic":"poll","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"x":227.61672592163086,"y":569.5000334978104,"wires":[["6f24cfa8.486bb"]]},{"id":"9529fd39.ae938","type":"function","z":"83200356.0ef81","name":"extract cv pump and ventilator state","func":"\n// validate status code\nif (msg.statusCode != \"200\" ) {\n    node.error(\"Unexpected http get status code (=\" + msg.statusCode + \")\");\n    node.error(msg);\n    return;\n}\n\nglobal.set(\"cv_pump.status\",   msg.payload.relay2);\nglobal.set(\"ventilator.status\",msg.payload.relay3);\n\nvar newMsg = { \n    nodegroup:\"5\",\n    payload:{ cvpump    : msg.payload.relay2 ,\n              ventilator: msg.payload.relay3  }\n};\n\nreturn newMsg ;","outputs":"1","noerr":0,"x":528.4778709411621,"y":481.9722194671631,"wires":[["a6f8c49.2785538","9471dcd1.342ea"]]},{"id":"a6f8c49.2785538","type":"debug","z":"83200356.0ef81","name":"cv pump and ventilator state","active":true,"console":"false","complete":"true","x":593.1168022155762,"y":451.9167423248291,"wires":[]},{"id":"a9ddd1e6.d9fca","type":"inject","z":"83200356.0ef81","name":"activate cv pump relay","topic":"cv_pump","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"x":277.3333740234375,"y":90.33339500427246,"wires":[["786e6ec3.f83d8"]]},{"id":"f9ac8956.8f7de8","type":"inject","z":"83200356.0ef81","name":"deactivate cv pump relay","topic":"cv_pump","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"x":290.688232421875,"y":60.33334922790527,"wires":[["786e6ec3.f83d8"]]},{"id":"3a29e576.1cdcaa","type":"comment","z":"83200356.0ef81","name":"retrieve CV relay status ","info":"","x":228.70008850097656,"y":524.3333768844604,"wires":[]},{"id":"cba16115.cfb06","type":"http request","z":"83200356.0ef81","name":"http (de)activate relay","method":"GET","ret":"txt","url":"","tls":"","x":345.5890655517578,"y":369.9722442626953,"wires":[["306ff4e5.1b328c","ab19bdb8.9788b"]]},{"id":"306ff4e5.1b328c","type":"debug","z":"83200356.0ef81","name":"http (de)activate relay response","active":true,"console":"false","complete":"true","x":646.6446533203125,"y":370.9722442626953,"wires":[]},{"id":"ab19bdb8.9788b","type":"function","z":"83200356.0ef81","name":"map to \"get relay status\" output format","func":"// validate status code\nif (msg.statusCode != \"200\" ) {\n    node.error(\"Unexpected http get status code (=\" + msg.statusCode + \")\");\n    node.error(msg);\n    return;\n}\n\nvar newMsg = { statusCode : msg.statusCode ,\n               payload    : { relay2 : -1 , relay3 : -1} };\n\nif ( msg.payload.search(\"CV is now on\") != -1){\n    newMsg.payload.relay2=1;\n} else if ( msg.payload.search(\"CV is now off\") != -1) {\n    newMsg.payload.relay2=0\n} else {\n    node.error(\"unexpected payload:\" + msg.payload);\n    return;\n}\n\nif ( msg.payload.search(\"ventilator is now on\") != -1){\n    newMsg.payload.relay3=1;\n} else if ( msg.payload.search(\"ventilator is now off\") != -1) {\n    newMsg.payload.relay3=0\n} else {\n    node.error(\"unexpected payload:\" + msg.payload);\n    return;\n}\n\nreturn newMsg;","outputs":1,"noerr":0,"x":395.0613708496094,"y":397.6389465332031,"wires":[["9529fd39.ae938","49ec729d.1a2f0c"]]},{"id":"49ec729d.1a2f0c","type":"debug","z":"83200356.0ef81","name":"","active":true,"console":"false","complete":"true","x":637.5889625549316,"y":398.4722547531128,"wires":[]},{"id":"51af189e.1aaff8","type":"inject","z":"83200356.0ef81","name":"activate ventilator relay","topic":"ventilator","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"x":279.00010681152344,"y":121.30574607849121,"wires":[["786e6ec3.f83d8"]]},{"id":"3f0afcb0.f3a164","type":"inject","z":"83200356.0ef81","name":"deactivate ventilator relay","topic":"ventilator","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"x":288.7778854370117,"y":153.0835781097412,"wires":[["786e6ec3.f83d8"]]},{"id":"f900e935.c4c9e8","type":"link in","z":"83200356.0ef81","name":"activate/deactivate my 3CH WiFi Relay Control Board","links":["786e6ec3.f83d8","4db76f10.1c53a","24ebd29f.82789e"],"x":196.72230529785156,"y":245.5999984741211,"wires":[["efdfda60.bdc1c8","3deb433c.06e84c"]]},{"id":"9471dcd1.342ea","type":"link out","z":"83200356.0ef81","name":"cv pump and relay status","links":["79dec3f7.55210c","b43fa5c8.0e6dc8","93d3126d.7b301","7ff920c5.3d75a","c0184b88.84ef08"],"x":738.1667985916138,"y":483.5333585739136,"wires":[]},{"id":"efdfda60.bdc1c8","type":"function","z":"83200356.0ef81","name":"validate input","func":"// validate input\nif ( (msg.payload !== 0) && (msg.payload !=1)) {\n    node.error(\"msg.payload=\\'\"+msg.payload+\"\\' is not supported.\");\n    return;\n}\nif ((msg.topic != 'cv_pump') && (msg.topic != 'ventilator')){\n    node.error(\"msg.topic=\\'\"+msg.topic+\"\\' is not supported.\");\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":316.1667785644531,"y":278.6000061035156,"wires":[["9c6eb452.ef1d58"]]},{"id":"8c84ad42.b914a","type":"comment","z":"83200356.0ef81","name":"\"3CH WiFi Relay Control Board\" Interface","info":"My \"3CH Wifi Relay Control Board\" (with IP address 192.168.42.60) is installed in\nthe basement:\n- relay 2 : activates/deactivates the CV pump (CV = central heating)\n- relay 3 : activates/deactivates the ventilator in the basement\n\nMore information about the hardware can be found at:\n* https://openenergymonitor.org/emon/node/11158","x":311.1666717529297,"y":209.99998474121094,"wires":[]},{"id":"786e6ec3.f83d8","type":"link out","z":"83200356.0ef81","name":"test","links":["f900e935.c4c9e8"],"x":484.83335876464844,"y":90.93337059020996,"wires":[]},{"id":"9c6eb452.ef1d58","type":"function","z":"83200356.0ef81","name":"current status != requested status ?","func":"// only send message if the new desired cv pump/ventilator status is different from the actual.\n//node.warning(\"global.get=\"+global.get(msg.topic + \".status\"));\nif (msg.payload !== global.get(msg.topic + \".status\")){\n    return msg;\n} else {\n    return;\n}\nreturn msg;","outputs":1,"noerr":0,"x":384.16673278808594,"y":308.99998474121094,"wires":[["d60b68a2.dcafa8"]]},{"id":"3deb433c.06e84c","type":"debug","z":"83200356.0ef81","name":"3CH WiFi Relay Status Change Request","active":true,"console":"false","complete":"true","x":407.16668701171875,"y":247.19998168945312,"wires":[]},{"id":"d60b68a2.dcafa8","type":"function","z":"83200356.0ef81","name":"create URL","func":"var relay_nr;\nif (msg.topic == \"cv_pump\") { relay_nr = 2; }\nelse if (msg.topic == \"ventilator\") { relay_nr = 3; }\nelse { // this case normally can never happen\n  return;\n}\n\nmsg.url = \"192.168.42.60/control/relay.cgi?relay\"+relay_nr+\"=\"+msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":315.1666717529297,"y":339.3999786376953,"wires":[["cba16115.cfb06","f67707c6.e74b48"]]},{"id":"f67707c6.e74b48","type":"debug","z":"83200356.0ef81","name":"with url","active":true,"console":"false","complete":"true","x":513.1666564941406,"y":341.1999816894531,"wires":[]},{"id":"125c7bf2.752274","type":"comment","z":"83200356.0ef81","name":"test inject nodes","info":"","x":228.83334350585938,"y":28.933324813842773,"wires":[]},{"id":"1d0f7e65.f0e302","type":"ui_switch","z":"7fa2194.bf802e8","name":"","label":"verwarming boven","group":"26bbff78.ed3c6","order":1,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"ui/cv_req/heating_upstairs","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":454.125,"y":173,"wires":[["fcba1a5b.966cc8"]]},{"id":"18718203.84a46e","type":"ui_switch","z":"7fa2194.bf802e8","name":"","label":"verwarming kamer Jade","group":"26bbff78.ed3c6","order":2,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"ui/cv_req/heating_room_jade","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":470,"y":280,"wires":[["6f73143.4b7b9ec"]]},{"id":"5f4f7ac8.b0dc04","type":"ui_numeric","z":"7fa2194.bf802e8","name":"","label":"gewenste temp kamer Jade","group":"26bbff78.ed3c6","order":3,"width":0,"height":0,"passthru":true,"topic":"ui/cv_req/temp_room_jade","format":"{{value}}&deg;","min":"16","max":"21","step":"","x":480,"y":315.25000762939453,"wires":[["ca1f827f.2a1af"]]},{"id":"fa002530.e8f808","type":"ui_text","z":"7fa2194.bf802e8","group":"26bbff78.ed3c6","order":4,"width":0,"height":0,"name":"","label":"cv calendar","format":"{{msg.payload}}","layout":"row-spread","x":430.25007247924805,"y":388.2500333786011,"wires":[]},{"id":"bdc91630.b05fb8","type":"comment","z":"7fa2194.bf802e8","name":"invoer","info":"","x":430.62502670288086,"y":42.250000953674316,"wires":[]},{"id":"162e3d4e.7c1673","type":"comment","z":"7fa2194.bf802e8","name":"status","info":"","x":417.00002670288086,"y":476.7500333786011,"wires":[]},{"id":"50db59d2.2fb368","type":"ui_text","z":"7fa2194.bf802e8","group":"37779cb4.2ff4e4","order":1,"width":0,"height":0,"name":"","label":"CV pomp","format":"{{msg.payload.cvpump?\"aan\":\"uit\"}}","layout":"row-spread","x":427.0000228881836,"y":512.0000638961792,"wires":[]},{"id":"a69c5964.57ec08","type":"ui_text","z":"7fa2194.bf802e8","group":"37779cb4.2ff4e4","order":2,"width":0,"height":0,"name":"","label":"°T kamer Jade","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":444.5000190734863,"y":584.5000658035278,"wires":[]},{"id":"4788b46d.80ceac","type":"ui_text","z":"7fa2194.bf802e8","group":"37779cb4.2ff4e4","order":4,"width":0,"height":0,"name":"","label":"°T buiten","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":421.25006103515625,"y":749.2501220703125,"wires":[]},{"id":"b43fa5c8.0e6dc8","type":"link in","z":"7fa2194.bf802e8","name":"CV pomp","links":["9471dcd1.342ea"],"x":317.7500228881836,"y":512.5000877380371,"wires":[["50db59d2.2fb368","ca0008c1.178f58"]]},{"id":"1cb9954b.86036b","type":"link in","z":"7fa2194.bf802e8","name":"°T kamer Jade","links":["b2f7a7e1.9ac498"],"x":316.75008392333984,"y":584.750057220459,"wires":[["a69c5964.57ec08","c88e20e.fafeae"]]},{"id":"f59c1140.680b4","type":"link in","z":"7fa2194.bf802e8","name":"°T buiten","links":["f62cf426.7009d8"],"x":319.0000648498535,"y":749.2500829696655,"wires":[["4788b46d.80ceac"]]},{"id":"b2f7a7e1.9ac498","type":"link out","z":"669ca4d9.6412bc","name":"emonTh - node 23","links":["1cb9954b.86036b","401d76ce.e60f08","8174233d.89ae1"],"x":777.875,"y":198,"wires":[]},{"id":"aaa1238c.e7471","type":"comment","z":"7fa2194.bf802e8","name":"CV Controller","info":"","x":971.875,"y":63.4999942779541,"wires":[]},{"id":"4db76f10.1c53a","type":"link out","z":"7fa2194.bf802e8","name":"activate/deactive CV pump","links":["f900e935.c4c9e8"],"x":1012.4999990463257,"y":426.0000581741333,"wires":[]},{"id":"a82bc56e.34e948","type":"inject","z":"7fa2194.bf802e8","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"x":811.7500419616699,"y":515.2499866485596,"wires":[["d74f003e.81488","da4c3e8a.bfd9e"]]},{"id":"fcba1a5b.966cc8","type":"function","z":"7fa2194.bf802e8","name":"update ui_cv_req_heating_upstairs","func":"global.set(\"ui_cv_req_heating_upstairs\",msg.payload);\nglobal.set(\"ui_cv_req_heating_upstairs_last_change_time\",Date.now());\nreturn msg;","outputs":1,"noerr":0,"x":783.375,"y":171.5,"wires":[["316ddc14.a9b9c4","da4c3e8a.bfd9e"]]},{"id":"6f73143.4b7b9ec","type":"function","z":"7fa2194.bf802e8","name":"update ui_cv_req_heating_room_jade","func":"global.set(\"ui_cv_req_heating_room_jade\",msg.payload);\nglobal.set(\"ui_cv_req_heating_room_jade_last_change_time\",Date.now());\nreturn msg;","outputs":1,"noerr":0,"x":786.2499961853027,"y":278.5000228881836,"wires":[["a1d9c146.8a14b","da4c3e8a.bfd9e"]]},{"id":"ca1f827f.2a1af","type":"function","z":"7fa2194.bf802e8","name":"update  ui_cv_req_temp_room_jade","func":"global.set(\"ui_cv_req_temp_room_jade\",msg.payload);\nglobal.set(\"ui_cv_req_heating_room_jade_last_change_time\",Date.now());\nreturn msg;","outputs":1,"noerr":0,"x":777.4999961853027,"y":316.00000858306885,"wires":[["1d25c72f.3a2519","da4c3e8a.bfd9e"]]},{"id":"316ddc14.a9b9c4","type":"debug","z":"7fa2194.bf802e8","name":"","active":true,"console":"false","complete":"true","x":1018.3750038146973,"y":172,"wires":[]},{"id":"a1d9c146.8a14b","type":"debug","z":"7fa2194.bf802e8","name":"","active":true,"console":"false","complete":"true","x":1018.7500038146973,"y":278.00000762939453,"wires":[]},{"id":"1d25c72f.3a2519","type":"debug","z":"7fa2194.bf802e8","name":"","active":true,"console":"false","complete":"true","x":1013.7500038146973,"y":313.00000762939453,"wires":[]},{"id":"ca0008c1.178f58","type":"function","z":"7fa2194.bf802e8","name":"update cvpump_state","func":"global.set(\"cvpump_state\",msg.payload.cvpump);\nreturn msg;","outputs":1,"noerr":0,"x":464.5000877380371,"y":548.250096321106,"wires":[["da4c3e8a.bfd9e"]]},{"id":"c88e20e.fafeae","type":"function","z":"7fa2194.bf802e8","name":"update temp_room_jade","func":"global.set(\"temp_room_jade\",msg.payload.temp);\nreturn msg;","outputs":1,"noerr":0,"x":473.25002670288086,"y":622.0000972747803,"wires":[["da4c3e8a.bfd9e"]]},{"id":"b03e87a.1e6cc78","type":"function","z":"7fa2194.bf802e8","name":"update cv_calendar_temp","func":"var cv_calendar_temp =( msg.payload.active ? msg.payload.temp : 0 ) ;\n\nglobal.set(\"cv_calendar_temp\", cv_calendar_temp);\nmsg.payload = cv_calendar_temp;\nreturn msg;","outputs":1,"noerr":0,"x":468.24999618530273,"y":423.50004863739014,"wires":[["da4c3e8a.bfd9e"]]},{"id":"da4c3e8a.bfd9e","type":"function","z":"7fa2194.bf802e8","name":"CV pump status changed ?","func":"// initialise variables\nvar cvpump_state                = global.get(\"cvpump_state\");\nvar ui_cv_req_heating_upstairs  = global.get(\"ui_cv_req_heating_upstairs\");\nvar ui_cv_req_heating_room_jade = global.get(\"ui_cv_req_heating_room_jade\");\nvar ui_cv_req_temp_room_jade    = global.get(\"ui_cv_req_temp_room_jade\");\nvar cv_calendar_temp            = global.get(\"cv_calendar_temp\");\nvar temp_room_jade              = global.get(\"temp_room_jade\");\n\n// determine new status cv pump\nvar new_cvpump_state =Number ( ui_cv_req_heating_upstairs ||\n                               (ui_cv_req_heating_room_jade && (ui_cv_req_temp_room_jade > temp_room_jade)) ||\n                               (cv_calendar_temp > temp_room_jade));\n\n// only send message if the new desired cv pump status is different from the actual.\nif (new_cvpump_state != cvpump_state){\n    var newMsg = { topic: \"cv_pump\" ,\n                   payload: new_cvpump_state};\n    return newMsg;\n} else { return ;}\n\n","outputs":1,"noerr":0,"x":1079.9999961853027,"y":393.25007152557373,"wires":[["4db76f10.1c53a","fb286e8d.4e47e"]]},{"id":"fb286e8d.4e47e","type":"debug","z":"7fa2194.bf802e8","name":"new cv pump state","active":true,"console":"false","complete":"true","x":1142.5,"y":363.00002574920654,"wires":[]},{"id":"d74f003e.81488","type":"function","z":"7fa2194.bf802e8","name":"publish ui heating request","func":"var ui_temp_room_jade  = ( global.get(\"ui_cv_req_heating_room_jade\") ? global.get(\"ui_cv_req_temp_room_jade\"): 0 );\nvar cv_calendar_temp   = global.get(\"cv_calendar_temp\");\n\nvar newMsg = { \n    nodegroup:\"5\",\n    payload:{ ui_cv_boven     : global.get(\"ui_cv_req_heating_upstairs\") * 24,\n              ui_cv_kamer_jade: ui_temp_room_jade,\n              cv_calendar_temp: cv_calendar_temp }\n    };\n\nreturn newMsg;","outputs":1,"noerr":0,"x":876.9999809265137,"y":546.250018119812,"wires":[["2f35744a.a4b80c"]]},{"id":"2f35744a.a4b80c","type":"link out","z":"7fa2194.bf802e8","name":"publish ui heating request","links":["79dec3f7.55210c"],"x":865.4999809265137,"y":575.4999876022339,"wires":[]},{"id":"4012c9b6.ff1668","type":"function","z":"70877b4a.1bbb44","name":"process cv calendar event","func":"var start_time = new Date(msg.payload.start);\nvar end_time   = new Date(msg.payload.end);\nvar cv_temp    = Number(msg.payload.title);\nvar now = new Date();\n\nnode.log( msg.payload.start + \"=>\" + msg.payload.end + \":\" + msg.payload.title);\n// check if temperature within range and end time not yet passed\nif ( ! ( ( (cv_temp > 0) && (cv_temp <= 25 ) ) &&\n         ( now < end_time) ) )  {\n    node.error(\"title:\" + msg.payload.title + \"; start_time:\" + start_time + \"; end_time:\"+ end_time + \";now:\" + now);\n    return;\n}\n\nglobal.set(\"cv_calendar_state\", \n            { \"active\" : 1, \n              \"temp\" : cv_temp , \n              \"start_time\" : start_time, \n              \"end_time\" : end_time });\n\nmsg.payload = global.get(\"cv_calendar_state\");\nreturn msg;","outputs":1,"noerr":0,"x":329.5000305175781,"y":178.60000610351562,"wires":[["f8cd2d76.70c06","e1ec61c1.0e622"]]},{"id":"87f9e91b.644a08","type":"function","z":"70877b4a.1bbb44","name":"now > end_time ?","func":"var cv_calendar = global.get(\"cv_calendar_state\");\n\nif (cv_calendar.active){\n    var now = new Date();\n    if (now > cv_calendar.end_time) {\n          global.set(\"cv_calendar_state.active\",0);\n    }\n}\n\nmsg.payload =  global.get(\"cv_calendar_state\");\n\nreturn msg;","outputs":1,"noerr":0,"x":322.50001525878906,"y":247.59999084472656,"wires":[["f8cd2d76.70c06","c2b49176.66677"]]},{"id":"f8cd2d76.70c06","type":"link out","z":"70877b4a.1bbb44","name":"cv calendar event","links":["7266a5fc.6a41ec"],"x":582.5000152587891,"y":174.8000030517578,"wires":[]},{"id":"dcd01b30.38d958","type":"debug","z":"70877b4a.1bbb44","name":"calendar event","active":true,"console":"false","complete":"payload","x":282.50001525878906,"y":117.19999694824219,"wires":[]},{"id":"e13df204.713b3","type":"inject","z":"70877b4a.1bbb44","name":"every minute","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"x":112.5,"y":248.8000030517578,"wires":[["87f9e91b.644a08"]]},{"id":"e1ec61c1.0e622","type":"debug","z":"70877b4a.1bbb44","name":"processed calendar event","active":true,"console":"false","complete":"true","x":538.5000152587891,"y":116.60000610351562,"wires":[]},{"id":"c2b49176.66677","type":"debug","z":"70877b4a.1bbb44","name":"","active":true,"console":"false","complete":"true","x":531.4999694824219,"y":248.5999755859375,"wires":[]},{"id":"bca9034e.6b5d1","type":"inject","z":"70877b4a.1bbb44","name":"once a start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":109.5,"y":53.79999542236328,"wires":[["2c4a5c62.e06674"]]},{"id":"2c4a5c62.e06674","type":"function","z":"70877b4a.1bbb44","name":"set cv_calendar_state.active = 0","func":"global.set(\"cv_calendar_state\", { \"active\": 0});\nreturn msg;","outputs":1,"noerr":0,"x":377.50001525878906,"y":53.599998474121094,"wires":[[]]},{"id":"7266a5fc.6a41ec","type":"link in","z":"7fa2194.bf802e8","name":"ui cv calendar","links":["f8cd2d76.70c06"],"x":259.12498474121094,"y":388.3499755859375,"wires":[["b03e87a.1e6cc78","6a1cdfd0.8ab9a"]]},{"id":"6a1cdfd0.8ab9a","type":"function","z":"7fa2194.bf802e8","name":"return cv calendar status","func":"var cv_calendar = msg.payload;\nvar newMsg = { payload: (cv_calendar.active ? ( cv_calendar.temp.toString()+ \"° tot \"+ \n                                             cv_calendar.end_time.toLocaleTimeString()) \n                                         : \"uit\" ) };\n\nreturn newMsg;","outputs":1,"noerr":0,"x":471.125057220459,"y":357.14998149871826,"wires":[["fa002530.e8f808"]]},{"id":"11d49b1c.8f0075","type":"comment","z":"83200356.0ef81","name":"retrieve dht22 info","info":"","x":216.5,"y":610.3999977111816,"wires":[]},{"id":"af21367f.86aae8","type":"inject","z":"83200356.0ef81","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"x":234.5,"y":651.1999855041504,"wires":[["a9af4baa.8a9aa8"]]},{"id":"a9af4baa.8a9aa8","type":"http request","z":"83200356.0ef81","name":"http get dht22 temp/humidity","method":"GET","ret":"txt","url":"http://192.168.42.60/control/dht22.tpl","tls":"","x":474.5000305175781,"y":651.1999855041504,"wires":[["1fab77d6.77ed58","c8245edd.c5014"]]},{"id":"1fab77d6.77ed58","type":"debug","z":"83200356.0ef81","name":"get dht22 response","active":true,"console":"false","complete":"true","x":721.5000152587891,"y":651.3999977111816,"wires":[]},{"id":"f7ede501.ce50d8","type":"html","z":"83200356.0ef81","name":"extract paragraph[]","tag":"p","ret":"text","as":"single","x":479.5000762939453,"y":721.7999000549316,"wires":[["18bbb682.ff82c9","ed7270f4.43c14"]]},{"id":"18bbb682.ff82c9","type":"debug","z":"83200356.0ef81","name":"paragraphs[]","active":true,"console":"false","complete":"true","x":686.5000152587891,"y":719.799991607666,"wires":[]},{"id":"c8245edd.c5014","type":"switch","z":"83200356.0ef81","name":"check status","property":"statusCode","propertyType":"msg","rules":[{"t":"neq","v":"200","vt":"num"},{"t":"eq","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":426.5000457763672,"y":680.4000282287598,"wires":[["39367511.c972ba"],["f7ede501.ce50d8"]]},{"id":"39367511.c972ba","type":"debug","z":"83200356.0ef81","name":"status not 200","active":true,"console":"true","complete":"true","x":616.4999847412109,"y":682.2000160217285,"wires":[]},{"id":"ed7270f4.43c14","type":"function","z":"83200356.0ef81","name":"extract temp and humidity","func":"// validate payload contents\nif (msg.payload[0].substring(1,67)!= \n    \"If there's a DHT22 connected to GPIO2, its temperature reading is \") {\n        node.error(\"Message doesn't have expected content:; msg.payload =\" + msg.payload);\n        return;\n    }\n\nvar parts = msg.payload[0].split(\" is \");\nvar temp_num_digits= parts[1].indexOf(\"C\")-1;\nvar temp = Number(parts[1].substring(0,temp_num_digits));\nvar humidity_num_digits=parts[2].indexOf(\"%\");\nvar humidity = Number(parts[2].substring(0,humidity_num_digits));\n\n// check if temp or humidity is number\nif (isNaN(temp) || isNaN(humidity)){\n    node.error(\"Extracted temp or humidity is not a number. msg.payload =\" + msg.payload);\n    return;\n}\n\n// zero humidity or temperature most likely indicate that the message is not correctly\n// interpreted\nif ((Math.round(temp*100)===0)||(humidity<10)){\n    node.error(\"Extracted humidity or temperature is zero which is most likely not correct. msg.payload =\" + msg.payload);\n    return;\n}\n\nvar newMsg = { \n    nodegroup:\"5\",\n    payload:{ \"temp\"    : temp ,\n              \"humidity\": humidity  }\n};\n\nreturn newMsg;","outputs":1,"noerr":0,"x":498.50001525878906,"y":750.9999732971191,"wires":[["f4dea179.02562","53d940e2.a38d8"]]},{"id":"f4dea179.02562","type":"debug","z":"83200356.0ef81","name":"","active":true,"console":"false","complete":"true","x":728.4999847412109,"y":753.8000068664551,"wires":[]},{"id":"366b49a2.6c53b6","type":"link out","z":"83200356.0ef81","name":"temp and humidity","links":["79dec3f7.55210c","b60e349b.1fd7f8","5a024f2e.26718","50d21c2f.434e94"],"x":855,"y":780,"wires":[]},{"id":"ebb898f4.144768","type":"mqtt in","z":"9519878f.6ae678","name":"kodi/#","topic":"kodi/#","qos":"2","broker":"9c9ae2bc.63652","x":94,"y":116,"wires":[["c214488c.3debb8"]]},{"id":"c214488c.3debb8","type":"debug","z":"9519878f.6ae678","name":"kodi","active":true,"console":"false","complete":"true","x":267,"y":117,"wires":[]},{"id":"d8afbd44.0ad46","type":"ui_text","z":"cbb123e.ff1e2e","group":"3d9accab.6c2634","order":0,"width":0,"height":0,"name":"","label":"CV","format":"{{msg.payload.cvpump?\"<i class=\\\"fa fa-toggle-on\\\"></i>\":\"<i class=\\\"fa fa-toggle-off\\\"></i>\"}}","layout":"row-spread","x":348.50006103515625,"y":21.800003051757812,"wires":[]},{"id":"93d3126d.7b301","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["9471dcd1.342ea"],"x":247.5,"y":22.600006103515625,"wires":[["d8afbd44.0ad46","75d5666f.91af08"]]},{"id":"75d5666f.91af08","type":"ui_text","z":"cbb123e.ff1e2e","group":"3d9accab.6c2634","order":0,"width":0,"height":0,"name":"ventilator","label":"ventilator","format":"{{msg.payload.ventilator?\"<i class=\\\"fa fa-camera-retro\\\"></i>\":\"<i class=\\\"fa fa-toggle-off\\\"></i>\"}}","layout":"row-spread","x":357.5,"y":53,"wires":[]},{"id":"c9722513.d39718","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":4,"width":0,"height":0,"name":"Kelder Temp","label":"Kelder","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":413.50001525878906,"y":434.2000274658203,"wires":[]},{"id":"b60e349b.1fd7f8","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["366b49a2.6c53b6"],"x":294.5000305175781,"y":447.6000213623047,"wires":[["c9722513.d39718","e2912c6f.61c0c","33456e40.7648c2"]]},{"id":"8174233d.89ae1","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["b2f7a7e1.9ac498"],"x":296.50006103515625,"y":356.59999084472656,"wires":[["85f2b50a.0573f8","86ea1851.33bb38","1084ea44.696eb6","26716c30.748174"]]},{"id":"85f2b50a.0573f8","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":2,"width":0,"height":0,"name":"Room Jade Temp","label":"kamer Jade","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":432.50001525878906,"y":337.8000030517578,"wires":[]},{"id":"261c64c9.94dfec","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":3,"width":0,"height":0,"name":"Badkamer Temp","label":"Badkamer","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":431.50001525878906,"y":389.8000030517578,"wires":[]},{"id":"86f7971c.e72298","type":"link out","z":"669ca4d9.6412bc","name":"emonTh - node 24","links":["79911573.9fa15c","c2a92fc7.60fc7","e28824d5.aa6b58"],"x":690.9999389648438,"y":481.9999694824219,"wires":[]},{"id":"b106bd5c.778e1","type":"function","z":"669ca4d9.6412bc","name":"extract and store temp, humidity","func":"//  the temperature is the first element in the payload.\n//  the humidity is the third element in the payload\nvar temp     = parseFloat(msg.payload.split(\",\")[0]);\nvar humidity = parseFloat(msg.payload.split(\",\")[2]);\n\n// global.set(\"emonTh_node24_temp\",temp);\nmsg.payload= { \"temp\": temp,\n               \"humidity\" : humidity };\n    \nreturn msg;","outputs":1,"noerr":0,"x":373.9999542236328,"y":452.79998779296875,"wires":[["209efedc.4d25d2"]]},{"id":"c2a92fc7.60fc7","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["86f7971c.e72298"],"x":294.5000457763672,"y":410.59999084472656,"wires":[["261c64c9.94dfec","9e426ed8.d0c12","e5777a6.ed94288"]]},{"id":"c2ac5027.0b21","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["f62cf426.7009d8"],"x":295,"y":640,"wires":[["89666789.96f928","350859a2.242c36","8851fa45.3b48b8","9e6d486e.b1be28"]]},{"id":"89666789.96f928","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":5,"width":0,"height":0,"name":"Outside Temp","label":"Buiten","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":422.99993896484375,"y":628.800048828125,"wires":[]},{"id":"86ea1851.33bb38","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":2,"width":0,"height":0,"name":"Room Jade Humidity","label":"kamer Jade","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":640.5,"y":358.3999938964844,"wires":[]},{"id":"9e426ed8.d0c12","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":3,"width":0,"height":0,"name":" Badkamer humidity","label":"Badkamer","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":630.5,"y":410.4000244140625,"wires":[]},{"id":"e2912c6f.61c0c","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":4,"width":0,"height":0,"name":"Kelder vochtigheid","label":"Kelder","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":633.5,"y":447.4000244140625,"wires":[]},{"id":"350859a2.242c36","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":5,"width":0,"height":0,"name":"Outside humidity","label":"Buiten","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":634.9999542236328,"y":642.8000335693359,"wires":[]},{"id":"b55692da.a56d6","type":"function","z":"669ca4d9.6412bc","name":"extract power and voltage","func":"var parts        = msg.payload.split(\",\");\nvar CT1_power    = parseFloat(parts[0]);\nvar CT2_power    = parseFloat(parts[1]);\nvar CT3_power    = parseFloat(parts[2]);\nvar solar_power  = parseFloat(parts[3]);\nvar voltage      = parseFloat(parts[4]);\nvar phase1_power = CT1_power + solar_power;\nvar phase2_power = - CT2_power;\nvar phase3_power = CT3_power;\nvar total_power  = phase1_power + phase2_power + phase3_power;\nmsg.payload = { \"total_power\"  : total_power,\n                \"solar_power\"  : solar_power,\n                \"voltage\"      : voltage,\n                \"phase1_power\" : phase1_power,\n                \"phase2_power\" : phase2_power,\n                \"phase3_power\" : phase3_power,\n                \"CT1_power\"    : CT1_power,\n                \"CT2_power\"    : CT2_power,\n                \"CT3_power\"    : CT3_power,\n};\nreturn msg;","outputs":1,"noerr":0,"x":383.50001525878906,"y":70.19999694824219,"wires":[["1dcee65f.56a63a","db7e8095.76ac8","a8b1a467.7e2b48"]]},{"id":"1dcee65f.56a63a","type":"link out","z":"669ca4d9.6412bc","name":"emonTx - node 10","links":["76c7142f.527ffc","4d0e7f05.4ed1c","a1ea7ebe.d0531"],"x":691.5,"y":70.39999389648438,"wires":[]},{"id":"76c7142f.527ffc","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["1dcee65f.56a63a"],"x":282.9999694824219,"y":726,"wires":[["241e94c4.0245fc","3369433a.dc511c","bd45f708.445008","70ac6c34.894594","40e7c122.2c862","d6762886.adfc68","4d6bd369.59ea0c","1fda31d.c452ace","48d5612f.e276d"]]},{"id":"241e94c4.0245fc","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":6,"width":0,"height":0,"name":"CT1 power","label":"CT1 power","format":"{{msg.payload.CT1_power}} W","layout":"row-spread","x":428.99998474121094,"y":857.2000732421875,"wires":[]},{"id":"3369433a.dc511c","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":7,"width":0,"height":0,"name":"CT2 power","label":"CT2 power","format":"{{msg.payload.CT2_power}} W","layout":"row-spread","x":429.99998474121094,"y":889.2000732421875,"wires":[]},{"id":"bd45f708.445008","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":8,"width":0,"height":0,"name":"CT3 power","label":"CT3 power","format":"{{msg.payload.CT3_power}} W","layout":"row-spread","x":428.99998474121094,"y":921.2001342773438,"wires":[]},{"id":"70ac6c34.894594","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":1,"width":0,"height":0,"name":"solar power","label":"solar power","format":"{{msg.payload.solar_power}} W","layout":"row-spread","x":430,"y":690.2000732421875,"wires":[]},{"id":"40e7c122.2c862","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":9,"width":0,"height":0,"name":"Voltage","label":"Voltage","format":"{{msg.payload.voltage}} V","layout":"row-spread","x":418.99998474121094,"y":954.2000732421875,"wires":[]},{"id":"d6762886.adfc68","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":3,"width":0,"height":0,"name":"phase1 power","label":"- phase1 power","format":"{{msg.payload.phase1_power}} W","layout":"row-spread","x":439.9999694824219,"y":763.2000732421875,"wires":[]},{"id":"4d6bd369.59ea0c","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":4,"width":0,"height":0,"name":"phase2 power","label":"- phase2 power","format":"{{msg.payload.phase2_power}} W","layout":"row-spread","x":438.9999694824219,"y":794.2001342773438,"wires":[]},{"id":"1fda31d.c452ace","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":5,"width":0,"height":0,"name":"phase3 power","label":"- phase3 power","format":"{{msg.payload.phase3_power}} W","layout":"row-spread","x":437.9999694824219,"y":825.2001342773438,"wires":[]},{"id":"48d5612f.e276d","type":"ui_text","z":"cbb123e.ff1e2e","group":"f2cec1e7.bc085","order":2,"width":0,"height":0,"name":"total power","label":"Total power","format":"{{msg.payload.total_power}} W","layout":"row-spread","x":427.9999542236328,"y":729.2000122070312,"wires":[]},{"id":"fd0297cb.93a328","type":"ui_gauge","z":"d9c9b8f2.5b1738","name":"Power Now","group":"ec772749.149488","order":1,"width":"","height":"","gtype":"gage","title":"Power Now","label":"","format":"{{value}} W","min":"0","max":"5000","colors":["#00b500","#e6e600","#ca3838"],"x":604.2000122070312,"y":52,"wires":[]},{"id":"8184e3e.95b9c2","type":"ui_chart","z":"d9c9b8f2.5b1738","name":"last 10 minutes","group":"2ffa32f8.185ace","order":1,"width":"","height":"","label":"last 10 minutes (refresh 10s)","chartType":"line","xformat":"HH:mm:ss","interpolate":"cardinal","nodata":"No Data","dot":false,"ymin":"","ymax":"","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":"","useOneColor":false,"colors":["#1f77b4","#00ff00","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":615.2000122070312,"y":83,"wires":[[],[]]},{"id":"4b9cc53.10c463c","type":"ui_chart","z":"d9c9b8f2.5b1738","name":"last hour","group":"2ffa32f8.185ace","order":2,"width":"","height":"","label":"last hour (refresh 1 min)","chartType":"line","xformat":"HH:mm:ss","interpolate":"cardinal","nodata":"No Data","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":"","useOneColor":false,"colors":["#1f77b4","#00ff00","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":824.2000122070312,"y":182,"wires":[[],[]]},{"id":"ec4ebd9.e27ab4","type":"ui_gauge","z":"d9c9b8f2.5b1738","name":"Power Now","group":"ea983e7d.03c39","order":1,"width":"","height":"","gtype":"gage","title":"Power Now","label":"","format":"{{value}} W","min":0,"max":"5000","colors":["#00b500","#e6e600","#ca3838"],"x":546.2000122070312,"y":249.00006103515625,"wires":[]},{"id":"fdb0d66b.8c0fe8","type":"ui_text","z":"d9c9b8f2.5b1738","group":"ec772749.149488","order":2,"width":"","height":"","name":"Home Usage Today","label":"Home Usage Today","format":"{{msg.payload | number:2}} kWh","layout":"row-spread","x":794.4215545654297,"y":333.26513671875,"wires":[]},{"id":"1685bade.257eb5","type":"inject","z":"d9c9b8f2.5b1738","name":"Get emoncms data","topic":"","payload":"id=70587","payloadType":"str","repeat":"900","crontab":"","once":false,"x":206.37330627441406,"y":302.3333435058594,"wires":[["63967d1b.874804"]]},{"id":"63967d1b.874804","type":"http request","z":"d9c9b8f2.5b1738","name":"get KWh consumed today from emoncms.org","method":"GET","ret":"txt","url":"https://emoncms.org/feed/value.json?{{{payload}}}&apikey=4b1fb058df6f5a59c0db242ead615e50","tls":"","x":504.373291015625,"y":304.03211975097656,"wires":[["3cb82724.0b9b88"]]},{"id":"8b9c5f75.52c85","type":"ui_text","z":"d9c9b8f2.5b1738","group":"ea983e7d.03c39","order":2,"width":"","height":"","name":"Power Generated Today","label":"Power Generated Today","format":"{{msg.payload | number:2}} kWh","layout":"","x":804.05712890625,"y":399.28570556640625,"wires":[]},{"id":"46ccf23b.d44b4c","type":"inject","z":"d9c9b8f2.5b1738","name":"Get emoncms data","topic":"","payload":"id=66030","payloadType":"str","repeat":"900","crontab":"","once":false,"x":210.00888061523438,"y":367.3539123535156,"wires":[["2b5de2db.56dd1e"]]},{"id":"2b5de2db.56dd1e","type":"http request","z":"d9c9b8f2.5b1738","name":"get KWh produced today from emoncms.org","method":"GET","ret":"txt","url":"https://emoncms.org/feed/value.json?{{{payload}}}&apikey=4b1fb058df6f5a59c0db242ead615e50","tls":"","x":516.0088500976562,"y":369.05267333984375,"wires":[["4cb52655.6d3388"]]},{"id":"65ba02f8.35b18c","type":"comment","z":"d9c9b8f2.5b1738","name":"House Power","info":"","x":270.1999969482422,"y":43,"wires":[]},{"id":"19918bc1.6f8714","type":"comment","z":"d9c9b8f2.5b1738","name":"Solar Power","info":"","x":284.1999969482422,"y":132,"wires":[]},{"id":"4cb52655.6d3388","type":"change","z":"d9c9b8f2.5b1738","name":"Remove quotes","rules":[{"t":"change","p":"payload","pt":"msg","from":"\"","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":516.6999664306641,"y":400.66664123535156,"wires":[["8b9c5f75.52c85"]]},{"id":"3cb82724.0b9b88","type":"change","z":"d9c9b8f2.5b1738","name":"Remove quotes","rules":[{"t":"change","p":"payload","pt":"msg","from":"\"","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":496.86656188964844,"y":334.66663360595703,"wires":[["fdb0d66b.8c0fe8"]]},{"id":"4d0e7f05.4ed1c","type":"link in","z":"d9c9b8f2.5b1738","name":"","links":["1dcee65f.56a63a"],"x":168.5,"y":126.60000610351562,"wires":[["24f18bf9.4a3344","94813f7.df346c"]]},{"id":"24f18bf9.4a3344","type":"change","z":"d9c9b8f2.5b1738","name":"extract total power","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.total_power","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"consumption","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":298.5,"y":82.80001831054688,"wires":[["fd0297cb.93a328","8184e3e.95b9c2","eb774c12.f0811","d12bdeb5.2a5"]]},{"id":"94813f7.df346c","type":"change","z":"d9c9b8f2.5b1738","name":"extract solar power","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.solar_power","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"generation","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":284.50001525878906,"y":249.79998779296875,"wires":[["ec4ebd9.e27ab4","8184e3e.95b9c2","c31eb83e.514178"]]},{"id":"db7e8095.76ac8","type":"debug","z":"669ca4d9.6412bc","name":"","active":false,"console":"false","complete":"false","x":611.5000152587891,"y":33.599998474121094,"wires":[]},{"id":"58c8b642.45c238","type":"mqtt in","z":"4bf9468a.f3a898","name":"bme280","topic":"bme280","qos":"2","broker":"9c9ae2bc.63652","x":114,"y":60,"wires":[["56b4c034.b2836"]]},{"id":"ff1e1fe4.7b094","type":"debug","z":"4bf9468a.f3a898","name":"bme280","active":true,"console":"false","complete":"payload","x":920,"y":60,"wires":[]},{"id":"6402749.d0dad8c","type":"link out","z":"4bf9468a.f3a898","name":"bme280","links":["696b1e90.27ff1","79dec3f7.55210c"],"x":815,"y":220,"wires":[]},{"id":"6d3208e6.231f78","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":1,"width":0,"height":0,"name":"Living Temp","label":"Living","format":"{{msg.payload.temperature | number:1 }}&deg;","layout":"row-spread","x":378.0000305175781,"y":182,"wires":[]},{"id":"696b1e90.27ff1","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["6402749.d0dad8c"],"x":259.00001525878906,"y":207,"wires":[["6d3208e6.231f78","c89cad2e.ce71b","9d48fe5.99648","f317ad7.512cb5","7c811642.92a368","8f2ecca3.4757"]]},{"id":"c89cad2e.ce71b","type":"debug","z":"cbb123e.ff1e2e","name":"","active":true,"console":"false","complete":"payload","x":376.0000305175781,"y":115,"wires":[]},{"id":"1084ea44.696eb6","type":"debug","z":"cbb123e.ff1e2e","name":"","active":false,"console":"false","complete":"payload","x":413,"y":307,"wires":[]},{"id":"56b4c034.b2836","type":"json","z":"4bf9468a.f3a898","name":"","pretty":false,"x":190,"y":100,"wires":[["ffb35375.6824f"]]},{"id":"9d48fe5.99648","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":1,"width":0,"height":0,"name":"Living Humidity","label":"Living","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":636.0000152587891,"y":238,"wires":[]},{"id":"f317ad7.512cb5","type":"ui_text","z":"cbb123e.ff1e2e","group":"ed98cf29.79e9e","order":0,"width":0,"height":0,"name":"Living Pressure","label":"Living","format":"{{msg.payload.pressure  | number:0}} hPa","layout":"row-spread","x":638,"y":271,"wires":[]},{"id":"8851fa45.3b48b8","type":"ui_text","z":"cbb123e.ff1e2e","group":"ed98cf29.79e9e","order":0,"width":0,"height":0,"name":"Outside Pressure","label":"Buiten","format":"{{msg.payload.pressure  | number:0}} hPa","layout":"row-spread","x":1040.4999542236328,"y":693.4000091552734,"wires":[]},{"id":"60420f74.a0006","type":"comment","z":"21777d41.84c182","name":"requires that the msg.nodegroup is properly set","info":"","x":353,"y":38,"wires":[]},{"id":"ac5f42fb.19a7d","type":"function","z":"4bf9468a.f3a898","name":"msg.nodegroup = 8 (for emoncms)","func":"msg.nodegroup = 8;\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":60,"wires":[["ff1e1fe4.7b094","b1765445.b48228"]]},{"id":"1557a06c.93d6","type":"ui_text","z":"7fa2194.bf802e8","group":"37779cb4.2ff4e4","order":3,"width":0,"height":0,"name":"°T badkamer","label":"°T badkamer","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":427.6249809265137,"y":660.7499876022339,"wires":[]},{"id":"79911573.9fa15c","type":"link in","z":"7fa2194.bf802e8","name":"","links":["86f7971c.e72298"],"x":319.6249809265137,"y":659.7499876022339,"wires":[["1557a06c.93d6","83763b3a.ad95a8"]]},{"id":"383a1d5b.977242","type":"function","z":"7fa2194.bf802e8","name":"automatic switch off ui cv upstairs","func":"// The ui upstairs heating request must be switch off if\n// the last time it has been switched on is more than 1 hour ago.\nif ( (global.get(\"ui_cv_req_heating_upstairs\" )) && \n     ((msg.payload - global.get(\"ui_cv_req_heating_upstairs_last_change_time\"))> (60*60*1000))){\n    node.log(\"last change time =\"+ new Date(global.get(\"ui_cv_req_heating_upstairs_last_change_time\")));\n    msg.payload=0;\n    return msg;\n} else return null;\n","outputs":1,"noerr":0,"x":180.99998474121094,"y":145.99998474121094,"wires":[["d4897b9c.5ea218","1d0f7e65.f0e302"]]},{"id":"3a2326b2.ce74aa","type":"inject","z":"7fa2194.bf802e8","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"x":115.99998474121094,"y":56.99998664855957,"wires":[["383a1d5b.977242","9a38b5d.95fb048"]]},{"id":"d4897b9c.5ea218","type":"debug","z":"7fa2194.bf802e8","name":"switch off ui cv upstairs","active":true,"console":"false","complete":"payload","x":199,"y":175.99998474121094,"wires":[]},{"id":"9a38b5d.95fb048","type":"function","z":"7fa2194.bf802e8","name":"automatic switch off ui cv room jade","func":"var now = new Date(msg.payload);\nvar cur_hour = now.getHours();  // e.g. returns 22 if the current time 22:37:47 ..\n\n// automatic switch off after 3 hours since if current time is between 6:00 and 22:59\n// otherwise automatic switch off after 1 hour.\nvar switch_off_delay_in_ms = ( (cur_hour>=6)&&(cur_hour<=22) ? 3 : 1 ) * 60*60*1000;\n\nif ( (global.get(\"ui_cv_req_heating_room_jade\" )) && \n     ((msg.payload - global.get(\"ui_cv_req_heating_room_jade_last_change_time\"))> switch_off_delay_in_ms)){\n    node.log(\"last change time =\"+ new Date(global.get(\"ui_cv_req_heating_room_jade_last_change_time\")));\n    msg.payload=0;\n    return msg;\n} else return null;\n","outputs":1,"noerr":0,"x":176.625,"y":276.74999237060547,"wires":[["18718203.84a46e","6f906e12.68ee1"]]},{"id":"6f906e12.68ee1","type":"debug","z":"7fa2194.bf802e8","name":"switch off ui cv room Jade","active":true,"console":"false","complete":"payload","x":173.625,"y":307.74999237060547,"wires":[]},{"id":"6252563.82193a8","type":"comment","z":"e6728257.d2c86","name":"Status","info":"","x":531,"y":246,"wires":[]},{"id":"7ff920c5.3d75a","type":"link in","z":"e6728257.d2c86","name":"","links":["9471dcd1.342ea"],"x":440,"y":288,"wires":[["a16b98c6.c378c8","5b1a0606.f537d8","85e9eb91.ff8548"]]},{"id":"a16b98c6.c378c8","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":1,"width":0,"height":0,"name":"","label":"Ventilator","format":"{{msg.payload.ventilator?\"aan\":\"uit\"}}","layout":"row-spread","x":549,"y":289,"wires":[]},{"id":"e93e1cb3.efc74","type":"comment","z":"e6728257.d2c86","name":"Input","info":"","x":538,"y":73,"wires":[]},{"id":"bdfc7f77.f73ff","type":"ui_switch","z":"e6728257.d2c86","name":"","label":"Ventilator","group":"51a17efa.1c638","order":0,"width":0,"height":0,"passthru":true,"topic":"ui/ventilator_req","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":550,"y":110,"wires":[["5f1540f1.4389f"]]},{"id":"5f1540f1.4389f","type":"function","z":"e6728257.d2c86","name":"update ui_ventilator_request","func":"global.set(\"ui_ventilator_request\",msg.payload);\nglobal.set(\"ui_ventilator_request_last_change_time\",Date.now());\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":138,"wires":[["649f0904.088dd8","630a4166.3d13d"]]},{"id":"ec497b96.aa4fb8","type":"debug","z":"e6728257.d2c86","name":"new ventilator state","active":false,"console":"false","complete":"true","x":874,"y":178,"wires":[]},{"id":"649f0904.088dd8","type":"function","z":"e6728257.d2c86","name":"ventilator status changed ?","func":"// initialise variables\nvar ventilator_state       = global.get(\"ventilator_state\");\nvar ui_ventilator_request  = global.get(\"ui_ventilator_request\")||0;\n\n\n\n// determine new status ventilator\nvar new_ventilator_state = ui_ventilator_request ;\n\n// only send message if the new desired ventilator status is different from the actual.\nif (new_ventilator_state != ventilator_state){\n    var newMsg = { topic: \"ventilator\" ,\n                   payload: new_ventilator_state};\n    return newMsg;\n} else { return null;}\n\n","outputs":1,"noerr":0,"x":790.5,"y":210.25003051757812,"wires":[["24ebd29f.82789e","ec497b96.aa4fb8"]]},{"id":"24ebd29f.82789e","type":"link out","z":"e6728257.d2c86","name":"activate/deactive CV pump","links":["f900e935.c4c9e8"],"x":980,"y":211.00003051757812,"wires":[]},{"id":"5b1a0606.f537d8","type":"function","z":"e6728257.d2c86","name":"update ventilator_state","func":"global.set(\"ventilator_state\",msg.payload.ventilator);\nreturn msg;","outputs":1,"noerr":0,"x":598,"y":330,"wires":[["649f0904.088dd8","d726812.ece2c8"]]},{"id":"630a4166.3d13d","type":"debug","z":"e6728257.d2c86","name":"ui ventilator request","active":false,"console":"false","complete":"true","x":792,"y":108,"wires":[]},{"id":"d726812.ece2c8","type":"debug","z":"e6728257.d2c86","name":"update ventilator_state","active":false,"console":"false","complete":"true","x":858,"y":331,"wires":[]},{"id":"95e76f5c.d8ab5","type":"inject","z":"e6728257.d2c86","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":false,"x":130,"y":80,"wires":[["4ff287f7.4cf478"]]},{"id":"4ff287f7.4cf478","type":"function","z":"e6728257.d2c86","name":"automatic switch off ui ventilator request","func":"// The ui upstairs heating request must be switch off if\n// the last time it has been switched on is more than 10 hour ago.\nif ( (global.get(\"ui_ventilator_request\" )) && \n     ((msg.payload - global.get(\"ui_ventilator_request_last_change_time\"))> (10*60*60*1000))){\n    node.log(\"last change time =\"+ new Date(global.get(\"ui_ventilator_request_last_change_time\")));\n    msg.payload=0;\n    return msg;\n} else return null;\n","outputs":1,"noerr":0,"x":262.00001525878906,"y":112,"wires":[["3a9e6909.d68e86","bdfc7f77.f73ff"]]},{"id":"3a9e6909.d68e86","type":"debug","z":"e6728257.d2c86","name":"switch off ui ventilator request","active":true,"console":"false","complete":"payload","x":280.0000305175781,"y":142,"wires":[]},{"id":"d50d1c4a.5f06b","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":2,"width":0,"height":0,"name":"Kelder Temp","label":"Kelder T","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":562,"y":372,"wires":[]},{"id":"5a024f2e.26718","type":"link in","z":"e6728257.d2c86","name":"","links":["366b49a2.6c53b6"],"x":441.0000305175781,"y":398.3999938964844,"wires":[["d50d1c4a.5f06b","ba9089c7.704c98","6e7c2eb5.4addd","5d5acb98.6e8104"]]},{"id":"9d4d0159.7a062","type":"link in","z":"e6728257.d2c86","name":"","links":["f62cf426.7009d8"],"x":444.0000305175781,"y":501.39996337890625,"wires":[["c0621afe.b437d8","f4164e35.08a6d","a4c9fa4b.3808f8","bffa8f09.797a"]]},{"id":"c0621afe.b437d8","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":3,"width":0,"height":0,"name":"Outside Temp","label":"Buiten T","format":"{{msg.payload.temp | number:1 }}&deg;","layout":"row-spread","x":569.9999694824219,"y":468.20001220703125,"wires":[]},{"id":"ba9089c7.704c98","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":6,"width":0,"height":0,"name":"Kelder vochtigheid","label":"Kelder Vochtigheid","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":579,"y":406.20001220703125,"wires":[]},{"id":"f4164e35.08a6d","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":7,"width":0,"height":0,"name":"Outside humidity","label":"Buiten Vochtigheid","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":581,"y":500.20001220703125,"wires":[]},{"id":"b9f7e129.07c3e","type":"function","z":"669ca4d9.6412bc","name":"calculate and append absolute humidity","func":"// The calculation is based on \n// http://www.vaisala.com/Vaisala%20Documents/Application%20notes/Humidity_Conversion_Formulas_B210973EN-F.pdf\n// section 7 Absolute Humidity\n// A = C · Pw/T (g/m3) , where (17)\n// C = Constant 2.16679 gK/J\n// Pw = Vapour pressure in Pa\n// T = Temperature in K\n// Tn = Triple point temperature 273.16 K\n//\n//  section 1 Relative humidity definitions \n//  RH = Pw/Pws · 100% \n//\n// section 2 Water vapour saturation pressure \n//  Following formula is a simplified formula\n// Pws= A . 10 ^(m . T / (T +Tn))  (hPa) , where (6)\n// A, m, Tn = constants see Table 1 below\n// T = Temperature (°C)\n//\n// A          m          Tn       max error    Temperature range\n// 6.116441 7.591386   240.7263    0.083%         -20...+50°C \n\nvar RH = msg.payload.humidity; // RH = relative humidity\nvar Tcelcius = msg.payload.temp;\nvar T = Tcelcius + 273.15; // T in Kelvin\n\nvar Pws =  6.116441 * Math.pow(10, (7.591386 * Tcelcius / (Tcelcius + 240.7263 )));\nvar Pw = RH * Pws;\n\nvar A = 2.16679 * Pw / T;  // Absolute Humidity\n\nmsg.payload.absolute_humidity = A;\n\nreturn msg;","outputs":1,"noerr":0,"x":473,"y":193,"wires":[["b2f7a7e1.9ac498","1d482912.d51667","4b0dbb36.f1ec84"]]},{"id":"1d482912.d51667","type":"debug","z":"669ca4d9.6412bc","name":"","active":true,"console":"false","complete":"false","x":715,"y":159,"wires":[]},{"id":"209efedc.4d25d2","type":"function","z":"669ca4d9.6412bc","name":"calculate and append absolute humidity (copy)","func":"// this is a copied version of the above calculate and append absolute humidity function node\n\n// The calculation is based on \n// http://www.vaisala.com/Vaisala%20Documents/Application%20notes/Humidity_Conversion_Formulas_B210973EN-F.pdf\n// section 7 Absolute Humidity\n// A = C · Pw/T (g/m3) , where (17)\n// C = Constant 2.16679 gK/J\n// Pw = Vapour pressure in Pa\n// T = Temperature in K\n// Tn = Triple point temperature 273.16 K\n//\n//  section 1 Relative humidity definitions \n//  RH = Pw/Pws · 100% \n//\n// section 2 Water vapour saturation pressure \n//  Following formula is a simplified formula\n// Pws= A . 10 ^(m . T / (T +Tn))  (hPa) , where (6)\n// A, m, Tn = constants see Table 1 below\n// T = Temperature (°C)\n//\n// A          m          Tn       max error    Temperature range\n// 6.116441 7.591386   240.7263    0.083%         -20...+50°C \n\nvar RH = msg.payload.humidity; // RH = relative humidity\nvar Tcelcius = msg.payload.temp;\nvar T = Tcelcius + 273.15; // T in Kelvin\n\nvar Pws =  6.116441 * Math.pow(10, (7.591386 * Tcelcius / (Tcelcius + 240.7263 )));\nvar Pw = RH * Pws;\n\nvar A = 2.16679 * Pw / T;  // Absolute Humidity\n\nmsg.payload.absolute_humidity = A;\n\nreturn msg;","outputs":1,"noerr":0,"x":456.49993896484375,"y":481.7999572753906,"wires":[["86f7971c.e72298","647c8813.c3cba8","ac2805aa.f1a768"]]},{"id":"647c8813.c3cba8","type":"debug","z":"669ca4d9.6412bc","name":"","active":false,"console":"false","complete":"false","x":661.4999389648438,"y":435.7999572753906,"wires":[]},{"id":"9568e68d.f98338","type":"function","z":"89ac662.0a2c798","name":"calculate and append absolute humidity (copy)","func":"// this is a copied version of the above calculate and append absolute humidity function node\n\n// The calculation is based on \n// http://www.vaisala.com/Vaisala%20Documents/Application%20notes/Humidity_Conversion_Formulas_B210973EN-F.pdf\n// section 7 Absolute Humidity\n// A = C · Pw/T (g/m3) , where (17)\n// C = Constant 2.16679 gK/J\n// Pw = Vapour pressure in Pa\n// T = Temperature in K\n// Tn = Triple point temperature 273.16 K\n//\n//  section 1 Relative humidity definitions \n//  RH = Pw/Pws · 100% \n//\n// section 2 Water vapour saturation pressure \n//  Following formula is a simplified formula\n// Pws= A . 10 ^(m . T / (T +Tn))  (hPa) , where (6)\n// A, m, Tn = constants see Table 1 below\n// T = Temperature (°C)\n//\n// A          m          Tn       max error    Temperature range\n// 6.116441 7.591386   240.7263    0.083%         -20...+50°C \n\nvar RH = msg.payload.humidity; // RH = relative humidity\nvar Tcelcius = msg.payload.temp;\nvar T = Tcelcius + 273.15; // T in Kelvin\n\nvar Pws =  6.116441 * Math.pow(10, (7.591386 * Tcelcius / (Tcelcius + 240.7263 )));\nvar Pw = RH * Pws;\n\nvar A = 2.16679 * Pw / T;  // Absolute Humidity\n\nmsg.payload.absolute_humidity = A;\n\nreturn msg;","outputs":1,"noerr":0,"x":354,"y":186,"wires":[["f62cf426.7009d8","e886bd59.7fa58"]]},{"id":"e886bd59.7fa58","type":"debug","z":"89ac662.0a2c798","name":"","active":true,"console":"false","complete":"false","x":663,"y":139,"wires":[]},{"id":"9e6d486e.b1be28","type":"ui_text","z":"cbb123e.ff1e2e","group":"d0b9b2cd.d453d","order":5,"width":0,"height":0,"name":"Outside Absolute Humidity","label":"Buiten","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":864.4999542236328,"y":657.4000091552734,"wires":[]},{"id":"e5777a6.ed94288","type":"ui_text","z":"cbb123e.ff1e2e","group":"d0b9b2cd.d453d","order":3,"width":0,"height":0,"name":"Badkamer Absolute Humidity","label":"Badkamer","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":871,"y":431,"wires":[]},{"id":"26716c30.748174","type":"ui_text","z":"cbb123e.ff1e2e","group":"d0b9b2cd.d453d","order":2,"width":0,"height":0,"name":"Room Jade Absolute Humidity","label":"kamer Jade","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":874,"y":374,"wires":[]},{"id":"7c811642.92a368","type":"ui_text","z":"cbb123e.ff1e2e","group":"d0b9b2cd.d453d","order":1,"width":0,"height":0,"name":"Living Absolute Humidity","label":"Living","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":593,"y":205,"wires":[]},{"id":"33456e40.7648c2","type":"ui_text","z":"cbb123e.ff1e2e","group":"d0b9b2cd.d453d","order":4,"width":0,"height":0,"name":"Kelder Absolute Humidity","label":"Kelder","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":862,"y":471,"wires":[]},{"id":"f87c2d41.10211","type":"function","z":"4bf9468a.f3a898","name":"calculate and append absolute humidity (copy)","func":"// this is a copied version of the above calculate and append absolute humidity function node\n\n// The calculation is based on \n// http://www.vaisala.com/Vaisala%20Documents/Application%20notes/Humidity_Conversion_Formulas_B210973EN-F.pdf\n// section 7 Absolute Humidity\n// A = C · Pw/T (g/m3) , where (17)\n// C = Constant 2.16679 gK/J\n// Pw = Vapour pressure in Pa\n// T = Temperature in K\n// Tn = Triple point temperature 273.16 K\n//\n//  section 1 Relative humidity definitions \n//  RH = Pw/Pws · 100% \n//\n// section 2 Water vapour saturation pressure \n//  Following formula is a simplified formula\n// Pws= A . 10 ^(m . T / (T +Tn))  (hPa) , where (6)\n// A, m, Tn = constants see Table 1 below\n// T = Temperature (°C)\n//\n// A          m          Tn       max error    Temperature range\n// 6.116441 7.591386   240.7263    0.083%         -20...+50°C \n\nvar RH = msg.payload.humidity; // RH = relative humidity\nvar Tcelcius = msg.payload.temperature;\nvar T = Tcelcius + 273.15; // T in Kelvin\n\nvar Pws =  6.116441 * Math.pow(10, (7.591386 * Tcelcius / (Tcelcius + 240.7263 )));\nvar Pw = RH * Pws;\n\nvar A = 2.16679 * Pw / T;  // Absolute Humidity\n\nmsg.payload.absolute_humidity = A;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":180,"wires":[["6402749.d0dad8c","da681558.cd61e8"]]},{"id":"da681558.cd61e8","type":"debug","z":"4bf9468a.f3a898","name":"bme280 + abs humidity","active":true,"console":"false","complete":"true","x":910,"y":180,"wires":[]},{"id":"53d940e2.a38d8","type":"function","z":"83200356.0ef81","name":"calculate and append absolute humidity (copy)","func":"// this is a copied version of the above calculate and append absolute humidity function node\n\n// The calculation is based on \n// http://www.vaisala.com/Vaisala%20Documents/Application%20notes/Humidity_Conversion_Formulas_B210973EN-F.pdf\n// section 7 Absolute Humidity\n// A = C · Pw/T (g/m3) , where (17)\n// C = Constant 2.16679 gK/J\n// Pw = Vapour pressure in Pa\n// T = Temperature in K\n// Tn = Triple point temperature 273.16 K\n//\n//  section 1 Relative humidity definitions \n//  RH = Pw/Pws · 100% \n//\n// section 2 Water vapour saturation pressure \n//  Following formula is a simplified formula\n// Pws= A . 10 ^(m . T / (T +Tn))  (hPa) , where (6)\n// A, m, Tn = constants see Table 1 below\n// T = Temperature (°C)\n//\n// A          m          Tn       max error    Temperature range\n// 6.116441 7.591386   240.7263    0.083%         -20...+50°C \n\nvar RH = msg.payload.humidity; // RH = relative humidity\nvar Tcelcius = msg.payload.temp;\nvar T = Tcelcius + 273.15; // T in Kelvin\n\nvar Pws =  6.116441 * Math.pow(10, (7.591386 * Tcelcius / (Tcelcius + 240.7263 )));\nvar Pw = RH * Pws;\n\nvar A = 2.16679 * Pw / T;  // Absolute Humidity\n\nmsg.payload.absolute_humidity = A;\n\nreturn msg;","outputs":1,"noerr":0,"x":593,"y":781.0000038146973,"wires":[["366b49a2.6c53b6","d48fd540.56bf38"]]},{"id":"d48fd540.56bf38","type":"debug","z":"83200356.0ef81","name":"3ch wifi relay temp/humidity/abs humidity","active":true,"console":"false","complete":"true","x":591,"y":812.0000038146973,"wires":[]},{"id":"6e7c2eb5.4addd","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":4,"width":0,"height":0,"name":"Kelder Absolute Humidity","label":"Kelder abs. Vocht.","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":598,"y":438,"wires":[]},{"id":"a4c9fa4b.3808f8","type":"ui_text","z":"e6728257.d2c86","group":"f628845.5523878","order":5,"width":0,"height":0,"name":"Outside Absolute Humidity","label":"Buiten Abs. Vocht.","format":"{{msg.payload.absolute_humidity  | number:1}} g/m3","layout":"row-spread","x":612,"y":531,"wires":[]},{"id":"4b0dbb36.f1ec84","type":"function","z":"669ca4d9.6412bc","name":"absolute_humidity for node 23 - to emoncms","func":"var newMsg = { payload : {\"absolute_humidity\":msg.payload.absolute_humidity},\n               nodegroup:23};\n\nreturn newMsg;","outputs":1,"noerr":0,"x":484,"y":275,"wires":[["916b834.e45598","a507d943.700588"]]},{"id":"916b834.e45598","type":"debug","z":"669ca4d9.6412bc","name":"absolute_humidity for node 23 - to emoncms","active":false,"console":"false","complete":"true","x":689,"y":244,"wires":[]},{"id":"ac2805aa.f1a768","type":"function","z":"669ca4d9.6412bc","name":"absolute_humidity for node 24 - to emoncms","func":"var newMsg = { payload : {\"absolute_humidity\":msg.payload.absolute_humidity},\n               nodegroup:24};\n\nreturn newMsg;","outputs":1,"noerr":0,"x":410,"y":600,"wires":[["9940dbd9.91a858","b44eb838.507e08"]]},{"id":"9940dbd9.91a858","type":"debug","z":"669ca4d9.6412bc","name":"absolute_humidity for node 24 - to emoncms","active":false,"console":"false","complete":"true","x":610,"y":560,"wires":[]},{"id":"b44eb838.507e08","type":"link out","z":"669ca4d9.6412bc","name":"absolute_humidity node 24","links":["79dec3f7.55210c"],"x":675,"y":600,"wires":[]},{"id":"a507d943.700588","type":"link out","z":"669ca4d9.6412bc","name":"absolute humidity node23","links":["79dec3f7.55210c"],"x":731,"y":275,"wires":[]},{"id":"a1ea7ebe.d0531","type":"link in","z":"3f0318fd.5897c8","name":"","links":["1dcee65f.56a63a"],"x":187,"y":114,"wires":[["71fa8fce.fecce"]]},{"id":"71fa8fce.fecce","type":"debug","z":"3f0318fd.5897c8","name":"","active":false,"console":"false","complete":"true","x":304,"y":74,"wires":[]},{"id":"6e2f5e8e.a9b5","type":"mqtt in","z":"3f0318fd.5897c8","name":"emonTx","topic":"emonhub/rx/10/values","qos":"0","broker":"9c9ae2bc.63652","x":151,"y":196,"wires":[["caf0ae18.54c69","45057959.e7b4c8"]]},{"id":"caf0ae18.54c69","type":"debug","z":"3f0318fd.5897c8","name":"","active":false,"console":"false","complete":"true","x":305,"y":145,"wires":[]},{"id":"f7f9f4e1.0bc178","type":"inject","z":"3f0318fd.5897c8","name":"replay","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":110,"y":433,"wires":[["7c1d5023.0439a"]]},{"id":"a95040dd.1f3f1","type":"debug","z":"3f0318fd.5897c8","name":"","active":false,"console":"false","complete":"true","x":1112,"y":511,"wires":[]},{"id":"7c1d5023.0439a","type":"debug","z":"3f0318fd.5897c8","name":"","active":false,"console":"false","complete":"true","x":246,"y":369,"wires":[]},{"id":"87ca98a9.020498","type":"function","z":"3f0318fd.5897c8","name":"iterate in blocks of 100","func":"var MSG_LIMIT = 100;\n\nmsg.limit = MSG_LIMIT ;\nif (! msg.skip_init) { \n    msg.skip = 0 ;\n    msg.skip_init = 1;\n} else {\n    msg.skip += MSG_LIMIT ;\n}\n\nmsg.limit = MSG_LIMIT ;\nmsg.payload -= MSG_LIMIT ;\n\nif (msg.payload > 0) {\n    return [ msg, msg];\n} else return [ msg , null];\n","outputs":"2","noerr":0,"x":439,"y":513,"wires":[["a6189915.f9e398"],["a34c4265.f0a52","177134f6.e21bdb"]]},{"id":"3696c3e5.c42f8c","type":"debug","z":"3f0318fd.5897c8","name":"count","active":true,"console":"false","complete":"true","x":397,"y":444,"wires":[]},{"id":"a34c4265.f0a52","type":"debug","z":"3f0318fd.5897c8","name":"","active":false,"console":"false","complete":"true","x":580,"y":566,"wires":[]},{"id":"a6189915.f9e398","type":"debug","z":"3f0318fd.5897c8","name":"","active":true,"console":"false","complete":"true","x":586,"y":466,"wires":[]},{"id":"177134f6.e21bdb","type":"delay","z":"3f0318fd.5897c8","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":421,"y":569,"wires":[["87ca98a9.020498"]]},{"id":"e31330ea.89ccc","type":"split","z":"3f0318fd.5897c8","name":"","splt":"\\n","x":844,"y":559,"wires":[["92582bbe.0130d8"]]},{"id":"92582bbe.0130d8","type":"debug","z":"3f0318fd.5897c8","name":"","active":true,"console":"false","complete":"false","x":993,"y":560,"wires":[]},{"id":"45057959.e7b4c8","type":"function","z":"3f0318fd.5897c8","name":"extract power and add timestamp","func":"var parts        = msg.payload.split(\",\");\nvar solar_power  = parseFloat(parts[3]);\nvar voltage      = parseFloat(parts[4]);\nvar CT1_power    = parseFloat(parts[0]);\nvar CT2_power    = parseFloat(parts[1]);\nvar CT3_power    = parseFloat(parts[2]);\nvar phase1_power = CT1_power + solar_power;\nvar phase2_power = - CT2_power;\nvar phase3_power = CT3_power;\nvar total_power  = phase1_power + phase2_power + phase3_power;\nmsg.payload = { \"timestamp\"    : Date.now(),\n                \"total_power\"  : total_power,\n                \"solar_power\"  : solar_power,\n                \"voltage\"      : voltage,\n                \"phase1_power\" : phase1_power,\n                \"phase2_power\" : phase2_power,\n                \"phase3_power\" : phase3_power\n};\nreturn msg;","outputs":1,"noerr":0,"x":395,"y":198,"wires":[["3babbfa5.27dbb"]]},{"id":"3babbfa5.27dbb","type":"debug","z":"3f0318fd.5897c8","name":"","active":true,"console":"false","complete":"true","x":631,"y":148,"wires":[]},{"id":"98683252.2dcf","type":"inject","z":"d3bff47.a17e508","name":"every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"x":152,"y":79,"wires":[["b8ae9f66.582b5"]]},{"id":"b8ae9f66.582b5","type":"exec","z":"d3bff47.a17e508","command":"cat /sys/class/thermal/thermal_zone0/temp","addpay":false,"append":"","useSpawn":"","timer":"","oldrc":false,"name":"cpu temp","x":320,"y":79.5,"wires":[["e0cb7880.95b1b8","c22765ae.30b708"],["6849767a.347ad8"],["cf8e91ef.c5f15"]]},{"id":"e0cb7880.95b1b8","type":"debug","z":"d3bff47.a17e508","name":"stdout","active":false,"console":"false","complete":"true","x":500,"y":29,"wires":[]},{"id":"6849767a.347ad8","type":"debug","z":"d3bff47.a17e508","name":"stderr","active":false,"console":"false","complete":"true","x":502,"y":84,"wires":[]},{"id":"cf8e91ef.c5f15","type":"debug","z":"d3bff47.a17e508","name":"return code","active":false,"console":"false","complete":"true","x":514,"y":121,"wires":[]},{"id":"c22765ae.30b708","type":"function","z":"d3bff47.a17e508","name":"convert to °C","func":"msg.payload = { CpuTemp : parseInt(msg.payload)/1000 };\nreturn msg;","outputs":1,"noerr":0,"x":653,"y":59,"wires":[["5aecb53f.91e47c"]]},{"id":"fa10ce24.3a429","type":"debug","z":"d3bff47.a17e508","name":"pi cpu_temp","active":true,"console":"false","complete":"true","x":992,"y":86,"wires":[]},{"id":"91056def.461fc","type":"link out","z":"d3bff47.a17e508","name":"CpuTemp of pi3one","links":["79dec3f7.55210c"],"x":939,"y":134,"wires":[]},{"id":"5aecb53f.91e47c","type":"change","z":"d3bff47.a17e508","name":"set msg.nodegroup=11","rules":[{"t":"set","p":"nodegroup","pt":"msg","to":"11","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":787,"y":134,"wires":[["91056def.461fc","fa10ce24.3a429"]]},{"id":"45129a3.f9f1f64","type":"ui_chart","z":"d9c9b8f2.5b1738","name":"last day","group":"2ffa32f8.185ace","order":3,"width":0,"height":0,"label":"last day (refresh 20 min)","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#00ff00","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1160,"y":180,"wires":[[],[]]},{"id":"a783da6.6e28528","type":"debug","z":"d9c9b8f2.5b1738","name":"mean per minute (consumption)","active":true,"console":"false","complete":"true","x":883,"y":100,"wires":[]},{"id":"d12bdeb5.2a5","type":"debug","z":"d9c9b8f2.5b1738","name":"","active":false,"console":"false","complete":"true","x":444,"y":24,"wires":[]},{"id":"b17445a6.346548","type":"debug","z":"d9c9b8f2.5b1738","name":"mean per minute (generation)","active":true,"console":"false","complete":"true","x":893,"y":252,"wires":[]},{"id":"9a39cfe6.00f66","type":"link in","z":"d448e38d.8eb16","name":"ui status","links":["c3881eee.a2eb6"],"x":180,"y":145,"wires":[["8ea805ff.ee1e08","9c4d8e93.fc4c1"]]},{"id":"8ea805ff.ee1e08","type":"debug","z":"d448e38d.8eb16","name":"","active":true,"console":"false","complete":"true","x":357,"y":46,"wires":[]},{"id":"63e6d2e8.6942ec","type":"function","z":"d448e38d.8eb16","name":"Update availability / up time","func":"// loop through msg.payload\n//    replace each 0:1\n//    by { up: [0|1], uptime : xxx , up_percentage : [%] }\n// to do so following variables must be stored:\n//    first time seen, last time seen\n//    last_status\n//    up_down_since\n//    total_up_time\n\nvar device = msg.parts.key;\nvar current_status = msg.payload;\nvar now = Date.now();\nvar device_ctx = context.get(device)|| \n                 { \"first_time\" : now, \"last_time\": now, \"last_status\": 0, \"up_or_down_since\": now, \"total_up_time\" : 0 };\n\n\nif (device_ctx.last_status===1) { device_ctx.total_up_time += (now - device_ctx.last_time); }\nif (device_ctx.last_status != current_status){ device_ctx.up_or_down_since = now;}\ndevice_ctx.last_time = now;\ndevice_ctx.last_status = current_status;\n\nvar up_percentage;\nif ((device_ctx.last_time-device_ctx.first_time) > 0){\n    up_percentage = device_ctx.total_up_time *100 / (device_ctx.last_time-device_ctx.first_time);\n    up_percentage = Math.round(up_percentage*100)/100;\n} else up_percentage = -1;\n\n\n\n// calculate up or down time\n// http://stackoverflow.com/questions/37096367/how-to-convert-seconds-to-minutes-and-hours-in-javascript\nd = Number((device_ctx.last_time-device_ctx.up_or_down_since)/1000);\nvar days = Math.floor(d / (3600*24));\nvar h = Math.floor(d / 3600 % 24);\nvar m = Math.floor(d % 3600 / 60);\nvar s = Math.floor(d % 3600 % 60);\n\nvar daysDisplay = days > 0 ? days + (days == 1 ? \" day \" : \" days \") : \"\";\nvar hDisplay = h > 9 ? h : \"0\" + h;\nvar mDisplay = m > 9 ? m : \"0\" + m;\nvar sDisplay = s > 9 ? s : \"0\" + s;\n\nvar up_or_down_time = daysDisplay + hDisplay + \":\" + mDisplay + \":\" + sDisplay;\n\nvar status_msg = (current_status ? \"UP time = \": \"DOWN time = \");\nstatus_msg = status_msg + up_or_down_time + \" [UP%=\"+up_percentage + \"]\";\n\ncontext.set(device,device_ctx);\n\n\nvar newMsg = {  \"device\" :  msg.parts.key,\n                \"payload\" : { \"up\"            : msg.payload,\n                              \"up_percentage\" : up_percentage,\n                              \"up_or_down_time\" : up_or_down_time,\n                              \"status_msg\"    : status_msg,\n                              \"first_time\"    : device_ctx.first_time,\n                              \"last_time\"     : device_ctx.last_time,\n                              \"last_status\"   : device_ctx.last_status,\n                              \"up_or_down_since\"      : device_ctx.up_or_down_since,\n                              \"total_up_down_time\" : device_ctx.total_up_time\n                }};\n\n\nreturn newMsg;","outputs":1,"noerr":0,"x":562,"y":214,"wires":[["4221a0e0.26547","9cc61cf4.d4964"]]},{"id":"9c4d8e93.fc4c1","type":"split","z":"d448e38d.8eb16","name":"","splt":"\\n","spltType":"str","arraySplt":"1","arraySpltType":"len","stream":false,"addname":"","x":345,"y":214,"wires":[["a3cc583d.7d0738","63e6d2e8.6942ec"]]},{"id":"a3cc583d.7d0738","type":"debug","z":"d448e38d.8eb16","name":"","active":false,"console":"false","complete":"true","x":499,"y":146,"wires":[]},{"id":"4221a0e0.26547","type":"debug","z":"d448e38d.8eb16","name":"","active":true,"console":"false","complete":"true","x":801,"y":174,"wires":[]},{"id":"67f1eaad.1c4c14","type":"inject","z":"d448e38d.8eb16","name":"","topic":"","payload":"{\"testDeviceX\":1}","payloadType":"json","repeat":"","crontab":"","once":false,"x":124,"y":266,"wires":[["3b613e87.89b732","9c4d8e93.fc4c1"]]},{"id":"3b613e87.89b732","type":"debug","z":"d448e38d.8eb16","name":"","active":false,"console":"false","complete":"payload","x":338,"y":300,"wires":[]},{"id":"aab7f70e.cfeb28","type":"inject","z":"d448e38d.8eb16","name":"","topic":"","payload":"{\"testDeviceX\":0}","payloadType":"json","repeat":"","crontab":"","once":false,"x":125,"y":330,"wires":[["3b613e87.89b732","9c4d8e93.fc4c1"]]},{"id":"9cc61cf4.d4964","type":"switch","z":"d448e38d.8eb16","name":"pi","property":"device","propertyType":"msg","rules":[{"t":"eq","v":"testDeviceX","vt":"str"},{"t":"eq","v":"TL-WPA4220","vt":"str"},{"t":"eq","v":"TL-WPA4220_2","vt":"str"},{"t":"eq","v":"cisco_switch","vt":"str"},{"t":"eq","v":"wifi_relay_cv","vt":"str"},{"t":"eq","v":"bbox_jan","vt":"str"},{"t":"eq","v":"WD","vt":"str"},{"t":"eq","v":"pi3two","vt":"str"},{"t":"eq","v":"internet","vt":"str"},{"t":"eq","v":"pi3three","vt":"str"}],"checkall":"true","repair":false,"outputs":10,"x":545,"y":317,"wires":[["edf9fb5f.42e838"],["da192d9e.9f113"],["1cb9e86d.14ace8"],["ecb14ed4.0256e"],["2758970a.c09668"],["df49957.4642f68"],["d905c9eb.315788"],["54674569.eca0cc"],["e5e44bda.1c6528"],["9eeecd2d.c22b5"]]},{"id":"edf9fb5f.42e838","type":"debug","z":"d448e38d.8eb16","name":"","active":true,"console":"false","complete":"true","x":706,"y":278,"wires":[]},{"id":"da192d9e.9f113","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":1,"width":0,"height":0,"name":"","label":"TL-WPA4220:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":740,"y":372,"wires":[]},{"id":"1cb9e86d.14ace8","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":2,"width":0,"height":0,"name":"","label":"TL-WPA4220_2:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":744,"y":413,"wires":[]},{"id":"ecb14ed4.0256e","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":3,"width":0,"height":0,"name":"","label":"cisco_switch:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":725,"y":456,"wires":[]},{"id":"2758970a.c09668","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":4,"width":0,"height":0,"name":"","label":"wifi_relay_cv","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":727,"y":498,"wires":[]},{"id":"df49957.4642f68","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":5,"width":0,"height":0,"name":"","label":"bbox_jan:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":724,"y":545,"wires":[]},{"id":"d905c9eb.315788","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":6,"width":0,"height":0,"name":"","label":"WD","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":712,"y":587,"wires":[]},{"id":"54674569.eca0cc","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":7,"width":0,"height":0,"name":"","label":"pi3two:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":718,"y":629,"wires":[]},{"id":"3c07b136.516d0e","type":"ping","z":"fed72f15.8d836","name":"ping www.google.com","host":"www.google.com","timer":"300","x":100,"y":511.7999725341797,"wires":[["b51d1c90.aec1d","8bdf569f.c00db8"]]},{"id":"b51d1c90.aec1d","type":"debug","z":"fed72f15.8d836","name":"ping google response","active":true,"console":"false","complete":"true","x":221,"y":473.7999725341797,"wires":[]},{"id":"8bdf569f.c00db8","type":"function","z":"fed72f15.8d836","name":"\"internet\" emon input","func":"var ping_google_status = ( msg.payload === false ? 0 : 1 );\n\nvar newMsg = { \n nodegroup: \"7\",\n payload: {\"internet\": ping_google_status }};\n \n \nreturn newMsg;","outputs":1,"noerr":0,"x":428,"y":511.7999725341797,"wires":[["c3881eee.a2eb6","85d1969e.2b3868"]]},{"id":"85d1969e.2b3868","type":"debug","z":"fed72f15.8d836","name":"\"internet\" emon input","active":true,"console":"false","complete":"true","x":738,"y":511.7999725341797,"wires":[]},{"id":"e5e44bda.1c6528","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":9,"width":0,"height":0,"name":"","label":"internet","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":720,"y":680,"wires":[]},{"id":"d9449728.eeac88","type":"comment","z":"e6728257.d2c86","name":"chart absolute humidity","info":"","x":592,"y":573,"wires":[]},{"id":"4a45b2e9.b7deac","type":"ui_chart","z":"e6728257.d2c86","name":"absolute humidity kelder & outside","group":"c75b2ad7.9d6f98","order":2,"width":0,"height":0,"label":"[g/m3]","chartType":"line","legend":"false","xformat":"dd HHu","interpolate":"linear","nodata":"","ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"604800","cutout":0,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"x":1043,"y":696,"wires":[[],[]]},{"id":"bffa8f09.797a","type":"change","z":"e6728257.d2c86","name":"extract absolute_humidity buiten","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.absolute_humidity","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"buiten","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":629.9999542236328,"y":761.9999856948853,"wires":[["8a6814dc.db93c8","b8f90cd.76378f"]]},{"id":"85e9eb91.ff8548","type":"function","z":"e6728257.d2c86","name":"ventilator state changed ?","func":"// when the ventilator status changed it will sent 2 messages:\n//  - the first one reporting the old status\n//  - the second one reporting the new status\n// ventilator on is reported as 12 and off is reported as 0 in the chart.\nvar last_ventilator_state_for_chart = context.get('ventilator_state_for_chart')||0;\nvar new_ventilator_state = msg.payload.ventilator;\nvar new_msg = {};\n\nif ( last_ventilator_state_for_chart != new_ventilator_state){\n    context.set('ventilator_state_for_chart',new_ventilator_state);\n    msg.payload     =  (new_ventilator_state ? 0: 12);\n    new_msg.payload = (new_ventilator_state ? 12: 0);\n    new_msg.topic = msg.topic = \"ventilator\";\n    return [ [msg, new_msg]];\n}\n\nreturn null;","outputs":1,"noerr":0,"x":612,"y":614.4444580078125,"wires":[["29a22edc.2d9e22","4a45b2e9.b7deac"]]},{"id":"29a22edc.2d9e22","type":"debug","z":"e6728257.d2c86","name":"ventilator state for chart","active":false,"console":"false","complete":"true","x":932.22216796875,"y":564.2222290039062,"wires":[]},{"id":"3e0f4308.af983c","type":"debug","z":"e6728257.d2c86","name":"average per hour (kelder)","active":true,"console":"false","complete":"true","x":1024,"y":656,"wires":[]},{"id":"75bcc356.11741c","type":"debug","z":"e6728257.d2c86","name":"average per hour (buiten)","active":true,"console":"false","complete":"true","x":1037,"y":808,"wires":[]},{"id":"adad77b6.9e96c8","type":"debug","z":"e6728257.d2c86","name":"abs humidity kelder","active":true,"console":"false","complete":"true","x":901,"y":602,"wires":[]},{"id":"b8f90cd.76378f","type":"debug","z":"e6728257.d2c86","name":"abs humidity buiten","active":true,"console":"false","complete":"true","x":893,"y":738,"wires":[]},{"id":"5d5acb98.6e8104","type":"change","z":"e6728257.d2c86","name":"extract absolute humidity kelder","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.absolute_humidity","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"kelder","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":623.8115386962891,"y":656.9791564941406,"wires":[["adad77b6.9e96c8","d922ce77.fa1e6"]]},{"id":"f0c95a28.052ae8","type":"ui_template","z":"e6728257.d2c86","group":"c75b2ad7.9d6f98","name":"emoncms chart \"ventilator and absolute humidity\"","order":1,"width":0,"height":0,"format":"","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":850,"y":880,"wires":[[]]},{"id":"f557079.49e45f8","type":"inject","z":"ae997a8f.fef6b8","name":"default category","topic":"","payload":"weather","payloadType":"str","repeat":"","crontab":"","once":true,"x":124,"y":80,"wires":[["66bd084.00da4f8","cdbc64e3.6ed488"]]},{"id":"93154e68.7bbb2","type":"ui_template","z":"ae997a8f.fef6b8","group":"1136228c.3d68bd","name":"emoncms chart","order":1,"width":"20","height":"17","format":"","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":822,"y":608,"wires":[["4f3f355d.31133c"]]},{"id":"d71d83a9.5c767","type":"template","z":"ae997a8f.fef6b8","name":"emoncms iframe html","field":"template","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<iframe style=\"width:{{flow.width}}px; height:{{flow.height}}px;\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" \n src=\"http://192.168.1.131/emoncms/{{flow.url_path}}&embed=1&apikey={{flow.emoncms_read_api_key}}\"></iframe>","x":735,"y":536,"wires":[["93154e68.7bbb2","7512eaee.398874"]]},{"id":"7512eaee.398874","type":"debug","z":"ae997a8f.fef6b8","name":"emoncms chart msg","active":true,"console":"false","complete":"true","x":867,"y":479,"wires":[]},{"id":"38029f49.91581","type":"ui_dropdown","z":"ae997a8f.fef6b8","name":"emoncms chart selector","label":"","place":"Select option","group":"3bbe7a3b.70c496","order":1,"width":0,"height":0,"passthru":false,"options":[{"label":"nog niet geinitializeerd","value":"x","type":"str"}],"payload":"","topic":"","x":178,"y":215,"wires":[["f3f134.9c386ed","adace71.c885a18"]]},{"id":"66bd084.00da4f8","type":"ui_dropdown","z":"ae997a8f.fef6b8","name":"emoncms category selector","label":"","place":"Select option","group":"859d9075.9393c","order":1,"width":0,"height":0,"passthru":true,"options":[{"label":"pi","value":"pi","type":"str"},{"label":"electr. & water","value":"power","type":"str"},{"label":"weer","value":"weather","type":"str"},{"label":"netwerk","value":"lan","type":"str"}],"payload":"","topic":"","x":182,"y":123,"wires":[["a25dcc9e.2c5bc","350b8e4f.9928f2"]]},{"id":"a25dcc9e.2c5bc","type":"debug","z":"ae997a8f.fef6b8","name":"emoncms category","active":true,"console":"false","complete":"true","x":459,"y":122,"wires":[]},{"id":"f3f134.9c386ed","type":"debug","z":"ae997a8f.fef6b8","name":"emoncms chart","active":true,"console":"false","complete":"true","x":415,"y":214,"wires":[]},{"id":"350b8e4f.9928f2","type":"function","z":"ae997a8f.fef6b8","name":"get chart options","func":"switch(msg.payload){\n    case \"pi\":\n        msg.options = [ \n    { \"pi process mem\": \"13278\"},\n    { \"pi process cpu\": \"15\" },\n    { \"pi free mem\" : \"13262\" },\n    { \"pi load\": \"13263\" },\n    { \"pi free sd card\" : \"13264\" },\n    { \"pi harddisks\" : \"13266\" },\n    { \"pi network\" : \"13328\" },\n    { \"pi cpu\" : \"13329\" },\n    { \"pi cpu idle\" : \"13333\" },\n    { \"pi cpu wait\" : \"13334\" },\n    { \"pi cpu temp versus cpu idle\" : \"13457\" },\n    { \"pi3one cpu temp\" : \"13478\" },\n    { \"pi3two cpu temp\" : \"13479\" }\n    ];\n        break;\n    case \"power\":\n        msg.options = [\n    {\"water per 5 min\" : \"14\" },\n    {\"water per 5 sec\" : \"16\" },\n    {\"water per day\" : \"13\" },\n    \"myelectric\",\n    \"myelectric2\",\n    \"mysolarpv\" ,\n    \"mysolarpv2\" ,\n    {\"power 3 phases\" : \"6088\" },\n    {\"house and solar power\" : \"6089\" },\n    {\"kWhd 3 phases\" : \"6090\" },\n    {\"kWhd house and solar\" : \"6091\" }];\n        break;\n    case \"weather\":\n        msg.options = [\t\n    {\"Pressure\" : \"12980\" },\n    {\"Absolute Humidity\" : \"12978\" },\n\t{\"CV temp\": \"9560\"},\n\t{\"Humidity Clouds\" : \"9561\" },\n\t{\"temperature\" : \"10087\" },\n    {\"relative humidity\" : \"11861\" },\n    { \"All humidity sensor at home\" : \"11999\" },\n    { \"Voltage of 2 emonTh\" : \"12001\" },\n\t{ \"ventilator and abs humidity\": \"13459\" },\n    { \"ventilation and temp\" : \"13460\" },\n    { \"ventilation and humidity\" : \"13461\" }];\n        break;\n    case \"lan\" :\n        msg.options = [\n    {\"servers\": \"8\" },\n\t{\"home entertainment\" : \"7\" },\n    {\"network\" : \"9\" },\n    {\"laptops\" : \"11\" },\n    {\"mobile Kids\" : \"6\" },\n    // {\"uur laptop schermen per dag\": \"9976\" },\n    {\"TV per dag\" : \"12\" },\n\t{ \"mobile parents\" : \"5\" }];\n        break;\n    default:\n        msg.options = [];\n}\nreturn msg;","outputs":1,"noerr":0,"x":177,"y":167,"wires":[["38029f49.91581"]]},{"id":"cdbc64e3.6ed488","type":"debug","z":"ae997a8f.fef6b8","name":"default category","active":true,"console":"false","complete":"true","x":412,"y":79,"wires":[]},{"id":"4a9c4f5f.d5839","type":"change","z":"ae997a8f.fef6b8","name":"set url_path to specified multigraph","rules":[{"t":"set","p":"url_path","pt":"flow","to":"\"vis/multigraph?mid=\" & msg.payload","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":396,"y":422,"wires":[["d71d83a9.5c767","d57f086.efa24f8"]]},{"id":"b9e85a87.9e6d48","type":"ui_dropdown","z":"ae997a8f.fef6b8","name":"device selector","label":"","place":"Select option","group":"93ffe36a.9369f","order":1,"width":0,"height":0,"passthru":true,"options":[{"label":"n7","value":"nexus7","type":"str"},{"label":"1920","value":"1920x1080","type":"str"},{"label":"s7","value":"s7","type":"str"},{"label":"s7L","value":"s7L","type":"str"}],"payload":"","topic":"","x":142,"y":471,"wires":[["d08ba9d2.80a3f8"]]},{"id":"8e38dcc6.66071","type":"change","z":"ae997a8f.fef6b8","name":"settings nexus7","rules":[{"t":"set","p":"width","pt":"flow","to":"920","tot":"str"},{"t":"set","p":"height","pt":"flow","to":"450","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":501,"wires":[["d71d83a9.5c767"]]},{"id":"d08ba9d2.80a3f8","type":"switch","z":"ae997a8f.fef6b8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"nexus7","vt":"str"},{"t":"eq","v":"1920x1080","vt":"str"},{"t":"eq","v":"s7","vt":"str"},{"t":"eq","v":"s7L","vt":"str"}],"checkall":"true","outputs":4,"x":253,"y":536,"wires":[["8e38dcc6.66071"],["b6c178e3.9794b8"],["fec6aa77.9a1658"],["e567bf5a.b79f1"]]},{"id":"fec6aa77.9a1658","type":"change","z":"ae997a8f.fef6b8","name":"settings s7","rules":[{"t":"set","p":"width","pt":"flow","to":"350","tot":"str"},{"t":"set","p":"height","pt":"flow","to":"460","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":439,"y":589,"wires":[["d71d83a9.5c767"]]},{"id":"b6c178e3.9794b8","type":"change","z":"ae997a8f.fef6b8","name":"settings 1920x1080","rules":[{"t":"set","p":"width","pt":"flow","to":"1000","tot":"str"},{"t":"set","p":"height","pt":"flow","to":"800","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":468,"y":543,"wires":[["d71d83a9.5c767","34b377b6.e25cc8"]]},{"id":"7f755f8c.d5013","type":"comment","z":"ae997a8f.fef6b8","name":"UI to select emoncms.org charts","info":"","x":144,"y":20,"wires":[]},{"id":"4f3f355d.31133c","type":"debug","z":"ae997a8f.fef6b8","name":"emoncms chart","active":true,"console":"false","complete":"true","x":1022,"y":609,"wires":[]},{"id":"34b377b6.e25cc8","type":"debug","z":"ae997a8f.fef6b8","name":"settings 1920x1080","active":true,"console":"false","complete":"true","x":744,"y":415,"wires":[]},{"id":"e567bf5a.b79f1","type":"change","z":"ae997a8f.fef6b8","name":"settings s7L","rules":[{"t":"set","p":"width","pt":"flow","to":"600","tot":"str"},{"t":"set","p":"height","pt":"flow","to":"270","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":438,"y":631,"wires":[["d71d83a9.5c767"]]},{"id":"d57f086.efa24f8","type":"debug","z":"ae997a8f.fef6b8","name":"chart_id in flow context","active":true,"console":"false","complete":"true","x":717,"y":254,"wires":[]},{"id":"adace71.c885a18","type":"switch","z":"ae997a8f.fef6b8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"myelectric","vt":"str"},{"t":"eq","v":"myelectric2","vt":"str"},{"t":"eq","v":"mysolarpv","vt":"str"},{"t":"eq","v":"mysolarpv2","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":136,"y":301,"wires":[["f09c1d88.48ba4"],["2626588.75fb8a8"],["751abf05.88594"],["b96d26e8.bfcf48"],["4a9c4f5f.d5839"]]},{"id":"2626588.75fb8a8","type":"change","z":"ae997a8f.fef6b8","name":"set url_path to myelectric app","rules":[{"t":"set","p":"url_path","pt":"flow","to":"app/view?name=My%20Electric","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":382,"y":310,"wires":[["d71d83a9.5c767"]]},{"id":"751abf05.88594","type":"change","z":"ae997a8f.fef6b8","name":"set url_path to my solarpv app","rules":[{"t":"set","p":"url_path","pt":"flow","to":"app/view?name=mysolarpv","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":388,"y":351,"wires":[["d71d83a9.5c767"]]},{"id":"f09c1d88.48ba4","type":"change","z":"ae997a8f.fef6b8","name":"set url_path to zoom electric","rules":[{"t":"set","p":"url_path","pt":"flow","to":"vis/zoom?power=70585&kwhd=70587&currency=€&currency_after_val=0&pricekwh=0.2577","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":378,"y":273,"wires":[["d71d83a9.5c767"]]},{"id":"b96d26e8.bfcf48","type":"change","z":"ae997a8f.fef6b8","name":"set msg.template to zoom solarpv","rules":[{"t":"set","p":"url_path","pt":"flow","to":"vis/zoom?power=66025&kwhd=66030&currency=€&currency_after_val=0&pricekwh=0.5877","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":393,"y":389,"wires":[["d71d83a9.5c767"]]},{"id":"d0ca3f77.793e2","type":"ui_template","z":"c7bb51ea.b7706","group":"3d15fa9f.dfffe6","name":"buienradar iframe","order":1,"width":"7","height":"7","format":"","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1088,"y":87,"wires":[[]]},{"id":"7be5e12d.8fe91","type":"http request","z":"c7bb51ea.b7706","name":"get buienradar rain data","method":"GET","ret":"txt","url":"","tls":"","x":912,"y":273,"wires":[["10388e7b.3639a2","a8a9c1c4.8eef7"]]},{"id":"10388e7b.3639a2","type":"debug","z":"c7bb51ea.b7706","name":"buienradar rain data","active":true,"console":"false","complete":"true","x":1127,"y":231,"wires":[]},{"id":"a8a9c1c4.8eef7","type":"split","z":"c7bb51ea.b7706","name":"","splt":"\\n","x":936,"y":322,"wires":[["ba71612e.46b76","2d00fe04.0e07c2"]]},{"id":"842a6a1c.1a4f78","type":"join","z":"c7bb51ea.b7706","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","timeout":"","count":"","x":927,"y":450,"wires":[["2746ed98.1f88c2","bc996f7e.861a"]]},{"id":"ba71612e.46b76","type":"debug","z":"c7bb51ea.b7706","name":"output split","active":false,"console":"false","complete":"true","x":1126,"y":319,"wires":[]},{"id":"5c0b10aa.ba3bb","type":"change","z":"c7bb51ea.b7706","name":"set msg.parts.type to array","rules":[{"t":"set","p":"parts.type","pt":"msg","to":"array","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":938,"y":408,"wires":[["842a6a1c.1a4f78"]]},{"id":"2746ed98.1f88c2","type":"debug","z":"c7bb51ea.b7706","name":"joined output","active":false,"console":"false","complete":"true","x":1143,"y":452,"wires":[]},{"id":"2d00fe04.0e07c2","type":"function","z":"c7bb51ea.b7706","name":"rain string to object","func":"// converst a payload string like \"077|23:00 \"\n// into an object like { time : \"23:00 \"\", rain : \"072\", rain_mm_per_hour : 0.1 }\n//\n\nvar str = msg.payload.split(\"|\");\n\n// conversion of the rain is based on\n// https://www.buienradar.nl/overbuienradar/gratis-weerdata\n// Neerslagintensiteit in mm/u = 10^((waarde-109)/32)\n\nmsg.payload = { \"time\" : str[1], \"rain\" : str[0],\n                \"rain_mm_per_hour\" : Math.pow(10, ( (Number(str[0])-109)/32))};\n\nreturn msg;","outputs":1,"noerr":0,"x":926,"y":363,"wires":[["34e20c26.5f1484","5c0b10aa.ba3bb"]]},{"id":"34e20c26.5f1484","type":"debug","z":"c7bb51ea.b7706","name":"string to object","active":false,"console":"false","complete":"true","x":1157,"y":365,"wires":[]},{"id":"bc996f7e.861a","type":"ui_template","z":"c7bb51ea.b7706","group":"5d9dca08.657f84","name":"rain expectations","order":2,"width":"4","height":"13","format":"<table>\n  <tr>\n    <th>time</th>\n    <th>0-255</th>\n    <th>mm/u</th>\n  </tr>\n  <!-- limitTo is added as the payload array contained a 25th element without any rain data -->\n  <tr ng-repeat=\"x in msg.payload  | limitTo : 24\">\n    <td>{{ x.time }}</td>\n    <td>{{ x.rain }}</td>\n    <td>{{ x.rain_mm_per_hour | number : 3 }}</td>\n  </tr>\n</table>","storeOutMessages":true,"fwdInMessages":true,"x":1067,"y":497,"wires":[[]]},{"id":"c542e90.a87cc18","type":"http request","z":"c7bb51ea.b7706","name":"get Borsbeek 48hours forecast","method":"GET","ret":"obj","url":"","tls":"","x":303,"y":633,"wires":[["bef4b4cb.87e6e8","32dbe60.b7f8a1a","1de5b321.186e2d"]]},{"id":"bef4b4cb.87e6e8","type":"debug","z":"c7bb51ea.b7706","name":"bosrbeek 48hours forecast","active":true,"console":"false","complete":"true","x":611,"y":630,"wires":[]},{"id":"32dbe60.b7f8a1a","type":"ui_template","z":"c7bb51ea.b7706","group":"1d6cbfef.15f53","name":"48 hours forecast","order":2,"width":"16","height":"20","format":"<table>\n  <tr>\n    <th>U</th>\n    <th>T</th>\n    <th>regen</th>\n    <th>wind</th>\n    <th>uv</th>\n    <th>beschrijving</th>\n    </tr>\n  <tr ng-repeat=\"x in msg.payload.forecasts\">\n    <td>{{ x.fcst_valid_local | date : \"H\" }}u</td>\n    <td>{{ x.temp }}°C</td>\n    <td>{{ x.pop }}% ({{ x.qpf }}mm)</td>\n    <td>{{ x.wspd }}km/u </td>\n    <td>{{ x.uv_index_raw | number : 2 }} [{{x.uv_index}}:{{x.uv_desc}}]</td>\n    <td>{{ x.phrase_32char }}</td>\n  </tr>\n</table>\n","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":387,"y":683,"wires":[[]]},{"id":"e9ae383e.a70218","type":"comment","z":"c7bb51ea.b7706","name":"retrieve 48 hours forecast  from the weather company","info":"","x":225,"y":527,"wires":[]},{"id":"b623823a.8072a","type":"comment","z":"c7bb51ea.b7706","name":"Read me","info":"This charting example extends node-red-dashboard and the work by Colin Law here:\nhttp://flows.nodered.org/flow/c3dc75c47323a2754f5285225bce64b5\n\nView the chart at http://localhost:1880/ui\n\nBoth the dashboard chart and Colin's example uses time as the X-axis. The example\nhere uses an integer as the x-axis. Colin's example uses Chart.js inside a\nnode-red-dashboard template node. The example here leaves Colin's code almost \nunchanged except that the chart.js XAxis is changed from:\n\n                xAxes: [{\n                    type: 'time',\n                    time: {\n                        unit: 'minute',\n                        unitStepSize: 1,\n                        displayFormats: {\n                            minute: 'HH:mm'\n                        }\n                    }\n                }],\n\nto this:\n              xAxes: [{\n                    type: 'linear',\n                    position: 'bottom'\n                    }\n                ],\n                \nI also adjusted the way the nodes are rendered.\n\nThis example pre-prepares the data object and uses the msg.action = \"load\" \nmethod to ask the template code to render the data. \n\nA dashboard button on the UI page generates fresh data with a different \nscale each time.\n\n\n","x":127,"y":751,"wires":[]},{"id":"133b5cb1.236da3","type":"ui_template","z":"c7bb51ea.b7706","group":"355d00d6.9da31","name":"forecast chart","order":3,"width":"9","height":"8","format":"<!-- See the read me comment node. Colin Law's original notes follow -->\n\n<!--\nA node-red Dashboard UI template to draw charts using chart.js\nBefore use download the file Chart.bundle.min.js from chartjs.org and \nsave in an appropriate folder (e.g. .node-red/static). \nIn settings.js set httpStatic to the full path of that folder and restart node-red.\nMake sure that the options for 'Pass through messages' and 'Add output messages' \nin this node are cleared.\nFor basic use set the id and size you want in the canvas tag and set chartID to the id\nSetup chartDef as required for your chart (see the chart.js docs)\nIn addition, for each dataset specify in chartDef the message topic that you will use for that channel.\nTo (optionally) provide the chart with a one-off set of data send the node a message with:\nmsg.action = \"load\"\nmsg.payload = [\n{topic: \"mytopic1\", data: [{x: x1,y:y2},{x:x2,y:y2},...]},\n{topic: \"mytopic2\", data: [{x: x1,y:y2},{x:x2,y:y2},...]},\n...]\nWhere mytopic1 and mytopic2 are the the topics specified in the chartDef\n\nTo provide the chart with data incrementally (for a time series for example)\nsend it messages of the form\n{topic: \"mytopic1\", payload: {x:xvalue,y:yvalue}}\nThe chart will be updated as each sample is provided.\nTo limit the growth of the chart set chartMaxPoints and/or chartTimeSpan in the Chart Helper node\nas described at the head of that node.\nIf you find that chart seems to flicker and scroll bars come and go then try \nsetting a size other than auto in the Size specification for this node.\n\nFor Bar charts the x value is the label for the bar and the y value is the bar value\n\nNote that since the chart samples are stored in the browser then the chart will be cleared each\ntime the browser is refreshed (and will be clear on initially opening the view). In order to \nprovided persistency over browser opening and refresh this node may be used in conjunction with\nthe Chart Helper function node.  Details for its use are in the source of that node.\n\nIf your flow includes more that one instance of this script then the line fetching \nChart.bundle.min.js need only be included in one of them\n-->\n\n<script src=\"/Chart.bundle.min.js\"></script>\n<canvas id=\"myChartSimple1\" width=\"500\" height=\"420\"></canvas>\n<script>\n(function() {\n    var chartID = \"myChartSimple1\";           // set this to the id you have specified in the canvas tag above\n    // setup the chart definition as defined in the chart.js documentation, in addition setting up the topic\n    // for each channel\n    var chartDef = {\n        type: 'line',\n        data: {\n            datasets: [{\n                topic: \"temp\",    // used here not by chart.js\n                label: \"temp\",\n                yAxisID: \"1\",\n                fill: false,\n                lineTension: 0,\n                borderColor: \"#0000ff\",\n                pointRadius: 0,\n                pointHoverRadius: 5,\n                pointBorderColor: \"#0000ff\",\n                pointBackgroundColor: \"#0000ff\",\n                backgroundColor:  \"#0000ff\",\n                borderWidth: 1,\n                data: []  // data is written here later\n            }, {\n                topic: \"qpf\",    // used here not by chart.js\n                label: \"rain\",\n                yAxisID: \"2\",\n                fill: false,\n                lineTension: 0,\n                borderColor: \"#ff0000\",\n                pointRadius: 0,\n                pointHoverRadius: 5,\n                pointBorderColor: \"#ff0000\",\n                pointBackgroundColor: \"#ff0000\",\n                backgroundColor:  \"#ff0000\",\n                borderWidth: 1,\n                data: []  // data is written here later\n            }]\n        },\n        options: {\n            scales: {\n                xAxes: [{\n                    type: 'time',  // was 'linear'\n                    position: 'bottom'\n                    }\n                ],\n                yAxes: [{\n                    position: \"left\",\n                    id: \"1\",\n                    ticks: {\n                        min: -5,\n                        max: 30,\n                        stepSize:5\n                    },\n                    scaleLabel: {\n                      display: true,\n                      labelString: 'temp °C'\n                    }\n                }, {\n                    position: \"right\",\n                    id: \"2\",\n                    ticks: {\n                        min: 0,\n                        max: 2,\n                        stepSize: 0.5\n                    },\n                    scaleLabel: {\n                      display: true,\n                      labelString: 'regen mm/u'\n                    }\n                }]\n            },\n            animation: {\n                duration: 0\n            }\n        }\n    }\n        \n/***** You shouldn't normally need to change anything below here *****/    \n    var myChart = null;\n    var loaded = false;     // indicates whether we have already had a load action\n    var chartTimeSpan;\n    var chartMaxPoints = 48;  // JVA set to 48.\n\n    function doChart(msg, scope) {\n        if (!myChart) {\n            // chart does not exist so load the data and create it\n            var ctx = document.getElementById(chartID);\n            myChart = new Chart(ctx, chartDef);     \n        }\n        // chart already exists, update it\n        var datasets = myChart.data.datasets;\n        // is this a load or preload action?\n        if (msg.action === \"load\" || msg.action === \"preload\") {\n            // yes, do not allow preload if we have already had a load\n            // so do it if this is a load or we have not previously had a load\n            if (msg.action === \"load\" || !loaded) {\n                // pick up chartTimeSpan and chartMaxPoints if they have been provided\n                if (typeof msg.chartTimeSpan != 'undefined') {\n                    chartTimeSpan = msg.chartTimeSpan;\n                }\n                if (typeof msg.chartMaxPoints != 'undefined') {\n                    chartMaxPoints = msg.chartMaxPoints;\n                }\n                    \n                // replace existing data for matching topics\n                for (var j = 0; j < msg.payload.length; j++) {\n                    var topic = msg.payload[j].topic;\n                    // find it in the chart\n                    for (var i = 0; i < datasets.length; i++) {\n                        if (datasets[i].topic == topic) {\n                            // if stripping old samples by time is required then ensure the x value is Date\n                            if (chartTimeSpan > 0 ) {\n                                var data = msg.payload[j].data;\n                                for (var k = 0; k < data.length; k++) {\n                                    if (typeof data[k].x === \"string\") {\n                                        data[k].x = new Date(data[k].x);\n                                    }\n                                }\n                            }\n                            if (chartDef.type !== \"bar\") {\n                                datasets[i].data = msg.payload[j].data;\n                            } else {\n                                // bar chart so x values must go to labels and y values to dataset\n                                datasets[i].data = [];\n                                myChart.data.labels = [];\n                                var data = msg.payload[j].data;\n                                for (var k = 0; k < data.length; k++) {\n                                    datasets[i].data.push(data[k].y);\n                                    myChart.data.labels.push(data[k].x);\n                                }\n                            }\n                            break;\n                        }\n                    }\n                }\n            }\n            if (msg.action === \"load\") loaded = true;\n            myChart.update();\n        } else {\n            // does the topic match one of the datasets?\n            for (var i = 0; i < datasets.length; i++) {\n                if (datasets[i].topic == msg.topic) {\n                    // if stripping old samples by time is required then ensure the x value is Date\n                    if (chartTimeSpan > 0 && typeof msg.payload.x === \"string\") {\n                        msg.payload.x = new Date(msg.payload.x);\n                    }\n                    if (chartDef.type !== \"bar\") {\n                        datasets[i].data.push(msg.payload);\n                    } else {\n                         // bar chart so x value must go to labels and y value to dataset\n                        datasets[i].data.push(msg.payload.y);\n                        myChart.data.labels.push(msg.payload.x);\n                    }\n                    myChart.update();\n                    break;\n                }\n            }\n        }\n        // strip off samples older than now\n        // charTimeSpan == 0 implies don't do it\n        var shifted = false;\n        if (chartTimeSpan > 0) {\n            var now = new Date();\n            var oldestTimeAllowed = now - chartTimeSpan;\n            for (var i = 0; i < datasets.length; i++) {\n                dataset = datasets[i];\n                while(dataset.data[0] && getTime(dataset.data[0].x) < oldestTimeAllowed) {\n                    dataset.data.shift();\n                    shifted = true;\n                }\n            }\n        }\n        // strip samples off the front if there are now too many\n        // charTimeSpan == 0 implies don't do it\n        if (chartMaxPoints > 0) {\n            for (var i = 0; i < datasets.length; i++) {\n                dataset = datasets[i];\n                while(dataset.data.length > chartMaxPoints) {\n                    dataset.data.shift();\n                    shifted = true;\n                }\n            }\n        }\n        if (shifted) {\n            myChart.update();\n        }\n    };\n\n    // gets the time of an x value, works for strings or Date types\n    function getTime(x) {\n        if (typeof x === \"string\") x = new Date(x);\n        return x.getTime();\n    }\n    \n    // builds the preload message for sending back to the chart helper\n    function preloadMsg() {\n        var preMsg = {action: \"preload\", payload: \"preload\"};\n        // build array of topics in chart\n        var topics = [];\n        for (var i=0; i<chartDef.data.datasets.length; i++) {\n            topics.push(chartDef.data.datasets[i].topic);\n        }\n        preMsg.topics = topics;\n        // has the chart already been created\n        if (myChart) {\n            preMsg.lastXValue = 1;\n        } else {\n            preMsg.lastXValue = 0;\n        }\n        return preMsg;\n    }\n\n    (function(scope) {\n        // this code gets run when the a view is opened on the node in the browser\n        // send a preload message back to node red to ask it send\n        // us a complete set of data. Pass down max points and time span to the helper node for it to use\n        // plus an array of the topics of interest\n        scope.send( preloadMsg() );\n        \n        scope.$watch('msg', function(msg) {\n            if (msg) {\n                doChart(msg, scope);\n            }\n        });\n    })(scope);\n})();\n</script>\n","storeOutMessages":false,"fwdInMessages":false,"templateScope":"local","x":1106.5499267578125,"y":885.88330078125,"wires":[["2997cb25.ccf3a4","72c159.184d9ea8"]]},{"id":"ca8d26ce.4a6488","type":"split","z":"c7bb51ea.b7706","name":"split array","splt":"\\n","spltType":"str","arraySplt":"1","arraySpltType":"len","stream":false,"addname":"","x":98,"y":872,"wires":[["71a1fcb6.99ea84","d606b5d1.b22538","57776873.11ba48"]]},{"id":"1de5b321.186e2d","type":"change","z":"c7bb51ea.b7706","name":"set last 48hours forecast = msg.payload.forecasts","rules":[{"t":"set","p":"last48hours_forecast","pt":"flow","to":"payload.forecasts","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":478,"y":723,"wires":[["72c159.184d9ea8"]]},{"id":"71a1fcb6.99ea84","type":"debug","z":"c7bb51ea.b7706","name":"forecast element","active":false,"console":"false","complete":"true","x":172,"y":789,"wires":[]},{"id":"48bd29c7.474b48","type":"debug","z":"c7bb51ea.b7706","name":"","active":false,"console":"false","complete":"payload","x":766,"y":760,"wires":[]},{"id":"43809ccd.c5eea4","type":"debug","z":"c7bb51ea.b7706","name":"","active":false,"console":"false","complete":"true","x":565,"y":809,"wires":[]},{"id":"d606b5d1.b22538","type":"function","z":"c7bb51ea.b7706","name":"payload = { x : fcst_valid_local, y : temp }","func":"var forecast_element = msg.payload;\n\nmsg.payload = { \"x\" : forecast_element.fcst_valid_local, \"y\" : forecast_element.temp };\nreturn msg;","outputs":1,"noerr":0,"x":345,"y":849,"wires":[["43809ccd.c5eea4","1ca2d4b.1a6af2b"]]},{"id":"1ca2d4b.1a6af2b","type":"join","z":"c7bb51ea.b7706","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","x":580,"y":850,"wires":[["1d951749.d5b0a9","b7c14ab7.b61fd8"]]},{"id":"1d951749.d5b0a9","type":"debug","z":"c7bb51ea.b7706","name":"array of { x : num, y : temp }","active":true,"console":"false","complete":"true","x":778,"y":795,"wires":[]},{"id":"9724993a.28ce48","type":"function","z":"c7bb51ea.b7706","name":"","func":"//msg.action = \"load\"\n//msg.payload = [\n//{topic: \"mytopic1\", data: [{x: x1,y:y2},{x:x2,y:y2},...]},\n//{topic: \"mytopic2\", data: [{x: x1,y:y2},{x:x2,y:y2},...]},\n//...]\n//Where mytopic1 and mytopic2 are the the topics specified in the chartDef\n\nvar temp_array = msg.payload\n\nmsg.action = \"load\";\nmsg.payload = [ { \"topic\" : msg.topic, \"data\" : temp_array}];\nreturn msg;","outputs":1,"noerr":0,"x":938,"y":886,"wires":[["82b2386d.f1d2e8","133b5cb1.236da3"]]},{"id":"82b2386d.f1d2e8","type":"debug","z":"c7bb51ea.b7706","name":"input chart","active":true,"console":"false","complete":"true","x":1098,"y":945,"wires":[]},{"id":"57776873.11ba48","type":"function","z":"c7bb51ea.b7706","name":"payload = { x : fcst_valid_local, y : qpf }","func":"var forecast_element = msg.payload;\n\nmsg.payload = { \"x\" : forecast_element.fcst_valid_local, \"y\" : forecast_element.qpf};\n\nreturn msg;","outputs":1,"noerr":0,"x":342,"y":904,"wires":[["4eca337f.5276ec"]]},{"id":"4eca337f.5276ec","type":"join","z":"c7bb51ea.b7706","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","x":585,"y":906,"wires":[["11b69d2e.89dbe3"]]},{"id":"b7c14ab7.b61fd8","type":"change","z":"c7bb51ea.b7706","name":"set msg.topic = temp","rules":[{"t":"set","p":"topic","pt":"msg","to":"temp","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":764,"y":850,"wires":[["9724993a.28ce48"]]},{"id":"11b69d2e.89dbe3","type":"change","z":"c7bb51ea.b7706","name":"set msg.topic = qpf","rules":[{"t":"set","p":"topic","pt":"msg","to":"qpf","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":757,"y":905,"wires":[["9724993a.28ce48"]]},{"id":"f16cc427.1c3098","type":"ui_dropdown","z":"c7bb51ea.b7706","name":"","label":"Locatie:","place":"Select option","group":"355d00d6.9da31","order":2,"width":"7","height":"1","passthru":true,"options":[{"label":"","value":"thuis","type":"str"},{"label":"","value":"Camping Suquets","type":"str"},{"label":"","value":"Les Castagnes","type":"str"},{"label":"","value":"Camping Paris Est","type":"str"},{"label":"","value":"Gurgaon","type":"str"}],"payload":"","topic":"","x":78,"y":48,"wires":[["4f4d96bf.dc5fd8"]]},{"id":"e3004da3.3e452","type":"template","z":"c7bb51ea.b7706","name":"set 48 hours forecast url","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"https://twcservice.eu-gb.mybluemix.net/api/weather/v1/geocode/{{payload.lat}}/{{payload.lon}}/forecast/hourly/48hour.json?units=m&language=nl-NL","x":303,"y":580,"wires":[["c542e90.a87cc18","41b16709.9d6518"]]},{"id":"41b16709.9d6518","type":"debug","z":"c7bb51ea.b7706","name":"48 hours forecast url","active":true,"console":"false","complete":"true","x":584,"y":580,"wires":[]},{"id":"4f4d96bf.dc5fd8","type":"switch","z":"c7bb51ea.b7706","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"thuis","vt":"str"},{"t":"eq","v":"Sterre in Graide","vt":"str"},{"t":"eq","v":"Mirko in La Roche en Ardenne","vt":"str"},{"t":"eq","v":"Les Castagnes","vt":"str"},{"t":"eq","v":"Gurgaon","vt":"str"},{"t":"eq","v":"Camping Suquets","vt":"str"},{"t":"eq","v":"Camping Paris Est","vt":"str"}],"checkall":"true","repair":false,"outputs":7,"x":93,"y":136,"wires":[["3b911425.896f6c"],["ac2a74d4.6cac68"],["83098e58.6c601"],["6fa06de3.01b494"],["b3714d2e.aa3a1"],["9917a4ca.aafba8"],["fab1308b.a85e4"]]},{"id":"3b911425.896f6c","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon borsbeek","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"lat\" : 51.189961, \"lon\" : 4.486909 }","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"borsbeek","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":60,"wires":[["be1afd9f.58ecc"]]},{"id":"b630e76a.dafbc8","type":"debug","z":"c7bb51ea.b7706","name":"lat & lon","active":true,"console":"false","complete":"true","x":660,"y":240,"wires":[]},{"id":"83098e58.6c601","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Mirko in La Roche en Ardenne","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"lat\":50.149547,\"lon\":5.523967}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"La Roche en Ardenne","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":140,"wires":[["be1afd9f.58ecc"]]},{"id":"6fa06de3.01b494","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Les Castagnes","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"lat\":43.569159,\"lon\":2.9171882}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Les Castagnes","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":180,"wires":[["79c0098e.082488"]]},{"id":"b3714d2e.aa3a1","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Gurgaon","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"lat\" : 28.424765, \"lon\" : 76.9197342 }","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Gurgaon","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":220,"wires":[["79c0098e.082488"]]},{"id":"32e13c9e.a1bda4","type":"template","z":"c7bb51ea.b7706","name":"set msg.template to buienrader url","field":"template","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<iframe src=\"https://gadgets.buienradar.nl/gadget/zoommap/?lat={{payload.lat}}&lng={{payload.lon}}&overname=2&zoom=13&naam={{topic}}&size=2b&voor=1\" scrolling=no width=330 height=330 frameborder=no></iframe>","x":787,"y":85,"wires":[["d0ca3f77.793e2","2b1b31c3.f2f36e"]]},{"id":"2b1b31c3.f2f36e","type":"debug","z":"c7bb51ea.b7706","name":"buienradar iframe url","active":true,"console":"false","complete":"true","x":963,"y":40,"wires":[]},{"id":"ac76b0d8.6e8f2","type":"template","z":"c7bb51ea.b7706","name":"set msg.url to buienradar rain data","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"https://gpsgadget.buienradar.nl/data/raintext?lat={{payload.lat}}&lon={{payload.lon}}","x":796,"y":175,"wires":[["2de1e37e.b74b2c","7be5e12d.8fe91"]]},{"id":"2de1e37e.b74b2c","type":"debug","z":"c7bb51ea.b7706","name":"buienradar rain data url","active":true,"console":"false","complete":"true","x":977,"y":133,"wires":[]},{"id":"be1afd9f.58ecc","type":"function","z":"c7bb51ea.b7706","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":60,"wires":[["32e13c9e.a1bda4","ac76b0d8.6e8f2","79c0098e.082488"]]},{"id":"f186adbe.881fc","type":"google calendar in","z":"70877b4a.1bbb44","google":"6e76318c.44294","name":"calendar cv","calendar":"cv","offsetType":"at","offsetFrom":"start","offset":"10","offsetUnits":"minutes","x":125,"y":146,"wires":[["4012c9b6.ff1668","dcd01b30.38d958"]]},{"id":"eb774c12.f0811","type":"aggregator","z":"d9c9b8f2.5b1738","name":"mean per minute (consumption)","topic":"consumption","intervalCount":1,"intervalUnits":"m","submitIncompleteInterval":false,"aggregationType":"mean","x":602,"y":139,"wires":[["a783da6.6e28528","4b9cc53.10c463c","d8a983af.8ab99","d8a983af.8ab99"]]},{"id":"c31eb83e.514178","type":"aggregator","z":"d9c9b8f2.5b1738","name":"mean per minute (generation)","topic":"generation","intervalCount":1,"intervalUnits":"m","submitIncompleteInterval":false,"aggregationType":"mean","x":601,"y":219,"wires":[["4b9cc53.10c463c","ac3ac1dc.3beab","b17445a6.346548","ac3ac1dc.3beab"]]},{"id":"d8a983af.8ab99","type":"aggregator","z":"d9c9b8f2.5b1738","name":"mean per 20 minutes (consumption)","topic":"consumption","intervalCount":"20","intervalUnits":"m","submitIncompleteInterval":false,"aggregationType":"mean","x":946,"y":136,"wires":[["45129a3.f9f1f64"]]},{"id":"ac3ac1dc.3beab","type":"aggregator","z":"d9c9b8f2.5b1738","name":"mean per 20 minutes (generation)","topic":"generation","intervalCount":"20","intervalUnits":"m","submitIncompleteInterval":false,"aggregationType":"mean","x":937,"y":218,"wires":[["45129a3.f9f1f64"]]},{"id":"d922ce77.fa1e6","type":"aggregator","z":"e6728257.d2c86","name":"average per hour (kelder)","topic":"kelder","intervalCount":"1","intervalUnits":"h","submitIncompleteInterval":true,"aggregationType":"mean","x":732,"y":696,"wires":[["4a45b2e9.b7deac","3e0f4308.af983c"]]},{"id":"8a6814dc.db93c8","type":"aggregator","z":"e6728257.d2c86","name":"average per hour (buiten)","topic":"buiten","intervalCount":"1","intervalUnits":"h","submitIncompleteInterval":true,"aggregationType":"mean","x":746,"y":810,"wires":[["4a45b2e9.b7deac","75bcc356.11741c"]]},{"id":"28e29493.c44fbc","type":"sqlite","z":"669ca4d9.6412bc","mydb":"d4b7b30a.7abac","name":"nodered_jvda.db","x":1099,"y":102,"wires":[["763154ea.dd94fc"]]},{"id":"a8b1a467.7e2b48","type":"template","z":"669ca4d9.6412bc","name":"create emon_tx insert query","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO emon_tx (total_power, solar_power, voltage, \n                     phase1_power, phase2_power, phase3_power) \nVALUES ({{payload.total_power}} , {{payload.solar_power}} , {{payload.voltage}}, \n        {{payload.phase1_power}}, {{payload.phase2_power}}, {{payload.phase3_power}} );","output":"str","x":845,"y":103,"wires":[["ae41ad54.13038","28e29493.c44fbc"]]},{"id":"ae41ad54.13038","type":"debug","z":"669ca4d9.6412bc","name":"emon_tx insert query","active":false,"console":"false","complete":"true","x":949,"y":55,"wires":[]},{"id":"763154ea.dd94fc","type":"debug","z":"669ca4d9.6412bc","name":"sqlite insert response","active":false,"console":"false","complete":"true","x":1241,"y":58,"wires":[]},{"id":"9917a4ca.aafba8","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Camping Suquets","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"lat\":45.6566681,\"lon\":2.9537524}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Camping Suquets","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":260,"wires":[["79c0098e.082488"]]},{"id":"ac2a74d4.6cac68","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Sterre in Graide","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"lat\":49.9506469, \"lon\" : 5.0462222}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Sterre in Graide","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":100,"wires":[["be1afd9f.58ecc"]]},{"id":"fab1308b.a85e4","type":"change","z":"c7bb51ea.b7706","name":"set lat & lon Malaga","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"lat\":48.8298953,\"lon\":2.4763546}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"Camping Paris Est","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":300,"wires":[["79c0098e.082488"]]},{"id":"2997cb25.ccf3a4","type":"debug","z":"c7bb51ea.b7706","name":"forecast chart","active":true,"console":"false","complete":"true","x":1131,"y":828,"wires":[]},{"id":"72c159.184d9ea8","type":"change","z":"c7bb51ea.b7706","name":"set msg.payload = last 48 hours forecast","rules":[{"t":"set","p":"payload","pt":"msg","to":"last48hours_forecast","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":463,"y":760,"wires":[["ca8d26ce.4a6488","48bd29c7.474b48"]]},{"id":"79c0098e.082488","type":"change","z":"c7bb51ea.b7706","name":"set lat_and_lon = msg.payload","rules":[{"t":"set","p":"lat_and_lon","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":300,"wires":[["20f6961d.3f66ca","b630e76a.dafbc8"]]},{"id":"20f6961d.3f66ca","type":"change","z":"c7bb51ea.b7706","name":"set msg.payload = lat_and_lon","rules":[{"t":"set","p":"payload","pt":"msg","to":"lat_and_lon","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":448,"y":447,"wires":[["e3004da3.3e452"]]},{"id":"fde22079.d90d3","type":"ui_button","z":"c7bb51ea.b7706","name":"","group":"355d00d6.9da31","order":1,"width":"2","height":"1","passthru":false,"label":"refresh","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":155,"y":449,"wires":[["20f6961d.3f66ca"]]},{"id":"d1a1dc8f.963e3","type":"comment","z":"3f0318fd.5897c8","name":"insert in emonTx (old mongodb node)","info":"","x":727,"y":223,"wires":[]},{"id":"853490a9.13c89","type":"comment","z":"3f0318fd.5897c8","name":"count emonTx (old mongodb node)","info":"","x":178,"y":484,"wires":[]},{"id":"b3b8399d.942608","type":"comment","z":"3f0318fd.5897c8","name":"retrieve next batch of 100 from emonTx (mongodb node)","info":"","x":818,"y":503,"wires":[]},{"id":"b7d690a7.29b58","type":"debug","z":"bb5e766d.b0bbe8","name":"stemija slackbot response","active":true,"console":"false","complete":"true","x":1134,"y":480,"wires":[]},{"id":"6da55555.950f6c","type":"watson-conversation-v1","z":"bb5e766d.b0bbe8","name":"stemija conversation","workspaceid":"721a71aa-e930-4ed5-924f-2828abe39845","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/conversation/api","x":346,"y":324,"wires":[["34a4517d.77905e","3c5b3862.aed398"]]},{"id":"34a4517d.77905e","type":"debug","z":"bb5e766d.b0bbe8","name":"stemija conversation output","active":false,"console":"false","complete":"true","x":624,"y":325,"wires":[]},{"id":"7e1cbe81.cfacf","type":"ui_template","z":"ae997a8f.fef6b8","group":"1136228c.3d68bd","name":"google chart","order":0,"width":"20","height":"17","format":"","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":815,"y":726,"wires":[[]]},{"id":"7718e194.d1891","type":"template","z":"ae997a8f.fef6b8","name":"google electr chart","field":"template","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<iframe style=\"width:{{flow.width}}px; height:{{flow.height}}px;\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" \n src=\"https://docs.google.com/spreadsheets/d/e/2PACX-1vSmTHnbj5uZ-QEzY0u-3w1YI5YtvZMs30k4V5c0W5bfv4Orm6rZmblWkUSlwZ_mnxFnBdX7UCD63MGA/pubhtml?gid=16&amp;single=true&amp;widget=true&amp;headers=false\">\n</iframe>","output":"str","x":557,"y":725,"wires":[["7e1cbe81.cfacf"]]},{"id":"bd65bfe2.bfc2e","type":"inject","z":"ae997a8f.fef6b8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":357,"y":724,"wires":[["7718e194.d1891"]]},{"id":"574cee67.72ce6","type":"comment","z":"bb5e766d.b0bbe8","name":"Flow documentation","info":"# **Watson Conversation**\nThe watson conversation **stemija** is defined [here](https://console.bluemix.net/services/conversation/c563bed1-31d9-4922-ad1b-1269fe370283?ace_config=%7B%22region%22%3A%22eu-gb%22%2C%22orgGuid%22%3A%225f75944f-040a-4bf9-af7d-213d7c8073a4%22%2C%22spaceGuid%22%3A%225430e81b-155d-45ee-8727-8070a80ffb70%22%2C%22redirect%22%3A%22https%3A%2F%2Fconsole.bluemix.net%2Fdashboard%2Fapps%3Fenv_id%3Dibm%253Ayp%253Aeu-gb%22%2C%22bluemixUIVersion%22%3A%22Atlas%22%7D&env_id=ibm%3Ayp%3Aeu-gb).\n\n## **Watson Conversation Context**\nThe Watson conversation context for a specific user (session) is stored in the flow context variable ```conversation[<slackuser>]```\nwhere ```<slackuser>``` is the actual slack user ID (e.g. 'U7MTBL5T5' ).\n\nSo whenever a message is received from the stemija slackbot input node:\n-  the watson conversation context is retrieved from the flow context.\n-  if it doesn't exist, then the watson conversation context is created and also stored in the flow context.\n\nThe conversation context exists of following attributes\n- ```slackuser``` : the name of the user as received from slack\n- ```user``` : the actual name of the user.  E.g. 'papa'\n\n## **Watson Conversation Input**\nThe following information is passed as input to the Watson Conversation Node\n- ```msg.user``` =  ```slackuser``` of the  watson conversation context\n- ```msg.params.context``` = watson conversation context\n- ```msg.payload``` = the text that should be interpreted by the watson conversation.\n\n## **Watson Conversation Output**\nThere are 2 possibilities:\n- *simple case*  : the conversation text is immediately directed to the stemija slackbot output node\n- *complex case* : the conversation output is 'processed' by a set of nodes, which might result in any combination of the following:\n  - 0 or more messages being sent to the stemija slackbot output node\n  - updating the watson conversation context and storing it in the flow context\n  - a new input message being sent to the watson conversation node\n\n# **stemija slackbot output node**\n## **Input**\nWhen sending a message to the stemija slackbot output node then\nthe following information must be sent:\n```\nmsg.message = {\"type\":\"message\",\n               \"channel\":\"D7MTEU4TD\",\n               // the user below is papa - this should be replaced by the\n               // appropriate user.\n               \"user\":\"<slackuser of the watson conversation context>\"\"\n               \"source_team\":\"T7N49GNUD\",\n               \"team\":\"T7N49GNUD\",\n               \"event\":\"direct_message\"};\nmsg.payload = \"<actual message to display in slack>\";\n```\n\n","x":95,"y":28,"wires":[]},{"id":"4dc6fbd1.781064","type":"function","z":"bb5e766d.b0bbe8","name":"extend with flow context information","func":"var this_conversation = flow.get('conversation')[msg.slackObj.fromUser];\n\n// check if the slackuser is defined in the flow context.\nif ( typeof this_conversation === 'undefined' ){\n    node.error(\"slackuser: \" + msg.message.user + \" is not yet defined in the flow context 'conversation'\");\n    return null;\n}\n\n// substituted \".\" by \"_\" as otherwise the Watson conversation node gives an error.\n// E.g. msg.user = \"jan.vandenaudenaerde\" will give an error.\nmsg.user = this_conversation.slackuser.replace(\".\",\"_\");\n\nmsg.params = { \"context\": this_conversation };\nreturn msg;","outputs":1,"noerr":0,"x":229,"y":278,"wires":[["cc696a.c8a06698","6da55555.950f6c"]]},{"id":"cc696a.c8a06698","type":"debug","z":"bb5e766d.b0bbe8","name":"extended with flow context information","active":false,"console":"false","complete":"true","x":568,"y":279,"wires":[]},{"id":"a0abc199.348e9","type":"inject","z":"bb5e766d.b0bbe8","name":"only once at start","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":true,"x":128,"y":79,"wires":[["20efaeae.7ddd22"]]},{"id":"20efaeae.7ddd22","type":"function","z":"bb5e766d.b0bbe8","name":"Initialize flow context 'conversation'","func":"// msg.paylaod = true will force the reinitialisation of the context.\n\nvar conversation = flow.get('conversation');\n\nif ( ( typeof conversation === 'undefined' ) || msg.payload ){\n    conversation = { \n        \"jan.vandenaudenaerde\" : { \"slackuser\" : \"jan.vandenaudenaerde\", \"user\" : \"papa\" }\n    };\n    flow.set('conversation',conversation);\n}\n\nmsg.payload = conversation;\n\nreturn msg;","outputs":1,"noerr":0,"x":442,"y":101,"wires":[["937fd33b.500c4"]]},{"id":"937fd33b.500c4","type":"debug","z":"bb5e766d.b0bbe8","name":"flow context 'conversation'","active":true,"console":"false","complete":"payload","x":717,"y":99,"wires":[]},{"id":"a6daa1d1.4c935","type":"inject","z":"bb5e766d.b0bbe8","name":"force reinitialisation","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":false,"x":133,"y":127,"wires":[["20efaeae.7ddd22"]]},{"id":"5935ceb3.74338","type":"change","z":"bb5e766d.b0bbe8","name":"set msg.payload to msg.payload.output.text[0]","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.output.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":446,"y":541,"wires":[["c1a97d0.0b0548"]]},{"id":"1dce89b.bc09b76","type":"switch","z":"bb5e766d.b0bbe8","name":"switch on intent","property":"payload.intents[0].intent","propertyType":"msg","rules":[{"t":"eq","v":"switch-on-cv","vt":"str"},{"t":"eq","v":"switch-off-cv","vt":"str"},{"t":"eq","v":"what-is-the-temperature","vt":"str"},{"t":"else"}],"checkall":"true","outputs":4,"x":120,"y":440,"wires":[["91c09e54.c12d8"],["91c09e54.c12d8"],["904c213e.2f7ed"],["5935ceb3.74338"]]},{"id":"f0c0f219.176c3","type":"link in","z":"7fa2194.bf802e8","name":"verwarming boven","links":["a78c496d.f4e158","25c08f71.7319d"],"x":335,"y":100,"wires":[["1d0f7e65.f0e302"]]},{"id":"a78c496d.f4e158","type":"link out","z":"bb5e766d.b0bbe8","name":"switch on/off cv","links":["f0c0f219.176c3"],"x":595,"y":380,"wires":[]},{"id":"a23fa528.7716c8","type":"link in","z":"7fa2194.bf802e8","name":"verwarming kamer Jade","links":["2004cd5b.b09692","5b26fbdb.f71f74"],"x":335,"y":220,"wires":[["18718203.84a46e"]]},{"id":"5b26fbdb.f71f74","type":"link out","z":"bb5e766d.b0bbe8","name":"","links":["a23fa528.7716c8"],"x":595,"y":420,"wires":[]},{"id":"91c09e54.c12d8","type":"function","z":"bb5e766d.b0bbe8","name":"switch-on-cv / switch-off-cv","func":"// intent can have 2 possible values :\n// - \"switch-on-cv\"\n// - \"switch-off-cv\"  => this will also switch off kamer cv Jade if it is switched on.\nvar intent        = msg.payload.intents[0].intent;\nvar cv_boven      = global.get(\"ui_cv_req_heating_upstairs\");\nvar cv_kamer_jade = global.get(\"ui_cv_req_heating_room_jade\");\n\nvar msg_cv_boven = null;\nvar msg_cv_kamer_jade = null;\n\n// update msg_cv_boven\n// cv_boven on if intent is switch-on-cv and cv boven is not yet on\nif ( (intent==\"switch-on-cv\") && (cv_boven===0)){\n    msg_cv_boven= { \"payload\" : 1 };\n}\n\n// cv_boven off if intent is switch-off-cv and cv boven is on\nif ( (intent==\"switch-off-cv\") && (cv_boven===1)){\n    msg_cv_boven= { \"payload\" : 0 };\n}\n\n// update msg_cv_kamer_jade\n// cv_kamer_jade off if intent is switch-off-cv and cv_kamer_jade is on\nif ( (intent==\"switch-off-cv\") && (cv_kamer_jade===1)){\n    msg_cv_kamer_jade= { \"payload\" : 0 };\n}\n\n// update slack message\nif ((msg_cv_boven===null) && (msg_cv_kamer_jade===null)){\n    if (intent==\"switch-off-cv\"){\n        msg.payload = \"De verwarming stond al uit !!\";\n    } else {\n        msg.payload = \"De verwarming stond al aan !!\";\n    }\n} else {\n    // use the text specified by the conversation.\n    msg.payload = msg.payload.output.text[0];\n}\n\nreturn [ msg_cv_boven, msg_cv_kamer_jade, msg];","outputs":"3","noerr":0,"x":401,"y":416,"wires":[["a78c496d.f4e158"],["5b26fbdb.f71f74"],["c1a97d0.0b0548"]],"outputLabels":["cv boven","cv kamer jade","message slack"]},{"id":"c1a97d0.0b0548","type":"function","z":"bb5e766d.b0bbe8","name":"","func":"\nreturn msg;","outputs":1,"noerr":0,"x":947,"y":502,"wires":[["b7d690a7.29b58","29391e8c.3290d2"]]},{"id":"4aa726e3.0945d8","type":"slack","z":"f4083ef1.c832a","name":"#cv channel","username":"pi3one","emojiIcon":"","channel":"","x":1110,"y":320,"wires":[]},{"id":"7d9d7bbb.636644","type":"comment","z":"f4083ef1.c832a","name":"flow documentation","info":"The slack output node makes use of webhook url for the #cv channel that is defined in slack > Manage > Custom Integrations > Incoming WebHooks\n\nA message received from the \"3ch wifi relay\" link  will have the following content\n```{ \nnodegroup:\"5\",\npayload: { cvpump    : msg.payload.relay2 ,\n           ventilator: msg.payload.relay3  }\n};```","x":156,"y":33,"wires":[]},{"id":"c0184b88.84ef08","type":"link in","z":"f4083ef1.c832a","name":"#cv channel","links":["9471dcd1.342ea"],"x":254,"y":152,"wires":[["86b5244d.475148"]]},{"id":"e442864d.09ef58","type":"switch","z":"f4083ef1.c832a","name":"msg.payload.cvpump","property":"payload.cvpump","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":268,"y":364,"wires":[["ef5408fe.995e68"],["8c82f7be.204e98"],["ca54b170.eff06"]]},{"id":"ef5408fe.995e68","type":"change","z":"f4083ef1.c832a","name":"\"De verwarming boven (CV pomp)  is uitgezet.\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"De verwarming boven (CV pomp)  is uitgezet.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":608,"y":315,"wires":[["1650c6a2.63fce9"]]},{"id":"8c82f7be.204e98","type":"change","z":"f4083ef1.c832a","name":"\"De verwarming boven (CV pomp) is aangezet.\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"De verwarming boven (CV pomp) is aangezet.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":606,"y":359,"wires":[["1650c6a2.63fce9"]]},{"id":"ca54b170.eff06","type":"change","z":"f4083ef1.c832a","name":"\"error - onverwachte status\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"error - onverwachte status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":549,"y":407,"wires":[["4aa726e3.0945d8"]]},{"id":"86b5244d.475148","type":"switch","z":"f4083ef1.c832a","name":"cvpump status changed ?","property":"last_cvpump_status","propertyType":"flow","rules":[{"t":"neq","v":"payload.cvpump","vt":"msg"}],"checkall":"true","outputs":1,"x":423,"y":173,"wires":[["75a21735.e1cd18"]]},{"id":"75a21735.e1cd18","type":"change","z":"f4083ef1.c832a","name":"flow.last_cvpump_status = msg.payload.cvpump","rules":[{"t":"set","p":"last_cvpump_status","pt":"flow","to":"payload.cvpump","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":356,"y":231,"wires":[["e442864d.09ef58"]]},{"id":"e7084c88.42158","type":"inject","z":"f4083ef1.c832a","name":"\"Node-RED redeployed - we veronderstellen dat de verwarming boven (CV pomp) was uitgezet.\"","topic":"","payload":"Node-RED redeployed - we veronderstellen dat de verwarming boven (CV pomp) was uitgezet.","payloadType":"str","repeat":"","crontab":"","once":true,"x":423,"y":89,"wires":[["66cdb9f1.de6458","1650c6a2.63fce9"]]},{"id":"66cdb9f1.de6458","type":"change","z":"f4083ef1.c832a","name":"set flow.last_cvpump_status = 0","rules":[{"t":"set","p":"last_cvpump_status","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":932,"y":88,"wires":[[]]},{"id":"83763b3a.ad95a8","type":"change","z":"7fa2194.bf802e8","name":"set global.temp_room_badkamer = msg.payload.temp","rules":[{"t":"set","p":"temp_room_badkamer","pt":"global","to":"payload.temp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":697,"wires":[[]]},{"id":"1650c6a2.63fce9","type":"function","z":"f4083ef1.c832a","name":"append temp's","func":"var temp_room_jade = global.get (\"temp_room_jade\");\nvar temp_room_badkamer = global.get (\"temp_room_badkamer\");\nvar temp_outside = global.get(\"outside_temp\");\nvar temp_living = global.get(\"living_temp\");\n\nmsg.payload += \" [T kamer Jade = \" + temp_room_jade + \"°, T badkamer = \"   + temp_room_badkamer + \"°, T living = \" + temp_living + \"°, T buiten =\" + temp_outside + \"°]\";\n\nreturn msg;","outputs":1,"noerr":0,"x":868,"y":218,"wires":[["4aa726e3.0945d8"]]},{"id":"8f2ecca3.4757","type":"change","z":"cbb123e.ff1e2e","name":"global.living_temp = msg.payload.temperature","rules":[{"t":"set","p":"living_temp","pt":"global","to":"payload.temperature","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":484.0000305175781,"y":145,"wires":[[]]},{"id":"d84148fb.4f7bd8","type":"function","z":"bb5e766d.b0bbe8","name":"append temperatures","func":"var temp_room_jade = global.get (\"temp_room_jade\");\nvar temp_room_badkamer = global.get (\"temp_room_badkamer\");\nvar temp_outside = global.get(\"outside_temp\");\nvar temp_living = global.get(\"living_temp\");\n\nmsg.payload += \" [T kamer Jade = \" + temp_room_jade + \"°, T badkamer = \"   + temp_room_badkamer + \"°, T living = \" + temp_living + \"°, T buiten =\" + temp_outside + \"°]\";\n\nreturn msg;","outputs":1,"noerr":0,"x":748,"y":487,"wires":[["c1a97d0.0b0548"]]},{"id":"904c213e.2f7ed","type":"change","z":"bb5e766d.b0bbe8","name":"set msg.payload = payload.output.text[0]","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.output.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":426,"y":487,"wires":[["d84148fb.4f7bd8"]]},{"id":"4569258b.08eaec","type":"Slack Bot In","z":"bb5e766d.b0bbe8","name":"pi3one slackbot","channel":"","x":80,"y":180,"wires":[["ce37432.fc86cc","a98118c1.02cca8"]]},{"id":"ce37432.fc86cc","type":"debug","z":"bb5e766d.b0bbe8","name":"bot in message","active":true,"console":"false","complete":"true","x":263,"y":161,"wires":[]},{"id":"29391e8c.3290d2","type":"Slack Bot Out","z":"bb5e766d.b0bbe8","name":"pi3one slackbot response","channel":"","x":1133.5,"y":521,"wires":[]},{"id":"a98118c1.02cca8","type":"switch","z":"bb5e766d.b0bbe8","name":"msg.slackObj.fromUser != \"\"","property":"slackObj.fromUser","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":220,"y":220,"wires":[["7cf27106.d9962"]]},{"id":"7cf27106.d9962","type":"switch","z":"bb5e766d.b0bbe8","name":"switch on channel","property":"slackObj.channelName","propertyType":"msg","rules":[{"t":"eq","v":"cloudspeech","vt":"str"},{"t":"eq","v":"general","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":470,"y":220,"wires":[["c4ec279f.6d7698"],[],["4dc6fbd1.781064"]]},{"id":"adda148e.6ee598","type":"trigger","z":"669ca4d9.6412bc","op1":"","op2":"No message received from emonTh - node23 (kamer Jade) in last hour (replace batteries) !!","op1type":"nul","op2type":"str","duration":"1","extend":true,"units":"hr","reset":"","bytopic":"all","name":"no message received from emonTh - node23","x":470,"y":320,"wires":[["c04eef95.295"]]},{"id":"863b71a9.c250c","type":"trigger","z":"669ca4d9.6412bc","op1":"","op2":"No message received from emonTh - node24 (badkamer) in last hour (replace batteries) !!","op1type":"nul","op2type":"str","duration":"1","extend":true,"units":"hr","reset":"","name":"no message received from emonTh - node 24","x":470,"y":360,"wires":[["c04eef95.295"]]},{"id":"311d01e6.9609ce","type":"link in","z":"f4083ef1.c832a","name":"to slack #cv channel","links":["c04eef95.295"],"x":935,"y":400,"wires":[["4aa726e3.0945d8"]]},{"id":"c04eef95.295","type":"link out","z":"669ca4d9.6412bc","name":"","links":["311d01e6.9609ce"],"x":735,"y":340,"wires":[]},{"id":"1c75ca3d.8544a6","type":"inject","z":"669ca4d9.6412bc","name":"trigger every 6 hours","topic":"","payload":"true","payloadType":"bool","repeat":"21600","crontab":"","once":false,"onceDelay":"","x":140,"y":340,"wires":[["adda148e.6ee598","863b71a9.c250c"]]},{"id":"71527b7f.ddaaa4","type":"debug","z":"fed72f15.8d836","name":"change of unknown MACs","active":true,"console":"false","complete":"true","x":770,"y":280,"wires":[]},{"id":"1d24869d.fdf609","type":"split","z":"fed72f15.8d836","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":670,"y":340,"wires":[["81e282f7.5f3f5","e7ee8eea.efbb7"]]},{"id":"81e282f7.5f3f5","type":"function","z":"fed72f15.8d836","name":"connect / disconnect message","func":"msg.payload = msg.parts.key + ( msg.payload ? \" connected to LAN\" : \" got disconnected\" );\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":380,"wires":[["54725ed7.fddb9","9e09077e.2e9f28"]]},{"id":"e7ee8eea.efbb7","type":"debug","z":"fed72f15.8d836","name":"splitted message","active":true,"console":"false","complete":"true","x":850,"y":340,"wires":[]},{"id":"54725ed7.fddb9","type":"debug","z":"fed72f15.8d836","name":"connect / disconnect message","active":true,"console":"false","complete":"true","x":1130,"y":340,"wires":[]},{"id":"9e09077e.2e9f28","type":"slack","z":"fed72f15.8d836","name":"#lan connect","username":"stemija","emojiIcon":"","channel":"#lan-connect","x":1109,"y":442,"wires":[]},{"id":"3a025ec0.007822","type":"ui_template","z":"7fa2194.bf802e8","group":"33c793c6.f46c9c","name":"emoncms chart","order":0,"width":0,"height":0,"format":"","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":660,"y":820,"wires":[[]]},{"id":"1166bd30.80e053","type":"mqtt in","z":"604db05c.f6f11","name":"","topic":"pi3/aiy/google_assistant/text","qos":"0","broker":"c155bcf2.3fab9","x":180,"y":40,"wires":[["4daefe86.b63","e0567356.edce5"]]},{"id":"4daefe86.b63","type":"debug","z":"604db05c.f6f11","name":"","active":true,"console":"false","complete":"true","x":410,"y":40,"wires":[]},{"id":"38db8e12.809822","type":"mqtt out","z":"604db05c.f6f11","name":"","topic":"pi3/aiy/google_assistant/text","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":380,"y":420,"wires":[]},{"id":"def956ec.e32768","type":"inject","z":"604db05c.f6f11","name":"","topic":"","payload":"\"This is a test\"","payloadType":"str","repeat":"","crontab":"","once":false,"x":150,"y":420,"wires":[["38db8e12.809822"]]},{"id":"c4ec279f.6d7698","type":"debug","z":"bb5e766d.b0bbe8","name":"cloudspeech channel","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":860,"y":160,"wires":[]},{"id":"44b7ea45.9afb34","type":"mqtt out","z":"bb5e766d.b0bbe8","name":"","topic":"pi3/tts","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":819,"y":213,"wires":[]},{"id":"e0567356.edce5","type":"slack","z":"604db05c.f6f11","name":"#gassist","username":"stemija","emojiIcon":"","channel":"#gassist","x":420,"y":100,"wires":[]},{"id":"c5aa492.4e0adb8","type":"ui_switch","z":"56164435.31050c","name":"","label":"activate","group":"2fdf50c.264aab","order":1,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"switch_on","onvalueType":"str","onicon":"","oncolor":"","offvalue":"switch_off","offvalueType":"str","officon":"","offcolor":"","x":860,"y":1220,"wires":[["99ab9eab.00f4f"]]},{"id":"2a168c1d.4c3174","type":"ui_text","z":"56164435.31050c","group":"fe02baf8.ead938","order":4,"width":0,"height":0,"name":"","label":"last message","format":"{{msg.payload}}","layout":"col-center","x":790,"y":820,"wires":[]},{"id":"6e348314.00676c","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/text","qos":"0","broker":"c155bcf2.3fab9","x":160,"y":820,"wires":[["2a168c1d.4c3174"]]},{"id":"4a2333af.0e1d7c","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/text","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":550,"y":900,"wires":[]},{"id":"a611e6b1.9f8da8","type":"inject","z":"56164435.31050c","name":"","topic":"","payload":"This is a test message","payloadType":"str","repeat":"","crontab":"","once":false,"x":220,"y":900,"wires":[["4a2333af.0e1d7c"]]},{"id":"2aba9948.131da6","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/cmd","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":990,"y":660,"wires":[]},{"id":"c1385050.3c0ef","type":"inject","z":"56164435.31050c","name":"get_status every 2 minutes","topic":"","payload":"get_status","payloadType":"str","repeat":"120","crontab":"","once":true,"onceDelay":"","x":220,"y":1080,"wires":[["97e565f7.8ae578","a91b054.f88cff8"]]},{"id":"801c7d0f.3a7f7","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/cmd","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":430,"y":540,"wires":[]},{"id":"fa793d95.2b5cd","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/status","qos":"2","broker":"c155bcf2.3fab9","x":170,"y":700,"wires":[["61e5537e.f38e7c","f3aa61ed.70902"]]},{"id":"61e5537e.f38e7c","type":"debug","z":"56164435.31050c","name":"","active":true,"console":"false","complete":"true","x":310,"y":660,"wires":[]},{"id":"3d601f48.17e8f","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/google_assistant/status","qos":"0","broker":"c155bcf2.3fab9","x":210,"y":1340,"wires":[["7a7a85d.272ca7c","671dbdfa.eb1704","6c3229a5.f5a138"]]},{"id":"7a7a85d.272ca7c","type":"debug","z":"56164435.31050c","name":"","active":true,"console":"false","complete":"true","x":230,"y":1260,"wires":[]},{"id":"97e565f7.8ae578","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/google_assistant/cmd","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":520,"y":1080,"wires":[]},{"id":"99ab9eab.00f4f","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/google_assistant/cmd","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":1120,"y":1220,"wires":[]},{"id":"2ec125a3.1e542a","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/google_assistant/event_type","qos":"0","broker":"c155bcf2.3fab9","x":220,"y":1400,"wires":[["8d3114b0.ec8ef8","bf052afb.a7b168"]]},{"id":"136e5be9.8be484","type":"ui_text","z":"56164435.31050c","group":"2fdf50c.264aab","order":3,"width":0,"height":0,"name":"","label":"event type","format":"{{msg.payload}}","layout":"row-spread","x":770,"y":1400,"wires":[]},{"id":"c767ba06.4c81b8","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/cloudspeech/event_type","qos":"0","broker":"c155bcf2.3fab9","x":170,"y":760,"wires":[["ab7b5c9e.eec7f","64373009.fbe36"]]},{"id":"ab7b5c9e.eec7f","type":"ui_text","z":"56164435.31050c","group":"fe02baf8.ead938","order":3,"width":0,"height":0,"name":"","label":"event type","format":"{{msg.payload}}","layout":"row-spread","x":790,"y":760,"wires":[]},{"id":"7ec9a548.7bcaec","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/google_assistant/text","qos":"0","broker":"c155bcf2.3fab9","x":200,"y":1480,"wires":[["91a8c94.53fe038"]]},{"id":"91a8c94.53fe038","type":"ui_text","z":"56164435.31050c","group":"2fdf50c.264aab","order":4,"width":0,"height":0,"name":"","label":"last message","format":"{{msg.payload}}","layout":"row-spread","x":770,"y":1480,"wires":[]},{"id":"37fd27a5.d68dc8","type":"mqtt in","z":"604db05c.f6f11","name":"","topic":"pi3/aiy/cloudspeech/text","qos":"0","broker":"c155bcf2.3fab9","x":160,"y":220,"wires":[["5152c651.e79258","90fd250b.3d8a98"]]},{"id":"5152c651.e79258","type":"debug","z":"604db05c.f6f11","name":"","active":true,"console":"false","complete":"true","x":410,"y":220,"wires":[]},{"id":"90fd250b.3d8a98","type":"slack","z":"604db05c.f6f11","name":"#cloudspeech","username":"aiy_voice_kit","emojiIcon":"","channel":"#cloudspeech","x":440,"y":280,"wires":[]},{"id":"81080bba.3b0818","type":"ui_text","z":"56164435.31050c","group":"2fdf50c.264aab","order":2,"width":0,"height":0,"name":"","label":"status","format":"{{msg.payload}}","layout":"row-spread","x":790,"y":1340,"wires":[]},{"id":"2a2b65db.381b7a","type":"ui_text","z":"56164435.31050c","group":"fe02baf8.ead938","order":1,"width":0,"height":0,"name":"","label":"status","format":"{{msg.payload}}","layout":"row-spread","x":770,"y":700,"wires":[]},{"id":"b5807814.3bed68","type":"comment","z":"56164435.31050c","name":"stemija UI group","info":"","x":260,"y":500,"wires":[]},{"id":"c98e3f44.5eb34","type":"comment","z":"56164435.31050c","name":"OK google UI group","info":"","x":290,"y":1020,"wires":[]},{"id":"a91b054.f88cff8","type":"change","z":"56164435.31050c","name":"msg.payload = awaiting","rules":[{"t":"set","p":"payload","pt":"msg","to":"awaiting","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1160,"wires":[["252612a0.8571fe"]]},{"id":"fc2ac217.af4b9","type":"inject","z":"56164435.31050c","name":"get_status every 2 minutes","topic":"","payload":"get_status","payloadType":"str","repeat":"120","crontab":"","once":true,"onceDelay":"","x":160,"y":540,"wires":[["801c7d0f.3a7f7","a3348258.bce44"]]},{"id":"a3348258.bce44","type":"change","z":"56164435.31050c","name":"msg.payload = awaiting","rules":[{"t":"set","p":"payload","pt":"msg","to":"awaiting","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":600,"wires":[["9c171a62.858158"]]},{"id":"8d3114b0.ec8ef8","type":"change","z":"56164435.31050c","name":"remove EventType.","rules":[{"t":"change","p":"payload","pt":"msg","from":"EventType.","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":1400,"wires":[["136e5be9.8be484"]]},{"id":"3c5b3862.aed398","type":"switch","z":"bb5e766d.b0bbe8","name":"switch on having intent","property":"$count(payload.intents)","propertyType":"jsonata","rules":[{"t":"neq","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","outputs":2,"x":140,"y":360,"wires":[["1dce89b.bc09b76"],["5935ceb3.74338"]],"outputLabels":["has intent","otherwise"]},{"id":"ffb35375.6824f","type":"switch","z":"4bf9468a.f3a898","name":"valid payload","property":"(payload.humidity=0) and (payload.pressure=0) and (payload.temperature=0)","propertyType":"jsonata","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":140,"wires":[["ac5f42fb.19a7d"],["285e9509.acc27a"]],"outputLabels":["is valid","is not valid"]},{"id":"285e9509.acc27a","type":"debug","z":"4bf9468a.f3a898","name":"bme280 invalid data","active":true,"console":"true","complete":"true","x":340,"y":240,"wires":[]},{"id":"27969714.0bdc28","type":"watson-conversation-v1","z":"19233749.06c6d9","name":"IBM conversation \"aiy dutch\"","workspaceid":"516e235f-c9ac-4003-aed3-0bf0b079074e","multiuser":true,"context":false,"empty-payload":true,"default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/conversation/api","x":240,"y":280,"wires":[["cf2ce433.8df668","96f59b32.12ef68"]]},{"id":"cf2ce433.8df668","type":"debug","z":"19233749.06c6d9","name":"stemija conversation output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":640,"y":280,"wires":[]},{"id":"c4991276.0537e","type":"switch","z":"19233749.06c6d9","name":"switch on intent","property":"payload.intents[0].intent","propertyType":"msg","rules":[{"t":"eq","v":"heating_on","vt":"str"},{"t":"eq","v":"heating_off","vt":"str"},{"t":"eq","v":"heating_state","vt":"str"},{"t":"eq","v":"timer-set","vt":"str"},{"t":"eq","v":"timer-stop","vt":"str"},{"t":"eq","v":"radio-news","vt":"str"},{"t":"eq","v":"louder","vt":"str"},{"t":"eq","v":"too-loud","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":9,"x":180,"y":520,"wires":[["d4155776.5f7d28"],["d4155776.5f7d28"],["3948abb0.643d84"],["74a15351.8ce6ac"],["3948abb0.643d84","5e490836.b50ed8"],["7d0af305.daab0c","3948abb0.643d84"],["537ee897.6f0638","3948abb0.643d84"],["5a43155f.45ba4c","3948abb0.643d84"],["3948abb0.643d84"]]},{"id":"2004cd5b.b09692","type":"link out","z":"19233749.06c6d9","name":"","links":["a23fa528.7716c8"],"x":595,"y":460,"wires":[]},{"id":"d4155776.5f7d28","type":"function","z":"19233749.06c6d9","name":"#heating-on / #heating-off","func":"// intent can have 2 possible values :\n// - \"heating_on\"\n// - \"heating_off\"  => this will also switch off kamer cv Jade if it is switched on.\nvar intent        = msg.payload.intents[0].intent;\nvar cv_boven      = global.get(\"ui_cv_req_heating_upstairs\");\nvar cv_kamer_jade = global.get(\"ui_cv_req_heating_room_jade\");\n\nvar msg_cv_boven = null;\nvar msg_cv_kamer_jade = null;\n\n// update msg_cv_boven\n// cv_boven on if intent is heating_on and cv boven is not yet on\nif ( (intent==\"heating_on\") && (cv_boven===0)){\n    msg_cv_boven= { \"payload\" : 1 };\n}\n\n// cv_boven off if intent is heating_off and cv boven is on\nif ( (intent==\"heating_off\") && (cv_boven===1)){\n    msg_cv_boven= { \"payload\" : 0 };\n}\n\n// update msg_cv_kamer_jade\n// cv_kamer_jade off if intent is heating_off and cv_kamer_jade is on\nif ( (intent==\"heating_off\") && (cv_kamer_jade===1)){\n    msg_cv_kamer_jade= { \"payload\" : 0 };\n}\n\n// update conversation message.\nif ((msg_cv_boven===null) && (msg_cv_kamer_jade===null)){\n    if (intent==\"heating_off\"){\n        msg.payload.output.text[0] = \"De verwarming stond al uit.\";\n    } else {\n        msg.payload.output.text[0] = \"De verwarming stond al aan.\";\n    }\n} \n\nreturn [ msg_cv_boven, msg_cv_kamer_jade, msg];","outputs":"3","noerr":0,"x":430,"y":460,"wires":[["25c08f71.7319d"],["2004cd5b.b09692"],["3948abb0.643d84"]],"outputLabels":["cv boven","cv kamer jade","message slack"]},{"id":"7f20b78e.f8b118","type":"Slack Bot In","z":"19233749.06c6d9","name":"stemija slackbot","channel":"","x":100,"y":100,"wires":[["956ab528.96e558","7cd3c8.67ebfc38"]]},{"id":"956ab528.96e558","type":"debug","z":"19233749.06c6d9","name":"bot in message","active":true,"console":"false","complete":"true","x":300,"y":100,"wires":[]},{"id":"8b5a1ebd.5072a","type":"Slack Bot Out","z":"19233749.06c6d9","name":"stemija slackbot response","channel":"","x":850,"y":620,"wires":[]},{"id":"7cd3c8.67ebfc38","type":"switch","z":"19233749.06c6d9","name":"msg on cloudspeech channel ?","property":"slackObj.channelName","propertyType":"msg","rules":[{"t":"eq","v":"cloudspeech","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":160,"wires":[["1f2218b6.0e4c77"]]},{"id":"49528c1e.f32bc4","type":"mqtt out","z":"19233749.06c6d9","name":"","topic":"pi3/tts","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":1090,"y":560,"wires":[]},{"id":"40ed5b91.26d8a4","type":"switch","z":"19233749.06c6d9","name":"switch on having intent","property":"$count(payload.intents)","propertyType":"jsonata","rules":[{"t":"neq","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":220,"y":400,"wires":[["c4991276.0537e"],["3948abb0.643d84"]],"outputLabels":["has intent","otherwise"]},{"id":"3948abb0.643d84","type":"change","z":"19233749.06c6d9","name":"set payload to conversation output","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.output.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":560,"wires":[["2ec10d61.a5b672","8b5a1ebd.5072a"]]},{"id":"a17e02ae.9d97c","type":"inject","z":"604db05c.f6f11","name":"I am daddy","topic":"","payload":"Ik ben papa.","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":340,"wires":[["47010cd9.6fd414"]]},{"id":"47010cd9.6fd414","type":"mqtt out","z":"604db05c.f6f11","name":"","topic":"pi3/aiy/cloudspeech/text","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":370,"y":340,"wires":[]},{"id":"2ec10d61.a5b672","type":"switch","z":"19233749.06c6d9","name":"msg coming from aiy voice kit ?","property":"slackObj.fromUser","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":870,"y":560,"wires":[["49528c1e.f32bc4"]]},{"id":"bfc04cec.8d721","type":"comment","z":"19233749.06c6d9","name":"IBM watson conversation link","info":"https://watson-conversation.ng.bluemix.net/eu-gb/c563bed1-31d9-4922-ad1b-1269fe370283/workspaces/516e235f-c9ac-4003-aed3-0bf0b079074e/build/intents\n\n## Issues\n1. The stemija slackbot is from time to time loosing connection with slack and won't automatically reconnect.  This can be fixed by redeploying the flow.","x":140,"y":40,"wires":[]},{"id":"1f2218b6.0e4c77","type":"change","z":"19233749.06c6d9","name":"set msg.user","rules":[{"t":"set","p":"user","pt":"msg","to":"slackObj.fromUser=\"\"?\t\"aiy_voicekit\":\t$replace(slackObj.fromUser,\".\",\"_\")","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":190,"y":200,"wires":[["e122c8c.fe88b38"]]},{"id":"2606be3e.7c4ad2","type":"debug","z":"19233749.06c6d9","name":"saved flow conversation_context","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":650,"y":320,"wires":[]},{"id":"ae46befb.7677f","type":"inject","z":"9a70cce2.ab388","name":"","topic":"","payload":"hello world","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":80,"wires":[["a7c6e127.dd6ba","32deaadf.4c9846"]]},{"id":"a7c6e127.dd6ba","type":"change","z":"9a70cce2.ab388","name":"","rules":[{"t":"set","p":"context[msg.payload]","pt":"flow","to":"test 1, 2, 3...","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":80,"wires":[["4a719981.450668"]]},{"id":"c8ee9329.b4632","type":"inject","z":"9a70cce2.ab388","name":"","topic":"","payload":"context","payloadType":"flow","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":300,"wires":[["13d79a5e.3a7b96"]]},{"id":"13d79a5e.3a7b96","type":"debug","z":"9a70cce2.ab388","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":350,"y":300,"wires":[]},{"id":"4a719981.450668","type":"debug","z":"9a70cce2.ab388","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":590,"y":80,"wires":[]},{"id":"32deaadf.4c9846","type":"function","z":"9a70cce2.ab388","name":"flow.set(context2[msg.payload],\"testing 3,4,5...\")","func":"var temp={};\nvar temp2={};\n\ntemp[msg.payload] ='testing 3,4,5';\n\nflow.set('context2', temp );\n\nmsg.payload = flow.get('context2')\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":140,"wires":[["f5b52d7b.146de"]]},{"id":"f5b52d7b.146de","type":"debug","z":"9a70cce2.ab388","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":750,"y":140,"wires":[]},{"id":"e122c8c.fe88b38","type":"function","z":"19233749.06c6d9","name":"preparing conversation context for msg.user","func":"var ctx = flow.get('conversation_context');\n\nif (typeof ctx == 'undefined'){ \n    ctx = {};\n}\n\nif (typeof ctx[msg.user] == 'undefined'){\n    ctx[msg.user]={};\n}\n\nctx[msg.user].cv_pump_status = global.get('cv_pump.status');\nctx[msg.user].timezone='Europe/Brussels';\n\nflow.set('conversation_context',ctx);\n\nmsg.params = { 'context' : ctx[msg.user] };\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":240,"wires":[["abb61f5b.21a27","27969714.0bdc28"]]},{"id":"abb61f5b.21a27","type":"debug","z":"19233749.06c6d9","name":"input msg \"aiy dutch\"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":620,"y":240,"wires":[]},{"id":"96f59b32.12ef68","type":"function","z":"19233749.06c6d9","name":"saving conversation context in flow","func":"var ctx = flow.get('conversation_context');\n\nctx[msg.user]=msg.context;\n\nflow.set('conversation_context',ctx);\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":320,"wires":[["2606be3e.7c4ad2","40ed5b91.26d8a4"]]},{"id":"25c08f71.7319d","type":"link out","z":"19233749.06c6d9","name":"","links":["f0c0f219.176c3"],"x":595,"y":420,"wires":[]},{"id":"7336223f.e352fc","type":"comment","z":"56164435.31050c","name":"Snowboy UI Group","info":"","x":330,"y":40,"wires":[]},{"id":"6e54e794.dd7148","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/snowboy/status","qos":"2","broker":"c155bcf2.3fab9","x":200,"y":360,"wires":[["c9e30645.810358","c2ad830b.798ea","bd574f40.f91f2"]]},{"id":"c9e30645.810358","type":"debug","z":"56164435.31050c","name":"","active":true,"console":"false","complete":"true","x":210,"y":220,"wires":[]},{"id":"9a60fa7b.3d71a8","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/aiy/snowboy/event_type","qos":"0","broker":"c155bcf2.3fab9","x":200,"y":420,"wires":[["7584226e.41e0bc"]]},{"id":"a7b1505d.1775d","type":"ui_text","z":"56164435.31050c","group":"db6af561.c39d68","order":2,"width":0,"height":0,"name":"","label":"status","format":"{{msg.payload}}","layout":"row-spread","x":930,"y":360,"wires":[]},{"id":"d4e2d6d0.690398","type":"change","z":"56164435.31050c","name":"msg.payload = awaiting","rules":[{"t":"set","p":"payload","pt":"msg","to":"awaiting","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":160,"wires":[["9e160f21.1fc7c"]]},{"id":"3cb6e694.1d5f4a","type":"inject","z":"56164435.31050c","name":"get_status every 2 minutes","topic":"","payload":"get_status","payloadType":"str","repeat":"120","crontab":"","once":true,"onceDelay":"","x":160,"y":140,"wires":[["d4e2d6d0.690398","61ff198b.69d9f8"]]},{"id":"dc8fe7fe.1cf0b8","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/snowboy/cmd","qos":"0","retain":"false","broker":"c155bcf2.3fab9","x":900,"y":220,"wires":[]},{"id":"61ff198b.69d9f8","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/aiy/snowboy/cmd","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":440,"y":100,"wires":[]},{"id":"758aeb40.2a3e84","type":"ui_switch","z":"56164435.31050c","name":"","label":"activate","group":"db6af561.c39d68","order":1,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"start","onvalueType":"str","onicon":"","oncolor":"","offvalue":"stop","offvalueType":"str","officon":"","offcolor":"","x":720,"y":220,"wires":[["dc8fe7fe.1cf0b8"]]},{"id":"c2ad830b.798ea","type":"switch","z":"56164435.31050c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"started","vt":"str"},{"t":"eq","v":"stopped","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":220,"wires":[["7b557867.3204f8"],["e39bdfff.62fae"]]},{"id":"7b557867.3204f8","type":"change","z":"56164435.31050c","name":"msg.payload = start","rules":[{"t":"set","p":"payload","pt":"msg","to":"start","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":200,"wires":[["758aeb40.2a3e84"]]},{"id":"e39bdfff.62fae","type":"change","z":"56164435.31050c","name":"msg.payload = stop","rules":[{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":240,"wires":[["758aeb40.2a3e84"]]},{"id":"7584226e.41e0bc","type":"ui_toast","z":"56164435.31050c","position":"top left","displayTime":"3","highlight":"","outputs":0,"ok":"OK","cancel":"","topic":"Snowboy","name":"","x":970,"y":420,"wires":[]},{"id":"9e160f21.1fc7c","type":"switch","z":"56164435.31050c","name":"switch on flow.snowboy_status","property":"snowboy_status","propertyType":"flow","rules":[{"t":"eq","v":"awaiting","vt":"str"},{"t":"eq","v":"not responding","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":690,"y":160,"wires":[["9a5aed94.6a97d"],["9a5aed94.6a97d"],["f775b147.15ce4"]]},{"id":"f775b147.15ce4","type":"link out","z":"56164435.31050c","name":"snowboy status polling","links":["5d2048e1.b3e308"],"x":1155,"y":160,"wires":[]},{"id":"5d2048e1.b3e308","type":"link in","z":"56164435.31050c","name":"update snowboy status","links":["f775b147.15ce4"],"x":395,"y":300,"wires":[["bd574f40.f91f2"]]},{"id":"9a5aed94.6a97d","type":"change","z":"56164435.31050c","name":"msg.payload=not responding","rules":[{"t":"set","p":"payload","pt":"msg","to":"not responding","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":140,"wires":[["f775b147.15ce4"]]},{"id":"bd574f40.f91f2","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"snowboy_status","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":360,"wires":[["a7b1505d.1775d","bdfb5efb.b61eb"]]},{"id":"bdfb5efb.b61eb","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"enabled","pt":"msg","to":"payload = \"not responding\" ? 0 : 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":300,"wires":[["758aeb40.2a3e84"]]},{"id":"f61e37e0.8167f8","type":"ui_button","z":"56164435.31050c","name":"speak ...","group":"fe02baf8.ead938","order":2,"width":0,"height":0,"passthru":false,"label":"speak ...","color":"","bgcolor":"","icon":"","payload":"start","payloadType":"str","topic":"","x":780,"y":660,"wires":[["2aba9948.131da6"]]},{"id":"9c171a62.858158","type":"switch","z":"56164435.31050c","name":"switch on flow.cloudspeech_status","property":"cloudspeech_status","propertyType":"flow","rules":[{"t":"eq","v":"awaiting","vt":"str"},{"t":"eq","v":"not responding","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":720,"y":580,"wires":[["c528a726.fd7a18"],["c528a726.fd7a18"],["eff52cbe.48a72"]]},{"id":"c528a726.fd7a18","type":"change","z":"56164435.31050c","name":"msg.payload=not responding","rules":[{"t":"set","p":"payload","pt":"msg","to":"not responding","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":560,"wires":[["eff52cbe.48a72"]]},{"id":"eff52cbe.48a72","type":"link out","z":"56164435.31050c","name":"cloudspeech status polling","links":["c37c6404.601618"],"x":1155,"y":580,"wires":[]},{"id":"c37c6404.601618","type":"link in","z":"56164435.31050c","name":"update cloudspeech status","links":["eff52cbe.48a72"],"x":426,"y":640,"wires":[["f3aa61ed.70902"]]},{"id":"f3aa61ed.70902","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"cloudspeech_status","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":700,"wires":[["2a2b65db.381b7a","fa79a86c.92be18"]]},{"id":"fa79a86c.92be18","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"enabled","pt":"msg","to":"payload = \"not responding\" ? 0 : 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":660,"wires":[["f61e37e0.8167f8"]]},{"id":"64373009.fbe36","type":"switch","z":"56164435.31050c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"listening","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":390,"y":780,"wires":[["55bec918.e5a058"]]},{"id":"55bec918.e5a058","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":780,"wires":[["2a168c1d.4c3174"]]},{"id":"252612a0.8571fe","type":"switch","z":"56164435.31050c","name":"switch on flow.assistant_status","property":"assistant_status","propertyType":"flow","rules":[{"t":"eq","v":"awaiting","vt":"str"},{"t":"eq","v":"not responding","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":770,"y":1160,"wires":[["fb443ae1.59f668"],["fb443ae1.59f668"],["17b99353.44a39d"]]},{"id":"fb443ae1.59f668","type":"change","z":"56164435.31050c","name":"msg.payload=not responding","rules":[{"t":"set","p":"payload","pt":"msg","to":"not responding","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":1080,"wires":[["17b99353.44a39d"]]},{"id":"17b99353.44a39d","type":"link out","z":"56164435.31050c","name":"google assistant status polling","links":["23cfbb70.524cb4"],"x":1215,"y":1120,"wires":[]},{"id":"23cfbb70.524cb4","type":"link in","z":"56164435.31050c","name":"updated google assistant status","links":["17b99353.44a39d"],"x":395,"y":1280,"wires":[["6c3229a5.f5a138"]]},{"id":"671dbdfa.eb1704","type":"switch","z":"56164435.31050c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"enabled","vt":"str"},{"t":"eq","v":"disabled","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":1220,"wires":[["6133c06f.523b5"],["7e7fe703.df8d58"]]},{"id":"6133c06f.523b5","type":"change","z":"56164435.31050c","name":"msg.payload = switch_on","rules":[{"t":"set","p":"payload","pt":"msg","to":"switch_on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":1200,"wires":[["c5aa492.4e0adb8"]]},{"id":"7e7fe703.df8d58","type":"change","z":"56164435.31050c","name":"msg.payload = switch_off","rules":[{"t":"set","p":"payload","pt":"msg","to":"switch_off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":1240,"wires":[["c5aa492.4e0adb8"]]},{"id":"6c3229a5.f5a138","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"assistant_status","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":1340,"wires":[["2400e8c2.03a878","e4562b23.1e3ed8","81080bba.3b0818"]]},{"id":"2400e8c2.03a878","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"enabled","pt":"msg","to":"payload = \"not responding\" ? 0 : 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":1280,"wires":[["c5aa492.4e0adb8"]]},{"id":"e4562b23.1e3ed8","type":"debug","z":"56164435.31050c","name":"status","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":850,"y":1300,"wires":[]},{"id":"bf052afb.a7b168","type":"switch","z":"56164435.31050c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"conv._turn_started","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":410,"y":1440,"wires":[["8818d1fc.dc7bb"]]},{"id":"8818d1fc.dc7bb","type":"change","z":"56164435.31050c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":580,"y":1440,"wires":[["91a8c94.53fe038"]]},{"id":"65d4b083.85ebb","type":"comment","z":"19233749.06c6d9","name":"#timer-set intent handling","info":"timer period range will be checked : between 10 sec and 4 hours.\nif not then error\n\n\n\nif timer is already set then existing timer will be replaced by new timer\n","x":290,"y":660,"wires":[]},{"id":"807f3a0c.ce7e28","type":"switch","z":"19233749.06c6d9","name":"check range","property":"seconds","propertyType":"msg","rules":[{"t":"lt","v":"15","vt":"num"},{"t":"gt","v":"4*60*60","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":490,"y":740,"wires":[["934c74c1.a258b8"],["3984bd68.6e8852"],["f8c40f54.9e35f","e055627.41536a"]]},{"id":"934c74c1.a258b8","type":"change","z":"19233749.06c6d9","name":"\"Timer period too short\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"De timer periode is te kort. ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":720,"wires":[["6559a60c.eb8eb8"]]},{"id":"6559a60c.eb8eb8","type":"link out","z":"19233749.06c6d9","name":"#timer-set output","links":["ad2dd6ec.e6a678"],"x":1015,"y":740,"wires":[]},{"id":"ad2dd6ec.e6a678","type":"link in","z":"19233749.06c6d9","name":"conversation output","links":["6559a60c.eb8eb8"],"x":615,"y":620,"wires":[["2ec10d61.a5b672","8b5a1ebd.5072a"]]},{"id":"3984bd68.6e8852","type":"change","z":"19233749.06c6d9","name":"\"Timer period too long\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"De Timer periode is te lang.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":720,"y":760,"wires":[["6559a60c.eb8eb8"]]},{"id":"588b69b.0d8f598","type":"debug","z":"19233749.06c6d9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1090,"y":800,"wires":[]},{"id":"f8c40f54.9e35f","type":"change","z":"19233749.06c6d9","name":"\"OK, de timer zal afgaan binnen ... seconden\"","rules":[{"t":"set","p":"payload","pt":"msg","to":"'OK, de timer zal afgaan binnen ' & seconds & ' seconden'","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":820,"wires":[["6559a60c.eb8eb8","588b69b.0d8f598"]]},{"id":"76bfaeb9.ac6c8","type":"delay","z":"19233749.06c6d9","name":"timer period","pauseType":"delayv","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":910,"y":880,"wires":[["afa58938.ed0ed8","47f5dd16.950704"]]},{"id":"afa58938.ed0ed8","type":"debug","z":"19233749.06c6d9","name":"timer goes off","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"seconds","x":1140,"y":860,"wires":[]},{"id":"e055627.41536a","type":"change","z":"19233749.06c6d9","name":"msg.payload = \"ring\" & msg.delay = ...","rules":[{"t":"set","p":"delay","pt":"msg","to":"1000*seconds","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"ring","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":860,"wires":[["76bfaeb9.ac6c8"]]},{"id":"74a15351.8ce6ac","type":"change","z":"19233749.06c6d9","name":"","rules":[{"t":"set","p":"seconds","pt":"msg","to":"$toMillis(\"1970-01-01T\" & payload.context.timer_period & \".000Z\")/1000","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":740,"wires":[["807f3a0c.ce7e28","9a34c564.a65cb8"]]},{"id":"9a34c564.a65cb8","type":"debug","z":"19233749.06c6d9","name":"msg.seconds","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":490,"y":700,"wires":[]},{"id":"47f5dd16.950704","type":"mqtt out","z":"19233749.06c6d9","name":"","topic":"pi3/alarm/cmd","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":1140,"y":900,"wires":[]},{"id":"9abc8c15.c1c8b","type":"comment","z":"19233749.06c6d9","name":"#timer-stop intent handling","info":"","x":290,"y":900,"wires":[]},{"id":"5e490836.b50ed8","type":"change","z":"19233749.06c6d9","name":"msg.payload = \"stop\" and msg.reset is set.","rules":[{"t":"set","p":"reset","pt":"msg","to":"NA","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"stop","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":960,"wires":[["76bfaeb9.ac6c8","47f5dd16.950704"]]},{"id":"5df710b1.9fc08","type":"comment","z":"56164435.31050c","name":"Volume control","info":"","x":300,"y":1560,"wires":[]},{"id":"1dfb59d8.1eb0e6","type":"ui_slider","z":"56164435.31050c","name":"volume control","label":"slider","group":"65c19335.9c7b5c","order":0,"width":0,"height":0,"passthru":false,"topic":"","min":0,"max":"100","step":"10","x":400,"y":1700,"wires":[["98f60965.f9dca8"]]},{"id":"2476ea61.cbb5a6","type":"mqtt in","z":"56164435.31050c","name":"","topic":"pi3/volume/percentage","qos":"0","broker":"c155bcf2.3fab9","x":140,"y":1700,"wires":[["1dfb59d8.1eb0e6","7a40a351.b6287c"]]},{"id":"8656bb48.1fe2a8","type":"inject","z":"56164435.31050c","name":"retrieve current volume","topic":"pi","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":190,"y":1600,"wires":[["aab258b3.561458"]]},{"id":"aab258b3.561458","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/volume/get","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":400,"y":1600,"wires":[]},{"id":"7a40a351.b6287c","type":"debug","z":"56164435.31050c","name":"pi3/volume/percentage","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":420,"y":1660,"wires":[]},{"id":"98f60965.f9dca8","type":"change","z":"56164435.31050c","name":"add % (so 60 becomes 60%)","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload & '%'","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":1700,"wires":[["6c73f5f0.a0fcac"]]},{"id":"6c73f5f0.a0fcac","type":"mqtt out","z":"56164435.31050c","name":"","topic":"pi3/volume/set","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":880,"y":1700,"wires":[]},{"id":"f72a6056.8c2cb","type":"comment","z":"19233749.06c6d9","name":"#radio-news intent handling","info":"","x":300,"y":1000,"wires":[]},{"id":"f11646d5.a214d8","type":"mqtt out","z":"19233749.06c6d9","name":"","topic":"pi3/radio_news","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":520,"y":1040,"wires":[]},{"id":"7d0af305.daab0c","type":"change","z":"19233749.06c6d9","name":"msg.payload = start","rules":[{"t":"set","p":"payload","pt":"msg","to":"start","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":1040,"wires":[["f11646d5.a214d8"]]},{"id":"5198cfdb.383ac","type":"comment","z":"19233749.06c6d9","name":"#louder intent handling","info":"","x":280,"y":1100,"wires":[]},{"id":"8a0a8c10.c5ed2","type":"comment","z":"19233749.06c6d9","name":"#too-loud intent handling","info":"","x":290,"y":1200,"wires":[]},{"id":"537ee897.6f0638","type":"change","z":"19233749.06c6d9","name":"msg.payload = 80%","rules":[{"t":"set","p":"payload","pt":"msg","to":"80%","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":1140,"wires":[["820c956b.d141f8"]]},{"id":"820c956b.d141f8","type":"mqtt out","z":"19233749.06c6d9","name":"","topic":"pi3/volume/set","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":520,"y":1140,"wires":[]},{"id":"5a43155f.45ba4c","type":"change","z":"19233749.06c6d9","name":"msg.payload = 40%","rules":[{"t":"set","p":"payload","pt":"msg","to":"40%","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":290,"y":1240,"wires":[["189fa97e.227ad7"]]},{"id":"189fa97e.227ad7","type":"mqtt out","z":"19233749.06c6d9","name":"","topic":"pi3/volume/set","qos":"0","retain":"","broker":"c155bcf2.3fab9","x":520,"y":1240,"wires":[]},{"id":"7e21ee21.49caa","type":"inject","z":"35b4329c.b0c8fe","name":"step 2 : read csv file","topic":"pi","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":300,"wires":[["94498d18.fbb7c"]]},{"id":"94498d18.fbb7c","type":"file in","z":"35b4329c.b0c8fe","name":"","filename":"/mnt/wd1tb_media/media/data/de_mol/Wie zijn de mollen _ (Responses) - Form Responses 1.csv","format":"utf8","chunk":false,"sendError":false,"x":600,"y":300,"wires":[["30b988e2.05f828","adf5013e.20092"]]},{"id":"30b988e2.05f828","type":"debug","z":"35b4329c.b0c8fe","name":"csv file","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1050,"y":300,"wires":[]},{"id":"56d51682.32b968","type":"debug","z":"35b4329c.b0c8fe","name":"json array","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":600,"y":420,"wires":[]},{"id":"3ab62068.3b304","type":"comment","z":"35b4329c.b0c8fe","name":"Documentation of this flow","info":"# Prerequisites\n1. The input is the google form \"de mollen\" : \n   https://docs.google.com/forms/u/0/\n2. csv file must be put at right location :\n   \\\\192.168.1.131\\media\\data\\de_mol\n3. \"de mollen\" are specified in flow variable\n\n# Design\n1. csv file will be imported\n2. validations of imported csv file\n  2. duplicate codes checked\n  3. duplicate names check => correction if mole\n  4. je mag jezelf niet vermelden\n4. manual error corrections\n  4.1 duplicate codes are deleted\n  4.2 duplicate names => 2nd instance replaced by name X\n  4.2 own name mentioned => replaced by name X.\n3. Calculate ranking.\n  3.1 de winnaars (1,2 en 3) - uitgezonderde mol\n  3.2 de verliezers (1,2 en 3)\n\n4. afvallers scherm (kan geen mol zijn)\n5. winnaars scherm (kan geen mol zijn)\n6. de mollen scherm\n\n7. de volledige stand (optioneel)\n  ","x":130,"y":40,"wires":[]},{"id":"792e67b7.813718","type":"inject","z":"35b4329c.b0c8fe","name":"1. initialization","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":120,"y":120,"wires":[["1c48e9ca.01b4d6"]]},{"id":"1c48e9ca.01b4d6","type":"change","z":"35b4329c.b0c8fe","name":"set flow variables: mollen, player_count, players, losers","rules":[{"t":"set","p":"mollen","pt":"flow","to":"[\"Eenik\",\"Lukas\",\"Veerle\",\"Wendy\"]","tot":"json"},{"t":"set","p":"player_count","pt":"flow","to":"28","tot":"num"},{"t":"set","p":"players","pt":"flow","to":"[\"Jan\",\"Marleen\",\"Jade\",\"Alexander\",\"Sterre\",\"Mirko\",\"Jef\",\"Yes\",\"Paul\",\"Mia\",\"Veerle\",\"Tim\",\"Frauke\",\"Merel\",\"Bente\",\"Mark\",\"Kiki\",\"Niels Fl\",\"Lynn\",\"Eenik\",\"Arne\",\"Koen\",\"Wendy\",\"Jannes\",\"Niels VdA\",\"Lukas\",\"Kaat\",\"Stefan\",\"Mats\",\"Finn\"]","tot":"json"},{"t":"set","p":"losers","pt":"flow","to":"[\"Niels Fl\",\"Alexander\",\"Mirko\"]","tot":"json"},{"t":"set","p":"winners","pt":"flow","to":"[\"Mark\",\"Niels VdA\", \"Yes\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":120,"wires":[["5356b707.2685c8","cf64a8fd.260578","56af5a1.a5fe8a4","3cb1ae1e.588932","48e375af.807c4c"]]},{"id":"bbd44c6.e9b54b","type":"debug","z":"35b4329c.b0c8fe","name":"mollen","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1170,"y":80,"wires":[]},{"id":"5356b707.2685c8","type":"change","z":"35b4329c.b0c8fe","name":"msg.payload = flow.mollen","rules":[{"t":"set","p":"payload","pt":"msg","to":"mollen","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":80,"wires":[["bbd44c6.e9b54b"]]},{"id":"d2ee80b8.26a18","type":"comment","z":"35b4329c.b0c8fe","name":"Update below node \"mollen\",\"player count\", \"players\"","info":"","x":450,"y":80,"wires":[]},{"id":"bc08841b.e22f58","type":"csv","z":"35b4329c.b0c8fe","name":"csv => json array","sep":",","hdrin":true,"hdrout":true,"multi":"mult","ret":"\\n","temp":"","skip":"0","x":370,"y":420,"wires":[["56d51682.32b968","18043c98.5963a3","ef8aa672.450b28","1d5f3d7b.7e1cf3","300a71ca.55902e","590561dc.c6172"]]},{"id":"adf5013e.20092","type":"change","z":"35b4329c.b0c8fe","name":"replace","rules":[{"t":"change","p":"payload","pt":"msg","from":" [(][^)]+[)]","fromt":"re","to":"","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"Uw naam:","fromt":"str","to":"naam","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"([1-6])\\. naam van de mol","fromt":"re","to":"mol_naam$1","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"Vrijstellingscode voor ","fromt":"str","to":"code_","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":360,"wires":[["a2df4ebe.60292","bc08841b.e22f58"]]},{"id":"a2df4ebe.60292","type":"debug","z":"35b4329c.b0c8fe","name":"replaced file","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":610,"y":360,"wires":[]},{"id":"18043c98.5963a3","type":"switch","z":"35b4329c.b0c8fe","name":"check player count","property":"payload.length","propertyType":"jsonata","rules":[{"t":"neq","v":"player_count","vt":"flow"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":480,"wires":[["174a1773.f00849"]]},{"id":"174a1773.f00849","type":"debug","z":"35b4329c.b0c8fe","name":"ERROR - player count mismatch","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload.length","x":1150,"y":480,"wires":[]},{"id":"ef8aa672.450b28","type":"change","z":"35b4329c.b0c8fe","name":"extract names","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.naam","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":520,"wires":[["93e28f2c.94086"]]},{"id":"796809a6.d16518","type":"debug","z":"35b4329c.b0c8fe","name":"ERROR: multiple forms with same name submitted","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1210,"y":520,"wires":[]},{"id":"93e28f2c.94086","type":"function","z":"35b4329c.b0c8fe","name":"return duplicates in array","func":"// https://www.thepolyglotdeveloper.com/2015/02/calculate-duplicates-exist-array-using-javascript/\n\nvar a = msg.payload;\nvar counts = [];\nvar response = \"\"\nfor(var i = 0; i <= a.length; i++) {\n    if(counts[a[i]] === undefined) {\n        counts[a[i]] = 1;\n    } else {\n        response += a[i] + \", \"\n    }\n}\nif (response===\"\") return null;\n\nmsg.payload = \"duplicates =  \" + response;\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":520,"wires":[["796809a6.d16518"]]},{"id":"1d5f3d7b.7e1cf3","type":"split","z":"35b4329c.b0c8fe","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":530,"y":680,"wires":[["e58e2d91.930c5","80b57f9f.eeba","d02753d.d15e5b"]]},{"id":"e58e2d91.930c5","type":"debug","z":"35b4329c.b0c8fe","name":"splitted","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":740,"y":640,"wires":[]},{"id":"80b57f9f.eeba","type":"switch","z":"35b4329c.b0c8fe","name":"check own name not used","property":"payload.naam","propertyType":"msg","rules":[{"t":"eq","v":"payload.mol_naam1","vt":"msg"},{"t":"eq","v":"payload.mol_naam2","vt":"msg"},{"t":"eq","v":"payload.mol_naam3","vt":"msg"},{"t":"eq","v":"payload.mol_naam4","vt":"msg"},{"t":"eq","v":"payload.mol_naam5","vt":"msg"},{"t":"eq","v":"payload.mol_naam6","vt":"msg"}],"checkall":"true","repair":false,"outputs":6,"x":790,"y":720,"wires":[["f966fbe8.87a738"],["f966fbe8.87a738"],["f966fbe8.87a738"],["f966fbe8.87a738"],["f966fbe8.87a738"],["f966fbe8.87a738"]]},{"id":"f966fbe8.87a738","type":"debug","z":"35b4329c.b0c8fe","name":"ERROR: you have voted on your own name","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1190,"y":720,"wires":[]},{"id":"d02753d.d15e5b","type":"change","z":"35b4329c.b0c8fe","name":"extract mol names","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"naam\": payload.naam,\t  \"mol_names\" : [ payload.mol_naam1,\t  payload.mol_naam2,\t  payload.mol_naam3,\t  payload.mol_naam4,\t  payload.mol_naam5,\t  payload.mol_naam6] }","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":800,"wires":[["931c4a2a.890888"]]},{"id":"931c4a2a.890888","type":"function","z":"35b4329c.b0c8fe","name":"return duplicates in array","func":"// https://www.thepolyglotdeveloper.com/2015/02/calculate-duplicates-exist-array-using-javascript/\n\nvar a = msg.payload.mol_names;\nvar counts = [];\nvar response = \"\"\nfor(var i = 0; i <= a.length; i++) {\n    if(counts[a[i]] === undefined) {\n        counts[a[i]] = 1;\n    } else {\n        response += a[i] + \", \"\n    }\n}\nif (response===\"\") return null;\n\nmsg.payload.duplicates = \"duplicates =  \" + response;\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":800,"wires":[["4c3ce05e.68ee7"]]},{"id":"4c3ce05e.68ee7","type":"debug","z":"35b4329c.b0c8fe","name":"ERROR: duplicate mol_names used","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1170,"y":800,"wires":[]},{"id":"300a71ca.55902e","type":"change","z":"35b4329c.b0c8fe","name":"extract codes","rules":[{"t":"set","p":"payload","pt":"msg","to":"[payload.code_mol_naam1,\tpayload.code_mol_naam2,\tpayload.code_mol_naam3,\tpayload.code_mol_naam4,\tpayload.code_mol_naam5,\tpayload.code_mol_naam6]","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":600,"wires":[["96cb9c4d.7663","68fa0906.17bfe8"]]},{"id":"96cb9c4d.7663","type":"function","z":"35b4329c.b0c8fe","name":"return duplicates in array","func":"// https://www.thepolyglotdeveloper.com/2015/02/calculate-duplicates-exist-array-using-javascript/\n\nvar a = msg.payload;\nvar counts = [];\nvar response = \"\"\nfor(var i = 0; i <= a.length; i++) {\n    if(counts[a[i]] === undefined) {\n        counts[a[i]] = 1;\n    } else {\n        response += a[i] + \", \"\n    }\n}\nif (response===\"\") return null;\n\nmsg.payload = \"duplicates =  \" + response;\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":600,"wires":[["e5cda758.266e38"]]},{"id":"e5cda758.266e38","type":"debug","z":"35b4329c.b0c8fe","name":"ERROR: multiple forms with same code submitted","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1210,"y":600,"wires":[]},{"id":"68fa0906.17bfe8","type":"debug","z":"35b4329c.b0c8fe","name":"extracted codes","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":760,"y":560,"wires":[]},{"id":"590561dc.c6172","type":"function","z":"35b4329c.b0c8fe","name":"calculate and add scores","func":"function isMol(name){\n    var mollen = flow.get(\"mollen\");\n    for(var i = 0; i < mollen.length; i++) {\n        if (name === mollen[i]) return true;\n    }\n    return false;\n}\n\nvar suspect_score={};\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    var player = msg.payload[i];\n    \n    var score = 0;\n\n    // add scores for \"mollen\"\n    if (isMol(player.mol_naam1)) score += 6;\n    if (isMol(player.mol_naam2)) score += 6;\n    if (isMol(player.mol_naam3)) score += 4;\n    if (isMol(player.mol_naam4)) score += 4;\n    if (isMol(player.mol_naam5)) score += 2;\n    if (isMol(player.mol_naam6)) score += 2;       \n         \n    // add scores for \"vrijstellingen\"\n    if ( (typeof player.code_mol_naam1 !==\"undefined\" ) && ! (isMol(player.mol_naam1))) score += 3;\n    if ( (typeof player.code_mol_naam2 !==\"undefined\" ) && ! (isMol(player.mol_naam2))) score += 3;\n    if ( (typeof player.code_mol_naam3 !==\"undefined\" ) && ! (isMol(player.mol_naam3))) score += 2;\n    if ( (typeof player.code_mol_naam4 !==\"undefined\" ) && ! (isMol(player.mol_naam4))) score += 2;\n    if ( (typeof player.code_mol_naam5 !==\"undefined\" ) && ! (isMol(player.mol_naam5))) score += 1;\n    if ( (typeof player.code_mol_naam6 !==\"undefined\" ) && ! (isMol(player.mol_naam6))) score += 1;            \n    \n    player.score = score;\n    \n    // update suspect_score\n    if ( typeof suspect_score[player.mol_naam1] ==\"undefined\" ) suspect_score[player.mol_naam1] =0;\n    if ( typeof suspect_score[player.mol_naam2] ==\"undefined\" ) suspect_score[player.mol_naam2] =0;   \n    if ( typeof suspect_score[player.mol_naam3] ==\"undefined\" ) suspect_score[player.mol_naam3] =0;\n    if ( typeof suspect_score[player.mol_naam4] ==\"undefined\" ) suspect_score[player.mol_naam4] =0;\n    if ( typeof suspect_score[player.mol_naam5] ==\"undefined\" ) suspect_score[player.mol_naam5] =0;\n    if ( typeof suspect_score[player.mol_naam6] ==\"undefined\" ) suspect_score[player.mol_naam6] =0;\n                    \n    suspect_score[player.mol_naam1] +=6;\n    suspect_score[player.mol_naam2] +=6;\n    suspect_score[player.mol_naam3] +=4;\n    suspect_score[player.mol_naam4] +=4;\n    suspect_score[player.mol_naam5] +=2;\n    suspect_score[player.mol_naam6] +=2;\n    \n    if ( typeof player.code_mol_naam1 !==\"undefined\" ) suspect_score[player.mol_naam1] -= 3;\n    if ( typeof player.code_mol_naam2 !==\"undefined\" ) suspect_score[player.mol_naam2] -= 3;   \n    if ( typeof player.code_mol_naam3 !==\"undefined\" ) suspect_score[player.mol_naam3] -= 2;\n    if ( typeof player.code_mol_naam4 !==\"undefined\" ) suspect_score[player.mol_naam4] -= 2;\n    if ( typeof player.code_mol_naam5 !==\"undefined\" ) suspect_score[player.mol_naam5] -= 1;   \n    if ( typeof player.code_mol_naam6 !==\"undefined\" ) suspect_score[player.mol_naam6] -= 1;       \n        \n}\n\nfor(var i = 0; i < msg.payload.length; i++) {\n    var player = msg.payload[i];\n    var suspect_sc = suspect_score[player.naam];\n    if ( typeof suspect_sc ==\"undefined\" ) suspect_sc = 0; \n    \n    player.verdenkings_score = suspect_sc;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":880,"wires":[["15930dce.778be2","95f3feee.d2e41"]]},{"id":"15930dce.778be2","type":"debug","z":"35b4329c.b0c8fe","name":"players with score added","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":590,"y":880,"wires":[]},{"id":"95f3feee.d2e41","type":"sort","z":"35b4329c.b0c8fe","name":"sort scores descending","order":"descending","as_num":false,"target":"payload","targetType":"msg","msgKey":"score","msgKeyType":"jsonata","seqKey":"payload","seqKeyType":"msg","x":290,"y":940,"wires":[["d52f8f9d.eaf36","9068dfe7.f78cf"]]},{"id":"d52f8f9d.eaf36","type":"debug","z":"35b4329c.b0c8fe","name":"sorted message","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":560,"y":940,"wires":[]},{"id":"ac8dadf7.21472","type":"comment","z":"35b4329c.b0c8fe","name":"Validations","info":"","x":1080,"y":420,"wires":[]},{"id":"cf64a8fd.260578","type":"change","z":"35b4329c.b0c8fe","name":"msg.payload = flow.player_count","rules":[{"t":"set","p":"payload","pt":"msg","to":"player_count","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":120,"wires":[["cc5751e7.e8226"]]},{"id":"cc5751e7.e8226","type":"debug","z":"35b4329c.b0c8fe","name":"player_count","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1190,"y":120,"wires":[]},{"id":"56af5a1.a5fe8a4","type":"change","z":"35b4329c.b0c8fe","name":"msg.payload = flow.players","rules":[{"t":"set","p":"payload","pt":"msg","to":"players","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":162.5,"wires":[["5295ecfa.7a6054"]]},{"id":"5295ecfa.7a6054","type":"debug","z":"35b4329c.b0c8fe","name":"players","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1180,"y":160,"wires":[]},{"id":"4afa49d1.2ec6c8","type":"comment","z":"35b4329c.b0c8fe","name":"TO DO - validate if all player names are valid.","info":"","x":1190,"y":860,"wires":[]},{"id":"3cb1ae1e.588932","type":"change","z":"35b4329c.b0c8fe","name":"msg.payload = flow.losers","rules":[{"t":"set","p":"payload","pt":"msg","to":"losers","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":200,"wires":[["f795d64c.05ef68"]]},{"id":"f795d64c.05ef68","type":"debug","z":"35b4329c.b0c8fe","name":"losers","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1170,"y":197.5,"wires":[]},{"id":"2f1ba9c0.e906a6","type":"http in","z":"35b4329c.b0c8fe","name":"","url":"check1","method":"get","upload":false,"swaggerDoc":"","x":110,"y":1340,"wires":[["fc9352db.62c3a"]]},{"id":"5745cd4c.6fd644","type":"http response","z":"35b4329c.b0c8fe","name":"","statusCode":"","headers":{},"x":710,"y":1380,"wires":[]},{"id":"99965c44.2e441","type":"template","z":"35b4329c.b0c8fe","name":"enter name","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style>\nbody, html {\n    height: 100%;\n    margin: 0;\n}\n\n.bg {\n    /* The image used */\n    background-image: url(\"demol_blauw.jpg\");\n\n    /* Full height */\n    height: 100%; \n\n    /* Center and scale the image nicely */\n    background-position: center;\n    background-repeat: no-repeat;\n    background-size: cover;\n}\n\n.center {\n    position: absolute;\n    left: 0;\n    top: 40%;\n    width: 100%;\n    text-align: center;\n    font-size:70px;\n}\n\n</style>\n</head>\n<body>\n\n<div class=\"bg\">\n <div class=\"center\">\n     <form action='/check_name' method='POST'>\n      Naam: <input style=\"font-size:100px;\"  type=\"text\"  size=\"12\" name=\"name\" ></p>\n      <br/>\n      <input type=\"hidden\" value=\"{{check}}\" name=\"check\" />\n      <input type=\"submit\" value=\"Enter\">\n</form>\n  </div>\n</div>\n\n</body>\n</html>","output":"str","x":550,"y":1380,"wires":[["5745cd4c.6fd644"]]},{"id":"c4eaf468.de6038","type":"http in","z":"35b4329c.b0c8fe","name":"","url":"check_name","method":"post","upload":false,"swaggerDoc":"","x":130,"y":1580,"wires":[["fc5cc0b3.1f41c","a28399cb.abb068"]]},{"id":"a1646f46.b10dd","type":"template","z":"35b4329c.b0c8fe","name":"display name + background","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style>\nbody, html {\n    height: 100%;\n    margin: 0;\n}\n\n.bg {\n    /* The image used */\n    background-image: url(\"{{background}}\");\n\n    /* Full height */\n    height: 100%; \n\n    /* Center and scale the image nicely */\n    background-position: center;\n    background-repeat: no-repeat;\n    background-size: cover;\n}\n\n.center {\n    position: absolute;\n    left: 0;\n    top: 40%;\n    width: 100%;\n    text-align: center;\n}\n\np.name {\n    font-size: 100px;\n}\n\np.error {\n    color: red;\n}\n\n</style>\n</head>\n<body>\n\n<div class=\"bg\">\n <div class=\"center\">\n  <p class=\"{{css_class_payload_name}}\">{{payload.name}}</p>\n  <p><a href=\"http://192.168.1.131:1880/{{url}}\">volgende naam</a></p>\n  </div>\n</div>\n\n</body>\n</html>","output":"str","x":1460,"y":1800,"wires":[["dae93dfc.514d4"]]},{"id":"dae93dfc.514d4","type":"http response","z":"35b4329c.b0c8fe","name":"","statusCode":"","headers":{},"x":1650,"y":1800,"wires":[]},{"id":"89276fc6.4254f","type":"change","z":"35b4329c.b0c8fe","name":"msg.background = demol_groen.jpg","rules":[{"t":"set","p":"background","pt":"msg","to":"demol_groen.jpg","tot":"str"},{"t":"set","p":"css_class_payload_name","pt":"msg","to":"name","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":1620,"wires":[["bbfc3511.83e3d8"]]},{"id":"92c841c4.5d02f","type":"change","z":"35b4329c.b0c8fe","name":"msg.background = demol_rood.png","rules":[{"t":"set","p":"background","pt":"msg","to":"demol_rood.png","tot":"str"},{"t":"set","p":"css_class_payload_name","pt":"msg","to":"name","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1560,"wires":[["bbfc3511.83e3d8"]]},{"id":"20f08e7b.8758b2","type":"change","z":"35b4329c.b0c8fe","name":"msg.background = demol_blauw.jpg & \".... is geen geldige naam\".","rules":[{"t":"set","p":"background","pt":"msg","to":"demol_blauw.jpg","tot":"str"},{"t":"set","p":"payload.name","pt":"msg","to":"payload.name & \" is geen geldige naam !\"","tot":"jsonata"},{"t":"set","p":"css_class_payload_name","pt":"msg","to":"name error","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1460,"y":1560,"wires":[["a1646f46.b10dd"]]},{"id":"fc9352db.62c3a","type":"change","z":"35b4329c.b0c8fe","name":"msg.check = is_loser","rules":[{"t":"set","p":"check","pt":"msg","to":"is_loser","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":1340,"wires":[["99965c44.2e441"]]},{"id":"fc5cc0b3.1f41c","type":"debug","z":"35b4329c.b0c8fe","name":"http post check_name","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":340,"y":1500,"wires":[]},{"id":"c07ee637.bd2a78","type":"http in","z":"35b4329c.b0c8fe","name":"","url":"winners","method":"get","upload":false,"swaggerDoc":"","x":110,"y":1380,"wires":[["cb601049.8de64"]]},{"id":"c408ed78.9ccd7","type":"http in","z":"35b4329c.b0c8fe","name":"","url":"mollen","method":"get","upload":false,"swaggerDoc":"","x":110,"y":1420,"wires":[["80eefc8d.95745"]]},{"id":"cb601049.8de64","type":"change","z":"35b4329c.b0c8fe","name":"msg.check = is_winner","rules":[{"t":"set","p":"check","pt":"msg","to":"is_winner","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":1380,"wires":[["99965c44.2e441"]]},{"id":"80eefc8d.95745","type":"change","z":"35b4329c.b0c8fe","name":"msg.check = is_mol","rules":[{"t":"set","p":"check","pt":"msg","to":"is_mol","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1420,"wires":[["99965c44.2e441"]]},{"id":"a28399cb.abb068","type":"switch","z":"35b4329c.b0c8fe","name":"msg.payload.check ?","property":"payload.check","propertyType":"msg","rules":[{"t":"eq","v":"is_loser","vt":"str"},{"t":"eq","v":"is_winner","vt":"str"},{"t":"eq","v":"is_mol","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":1660,"wires":[["b5883a0e.d097e8"],["1bb91063.4bb51"],["d5232a3d.f035f8"]]},{"id":"b5883a0e.d097e8","type":"change","z":"35b4329c.b0c8fe","name":"set msg.url = check1","rules":[{"t":"set","p":"url","pt":"msg","to":"check1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1620,"wires":[["14233e63.444852"]]},{"id":"1bb91063.4bb51","type":"change","z":"35b4329c.b0c8fe","name":"set msg.url = winners","rules":[{"t":"set","p":"url","pt":"msg","to":"winners","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1660,"wires":[["2a63b61a.d2e32a"]]},{"id":"d5232a3d.f035f8","type":"change","z":"35b4329c.b0c8fe","name":"set msg.url = mollen","rules":[{"t":"set","p":"url","pt":"msg","to":"mollen","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1700,"wires":[["438951de.c95f9"]]},{"id":"bbfc3511.83e3d8","type":"function","z":"35b4329c.b0c8fe","name":"is player name valid ?","func":"if (! flow.get(\"players\").includes(msg.payload.name)) return [ msg, null];\nreturn [ null, msg ];\n","outputs":2,"noerr":0,"x":1160,"y":1620,"wires":[["20f08e7b.8758b2"],["a1646f46.b10dd"]],"outputLabels":["unknown player name","known player name"]},{"id":"14233e63.444852","type":"function","z":"35b4329c.b0c8fe","name":"is loser ?","func":"if (flow.get(\"losers\").includes(msg.payload.name)) return [  msg, null];\nreturn [ null , msg ];","outputs":2,"noerr":0,"x":560,"y":1600,"wires":[["92c841c4.5d02f"],["89276fc6.4254f"]],"outputLabels":["is loser","is not loser"]},{"id":"2a63b61a.d2e32a","type":"function","z":"35b4329c.b0c8fe","name":"is winner ?","func":"if (flow.get(\"winners\").includes(msg.payload.name)) return [  msg, null];\nreturn [ null , msg ];","outputs":2,"noerr":0,"x":590,"y":1660,"wires":[["31d3741b.c6129c"],["92c841c4.5d02f"]],"outputLabels":["is winner","is not winner"]},{"id":"438951de.c95f9","type":"function","z":"35b4329c.b0c8fe","name":"is mol ?","func":"if (flow.get(\"mollen\").includes(msg.payload.name)) return [  msg, null];\nreturn [ null , msg ];","outputs":2,"noerr":0,"x":580,"y":1700,"wires":[["630f6b48.0d9884"],["92c841c4.5d02f"]],"outputLabels":["is mol","is not mol"]},{"id":"31d3741b.c6129c","type":"change","z":"35b4329c.b0c8fe","name":"msg.background = winnaar.png","rules":[{"t":"set","p":"background","pt":"msg","to":"winnaar.png","tot":"str"},{"t":"set","p":"css_class_payload_name","pt":"msg","to":"name","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":1700,"wires":[["a1646f46.b10dd"]]},{"id":"630f6b48.0d9884","type":"change","z":"35b4329c.b0c8fe","name":"msg.background = mol.jpg","rules":[{"t":"set","p":"background","pt":"msg","to":"mol.jpg","tot":"str"},{"t":"set","p":"css_class_payload_name","pt":"msg","to":"name","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":1760,"wires":[["a1646f46.b10dd"]]},{"id":"48e375af.807c4c","type":"change","z":"35b4329c.b0c8fe","name":"msg.payload = flow.winners","rules":[{"t":"set","p":"payload","pt":"msg","to":"winners","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":900,"y":240,"wires":[["b8a1037f.5d384"]]},{"id":"b8a1037f.5d384","type":"debug","z":"35b4329c.b0c8fe","name":"winners","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1180,"y":237.5,"wires":[]},{"id":"20132758.d0ddd8","type":"comment","z":"35b4329c.b0c8fe","name":"192.168.1.131:1880/check1 ..../winners  .../mollen","info":"","x":220,"y":1280,"wires":[]},{"id":"e614d3df.d57e2","type":"comment","z":"35b4329c.b0c8fe","name":"determine losers","info":"","x":486.6666564941406,"y":984.9999389648438,"wires":[]},{"id":"9068dfe7.f78cf","type":"function","z":"35b4329c.b0c8fe","name":"classify","func":"var remaining_mol_count = flow.get(\"mollen\").length;\n\n// half of the players (excluding the \"mollen\" are considered \"the losers\")\nvar remaining_loser_count = (flow.get(\"player_count\")-remaining_mol_count)/2;\n\n// specifies the minimal number of winners, in case of ex aqueo there might be more winners\n// than this minimal number.\nvar remaining_winner_count = 3;\n\nvar min_winner_score;\n\nfor(var i = (msg.payload.length - 1); i >= 0; i--) {\n    var player = msg.payload[i];\n    if (flow.get(\"mollen\").includes(player.naam)) {\n        player['type'] = \"mol\";\n        remaining_mol_count--;\n    } else if ( remaining_loser_count >0) {\n        player['type']  = \"2de helft\";\n        remaining_loser_count--;\n    } else {\n        player['type']  = \"1st helft\";\n    }\n}\n\n// determine winners\nfor(var i =0; i< msg.payload.length; i++) {\n    var player = msg.payload[i];\n    if (!flow.get(\"mollen\").includes(player.naam)){\n        if (remaining_winner_count > 0){\n            player['type']  = \"winnaar\"\n            min_winner_score = player.score;\n            remaining_winner_count--;\n        }\n        // check for exaqueo\n        if (player.score === min_winner_score){\n            player['type']  = \"winnaar\";\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":1060,"wires":[["93188bf2.b4d0a8","bab2fca8.454bd","4f60733c.9f661c","da51d3dc.f8fa5"]]},{"id":"93188bf2.b4d0a8","type":"debug","z":"35b4329c.b0c8fe","name":"added type","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":430,"y":1020,"wires":[]},{"id":"bab2fca8.454bd","type":"change","z":"35b4329c.b0c8fe","name":"set flow.winners","rules":[{"t":"set","p":"winners","pt":"flow","to":"payload[type=\"winnaar\"].naam","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"winners","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":1120,"wires":[["39bd1670.e8741a"]]},{"id":"4f60733c.9f661c","type":"change","z":"35b4329c.b0c8fe","name":"set flow.losers","rules":[{"t":"set","p":"losers","pt":"flow","to":"payload[type=\"2de helft\"].naam","tot":"jsonata"},{"t":"set","p":"payload","pt":"msg","to":"losers","tot":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":1160,"wires":[["ecfc31dd.db628"]]},{"id":"39bd1670.e8741a","type":"debug","z":"35b4329c.b0c8fe","name":"flow.winners","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":690,"y":1120,"wires":[]},{"id":"ecfc31dd.db628","type":"debug","z":"35b4329c.b0c8fe","name":"flow.losers","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":690,"y":1160,"wires":[]},{"id":"da51d3dc.f8fa5","type":"csv","z":"35b4329c.b0c8fe","name":"","sep":";","hdrin":"","hdrout":true,"multi":"one","ret":"\\r\\n","temp":"naam, type, score, verdenkings_score, mol_naam1, mol_naam2, mol_naam3, mol_naam4, mol_naam5, mol_naam6, code_mol_naam1, code_mol_naam2, code_mol_naam3, code_mol_naam4, code_mol_naam5, code_mol_naam6","skip":"0","x":410,"y":1060,"wires":[["e00fd065.97293","7cfcaa45.81f214"]]},{"id":"e00fd065.97293","type":"debug","z":"35b4329c.b0c8fe","name":"csv output","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":666.6666259765625,"y":1023.3333129882812,"wires":[]},{"id":"7cfcaa45.81f214","type":"file","z":"35b4329c.b0c8fe","name":"","filename":"/mnt/wd1tb_media/media/data/de_mol/output.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","x":770,"y":1060,"wires":[[]]},{"id":"9eeecd2d.c22b5","type":"ui_text","z":"d448e38d.8eb16","group":"83960579.c80148","order":8,"width":0,"height":0,"name":"","label":"pi3three:","format":"{{msg.payload.status_msg}}","layout":"row-spread","x":720,"y":720,"wires":[]},{"id":"856e42be.e5eb5","type":"twitter in","z":"86117963.0fe068","twitter":"d3c6a10d.5a408","tags":"#QuantumComputing,#QuantumComputation,#test8910","user":"false","name":"Listen to twitter feed","inputs":1,"x":110,"y":100,"wires":[["32d22338.73ca3c","4cf272bf.b1b74c","ade390a0.f694e"]]},{"id":"32d22338.73ca3c","type":"debug","z":"86117963.0fe068","name":"msg.tweet details","active":true,"console":"false","complete":"tweet","x":490,"y":100,"wires":[]},{"id":"4cf272bf.b1b74c","type":"function","z":"86117963.0fe068","name":"Remove URLS and replace #","func":"var tweet = msg.tweet.text;\nvar newtweet = tweet.replace(/#/g, \" Hash tag \");\n\n// regex from https://stackoverflow.com/questions/1500260/detect-urls-in-text-with-javascript\nmsg.payload = newtweet.replace( /(([a-z]+:\\/\\/)?(([a-z0-9\\-]+\\.)+([a-z]{2}|biz|com|co|edu|gov|info|net|org|ly))(:[0-9]{1,5})?(\\/[a-z0-9_\\-\\.~]+)*(\\/([a-z0-9_\\-\\.]*)(\\?[a-z0-9+_\\-\\.%=&amp;]*)?)?(#[a-zA-Z0-9!$&'()*+.=-_~:@/?]*)?)(\\s+|$)/gi, \"see short URL \" );\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":140,"wires":[["316191d4.e45aee","b60c5708.f17038"]]},{"id":"316191d4.e45aee","type":"debug","z":"86117963.0fe068","name":"","active":true,"console":"false","complete":"false","x":790,"y":140,"wires":[]},{"id":"ade390a0.f694e","type":"debug","z":"86117963.0fe068","name":"complete tweet","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":480,"y":60,"wires":[]},{"id":"9c397645.048668","type":"inject","z":"86117963.0fe068","name":"Happy test","topic":"","payload":"{\"text\":\"every one is awesome\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":"","x":100,"y":200,"wires":[["f1a4a200.0affb"]]},{"id":"f1a4a200.0affb","type":"change","z":"86117963.0fe068","name":"","rules":[{"t":"set","p":"tweet","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":240,"wires":[["4cf272bf.b1b74c"]]},{"id":"2f7ec443.44bcdc","type":"inject","z":"86117963.0fe068","name":"Sadness test","topic":"","payload":"{\"text\":\"This is miserable and sad\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":110,"y":240,"wires":[["f1a4a200.0affb"]]},{"id":"faf20586.fb7d78","type":"inject","z":"86117963.0fe068","name":"Angry test","topic":"","payload":"{\"text\":\"I hate this demo\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":100,"y":280,"wires":[["f1a4a200.0affb"]]},{"id":"d1c02c02.8271e","type":"comment","z":"86117963.0fe068","name":"Paste API keys for Watson Tone Analyzer","info":"1. Log into IBM Cloud\n2. Create an instance of the \nWatson Tone Analyzer service.\n3. Visit the Service Credentials tab\n4. Click on View Credentials\n5. Copy/Paste the password and username into\nthis Node-RED node.\n\nOr\n1. Open this Cloud Foundry Node-RED Starter App\n2. Create a new Connection\n3. Bind the Watson Tone Analyzer service\n4. Restage your Cloud Foundry application","x":250,"y":380,"wires":[]},{"id":"239adf6c.e6088","type":"debug","z":"86117963.0fe068","name":"Tone categories","active":true,"console":"false","complete":"payload","x":780,"y":340,"wires":[]},{"id":"756a130a.cd2cec","type":"function","z":"86117963.0fe068","name":"High Score","func":"var emotions = [];\nemotions = msg.response.document_tone.tone_categories\n                .filter(function(c){\n                    if (c.category_id == \"emotion_tone\")\n                    {return c; }\n                    })[0].tones;\n                    \nvar myscore =  0;\nfor (var i=0; i<emotions.length; i++) {\n    if(emotions[i].score > myscore) {\n        msg.payload = emotions[i].score;\n        msg.topic = emotions[i].tone_name;\n        myscore = emotions[i].score;\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":380,"wires":[["a3b36d2.af4a29","5554634e.40603c"]]},{"id":"a3b36d2.af4a29","type":"debug","z":"86117963.0fe068","name":"Score","active":true,"console":"false","complete":"topic","x":750,"y":380,"wires":[]},{"id":"4038be97.254be","type":"debug","z":"86117963.0fe068","name":"Print msg.response","active":true,"console":"false","complete":"response","x":570,"y":300,"wires":[]},{"id":"e1826f1b.9cb6a","type":"change","z":"86117963.0fe068","name":"tone_categories","rules":[{"t":"set","p":"payload","pt":"msg","to":"response.document_tone.tone_categories","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":340,"wires":[["239adf6c.e6088"]]},{"id":"5554634e.40603c","type":"switch","z":"86117963.0fe068","name":"Select Emotion","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"Joy","vt":"str"},{"t":"eq","v":"Fear","vt":"str"},{"t":"eq","v":"Sadness","vt":"str"},{"t":"eq","v":"Anger","vt":"str"},{"t":"eq","v":"Disgust","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":340,"y":600,"wires":[["5f1b3c9c.8f6af4"],["5a65adcc.59f844"],["fa542ab5.794f78"],["4df11c7e.ad5054"],["210f947b.2be84c"]]},{"id":"c9d550b4.f5124","type":"comment","z":"86117963.0fe068","name":"Extract highest emotion","info":"","x":760,"y":420,"wires":[]},{"id":"5a65adcc.59f844","type":"change","z":"86117963.0fe068","name":"Fear","rules":[{"t":"set","p":"payload","pt":"msg","to":"0,255,0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":560,"wires":[["a788ebd6.77e238"]]},{"id":"4df11c7e.ad5054","type":"change","z":"86117963.0fe068","name":"Anger","rules":[{"t":"set","p":"payload","pt":"msg","to":"255,0,0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":640,"wires":[["a788ebd6.77e238"]]},{"id":"fa542ab5.794f78","type":"change","z":"86117963.0fe068","name":"Sadness","rules":[{"t":"set","p":"payload","pt":"msg","to":"0,0,255","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":600,"wires":[["a788ebd6.77e238"]]},{"id":"5f1b3c9c.8f6af4","type":"change","z":"86117963.0fe068","name":"Joy","rules":[{"t":"set","p":"payload","pt":"msg","to":"255,255,0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":520,"wires":[["a788ebd6.77e238"]]},{"id":"210f947b.2be84c","type":"change","z":"86117963.0fe068","name":"Disgust","rules":[{"t":"set","p":"payload","pt":"msg","to":"221,160,221","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":680,"wires":[["a788ebd6.77e238"]]},{"id":"8ce70de3.74b58","type":"template","z":"86117963.0fe068","name":"Score tweet","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"[{{topic}}] https://twitter.com/{{tweet.user.screen_name}}/status/{{tweet.id_str}}  -  {{tweet.text}}","output":"str","x":810,"y":620,"wires":[["a4892259.39263"]]},{"id":"a4892259.39263","type":"debug","z":"86117963.0fe068","name":"","active":true,"console":"false","complete":"false","x":950,"y":580,"wires":[]},{"id":"e9f239df.9855f8","type":"comment","z":"86117963.0fe068","name":"Pick a #hashtag to follow","info":"","x":120,"y":60,"wires":[]},{"id":"5b535597.4059ec","type":"slack","z":"86117963.0fe068","name":"#tweets","username":"pi3one","emojiIcon":"","channel":"#tweets","x":940,"y":680,"wires":[]},{"id":"a788ebd6.77e238","type":"function","z":"86117963.0fe068","name":"decode html tags","func":"//https://github.com/mathiasbynens/he\n//var he = require('he');\n//msg.tweet.text=he.decode(msg.tweet.text);\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":560,"wires":[["8ce70de3.74b58"]]},{"id":"b60c5708.f17038","type":"watson-tone-analyzer-v3","z":"86117963.0fe068","name":"Analyze Tone","tones":"emotion","sentences":"true","contentType":"false","tone-method":"generalTone","interface-version":"2016-05-19","inputlang":"en","default-endpoint":false,"service-endpoint":"https://gateway.watsonplatform.net/tone-analyzer/api","x":340,"y":340,"wires":[["756a130a.cd2cec","4038be97.254be","e1826f1b.9cb6a"]]},{"id":"b1765445.b48228","type":"function","z":"4bf9468a.f3a898","name":"delete msg.payload[\"sensor\"]=\"bme280\" property","func":"delete msg.payload[\"sensor\"]; \nreturn msg;","outputs":1,"noerr":0,"x":590,"y":120,"wires":[["f87c2d41.10211"]]},{"id":"a4705421.cc4468","type":"credentials","z":"7fdd45e3.83045c","name":"credentials","props":[{"value":"pi3one_emoncms_read_api_key","type":"msg"}],"x":290,"y":100,"wires":[["c7ae2f05.9b4e3","80f67be8.8eac98"]]},{"id":"e640fafd.efc988","type":"inject","z":"7fdd45e3.83045c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":100,"wires":[["a4705421.cc4468"]]},{"id":"c7ae2f05.9b4e3","type":"debug","z":"7fdd45e3.83045c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":470,"y":80,"wires":[]},{"id":"80f67be8.8eac98","type":"change","z":"7fdd45e3.83045c","name":"set msg.payload to pi3one_emoncms_read_api_key","rules":[{"t":"set","p":"payload","pt":"msg","to":"pi3one_emoncms_read_api_key","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":140,"wires":[["8c0389c4.d34c18"]]},{"id":"8c0389c4.d34c18","type":"link out","z":"7fdd45e3.83045c","name":"pi3one_emoncms_read_api_key","links":["87379037.177a7","552e7b88.c5d784","3d1c99df.988ff6"],"x":875,"y":140,"wires":[]},{"id":"87379037.177a7","type":"link in","z":"7fa2194.bf802e8","name":"","links":["8c0389c4.d34c18"],"x":315,"y":820,"wires":[["b9c56c52.72e88"]]},{"id":"b9c56c52.72e88","type":"template","z":"7fa2194.bf802e8","name":"emoncms iframe","field":"template","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<iframe style=\"width:300px; height:400px;\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" \n src=\"http://192.168.1.131/emoncms/vis/multigraph?mid=1&embed=1&apikey={{payload}}\"></iframe>","output":"str","x":460,"y":820,"wires":[["3a025ec0.007822"]]},{"id":"a5ba2675.d59558","type":"template","z":"e6728257.d2c86","name":"emoncms iframe","field":"template","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<iframe style=\"width:580px; height:400px;\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\"\nsrc=\"http://192.168.1.131/emoncms/vis/multigraph?mid=3&embed=1&apikey={{payload}}\"></iframe>","output":"str","x":520,"y":880,"wires":[["f0c95a28.052ae8"]]},{"id":"552e7b88.c5d784","type":"link in","z":"e6728257.d2c86","name":"","links":["8c0389c4.d34c18"],"x":375,"y":880,"wires":[["a5ba2675.d59558"]]},{"id":"3d1c99df.988ff6","type":"link in","z":"ae997a8f.fef6b8","name":"","links":["8c0389c4.d34c18"],"x":775,"y":60,"wires":[["9ab6c646.a28e18"]]},{"id":"9ab6c646.a28e18","type":"change","z":"ae997a8f.fef6b8","name":"","rules":[{"t":"set","p":"emoncms_read_api_key","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":60,"wires":[[]]},{"id":"7d3c1c81.0d6414","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"pulse_count","pt":"msg","to":"$number(payload)\t","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":500,"wires":[["4cd2ef61.80367","80508fda.8f5df"]]},{"id":"4cd2ef61.80367","type":"debug","z":"9ec36226.6064b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"pulse_count","x":490,"y":460,"wires":[]},{"id":"66ab71d8.23ff5","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"last_pulse_count","pt":"flow","to":"pulse_count","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":640,"wires":[[]]},{"id":"80508fda.8f5df","type":"change","z":"9ec36226.6064b","name":"set msg.payload as delta","rules":[{"t":"set","p":"payload","pt":"msg","to":"pulse_count - $flowContext(\"last_pulse_count\")","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"water_meter","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":580,"wires":[["66ab71d8.23ff5","ca8c321c.bba93","1b42d25b.b46b9e"]]},{"id":"ca8c321c.bba93","type":"debug","z":"9ec36226.6064b","name":"delta pulse count","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":590,"y":540,"wires":[]},{"id":"f0de1b55.bbb9b8","type":"ui_chart","z":"9ec36226.6064b","name":"","group":"819fde39.8d275","order":2,"width":0,"height":0,"label":"water usage last day [ l / 5 min ]","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"step","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1150,"y":660,"wires":[[],[]]},{"id":"4cbb7d37.4d1c34","type":"aggregator","z":"9ec36226.6064b","name":"aggregate every 5 minutes","topic":"water_meter","intervalCount":"5","intervalUnits":"m","submitIncompleteInterval":false,"aggregationType":"sum","x":800,"y":660,"wires":[["f0de1b55.bbb9b8","dea7099d.d2cca8","85a6cdec.3fae3"]]},{"id":"b9ff1b09.ac6858","type":"ui_chart","z":"9ec36226.6064b","name":"","group":"819fde39.8d275","order":1,"width":0,"height":0,"label":"water usage last 15 minutes [ l/5s]","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"15","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1020,"y":580,"wires":[[],[]]},{"id":"1b42d25b.b46b9e","type":"switch","z":"9ec36226.6064b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":550,"y":580,"wires":[["921066c7.7c9208"],["1f81b22b.2128de"]]},{"id":"1f81b22b.2128de","type":"debug","z":"9ec36226.6064b","name":"negative water meter delta pulse count","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":620,"y":820,"wires":[]},{"id":"5bb4b73f.bd8b98","type":"debug","z":"9ec36226.6064b","name":"delta liters used","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":740,"y":380,"wires":[]},{"id":"d387d711.174398","type":"mqtt in","z":"9ec36226.6064b","name":"","topic":"water_meter/pulse_count","qos":"2","broker":"9c9ae2bc.63652","x":130,"y":440,"wires":[["bbb118dc.1715e8","7d3c1c81.0d6414"]]},{"id":"bbb118dc.1715e8","type":"debug","z":"9ec36226.6064b","name":"water_meter/pulse_count","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":390,"y":420,"wires":[]},{"id":"481fa759.383388","type":"mqtt in","z":"9ec36226.6064b","name":"","topic":"nodeMCU/temperature","qos":"2","broker":"9c9ae2bc.63652","x":140,"y":1060,"wires":[["2ae42e4d.160552","bd78d43e.c39768"]]},{"id":"84f6b13b.e4f1","type":"mqtt in","z":"9ec36226.6064b","name":"","topic":"nodeMCU/humidity","qos":"2","broker":"9c9ae2bc.63652","x":150,"y":1140,"wires":[["a10e60a9.b193e","fc7a531e.3118f"]]},{"id":"2ae42e4d.160552","type":"debug","z":"9ec36226.6064b","name":"nodeMCU/temperature","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":400,"y":1040,"wires":[]},{"id":"a10e60a9.b193e","type":"debug","z":"9ec36226.6064b","name":"nodeMCU/humidity","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":390,"y":1100,"wires":[]},{"id":"2d2dcce2.c01534","type":"link out","z":"9ec36226.6064b","name":"nodeMCU temperature","links":["133801fb.439cce","79dec3f7.55210c"],"x":815,"y":1060,"wires":[]},{"id":"dd97b43c.bb76f8","type":"link out","z":"9ec36226.6064b","name":"nodeMCU humidity","links":["50c883c0.f7090c","79dec3f7.55210c"],"x":675,"y":1140,"wires":[]},{"id":"133801fb.439cce","type":"link in","z":"cbb123e.ff1e2e","name":"","links":["2d2dcce2.c01534","8a5bebd1.286f98"],"x":295,"y":500,"wires":[["d38d5fca.a812a"]]},{"id":"d38d5fca.a812a","type":"ui_text","z":"cbb123e.ff1e2e","group":"a5cd413.e0d49c","order":4,"width":0,"height":0,"name":"Kelder Temp (nodeMCU)","label":"Kelder (nodeMCU)","format":"{{msg.payload.temperature | number:1 }}&deg;","layout":"row-spread","x":450,"y":500,"wires":[]},{"id":"50c883c0.f7090c","type":"link in","z":"cbb123e.ff1e2e","name":"node","links":["dd97b43c.bb76f8","23ba6cbc.1ed024"],"x":295,"y":560,"wires":[["5b51dcff.827364"]]},{"id":"5b51dcff.827364","type":"ui_text","z":"cbb123e.ff1e2e","group":"dfabd96f.d0b918","order":4,"width":0,"height":0,"name":"Kelder vochtigheid (nodeMCU)","label":"Kelder (nodeMCU)","format":"{{msg.payload.humidity | number:1 }}%","layout":"row-spread","x":490,"y":560,"wires":[]},{"id":"f807b019.eafb7","type":"link out","z":"9ec36226.6064b","name":"nodeMCU water meter pulse count","links":["79dec3f7.55210c"],"x":1075,"y":420,"wires":[]},{"id":"dca9872d.73d518","type":"change","z":"9ec36226.6064b","name":"prepare for emoncms (nodegroup 29)","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"water_meter_liter_per_5sec\" : payload }","tot":"jsonata"},{"t":"set","p":"nodegroup","pt":"msg","to":"29","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":420,"wires":[["f807b019.eafb7"]]},{"id":"bd78d43e.c39768","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"temperature\" : payload }","tot":"jsonata"},{"t":"set","p":"nodegroup","pt":"msg","to":"29","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":1060,"wires":[["2d2dcce2.c01534"]]},{"id":"fc7a531e.3118f","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"humidity\" : payload }","tot":"jsonata"},{"t":"set","p":"nodegroup","pt":"msg","to":"29","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":1140,"wires":[["dd97b43c.bb76f8"]]},{"id":"ed28c469.105ca8","type":"ui_button","z":"9ec36226.6064b","name":"","group":"4fce2e4b.e9118","order":1,"width":"3","height":"1","passthru":false,"label":"start","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":90,"y":840,"wires":[["d1838aa9.62ad38"]]},{"id":"e36c0b4f.dad498","type":"ui_button","z":"9ec36226.6064b","name":"","group":"4fce2e4b.e9118","order":2,"width":"4","height":"1","passthru":false,"label":"stop","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":90,"y":900,"wires":[["22577b14.b88904"]]},{"id":"d1838aa9.62ad38","type":"change","z":"9ec36226.6064b","name":"set start pulse count","rules":[{"t":"set","p":"start_pulse_count","pt":"flow","to":"last_pulse_count","tot":"flow"},{"t":"set","p":"payload","pt":"msg","to":"\"start pulse count=\" &  $flowContext(\"start_pulse_count\") & \" [raw pulse count=\" & $flowContext(\"raw_pulse_count\") & \"]\"","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":260,"y":840,"wires":[["59b8513f.40276"]]},{"id":"59b8513f.40276","type":"ui_text","z":"9ec36226.6064b","group":"4fce2e4b.e9118","order":3,"width":0,"height":0,"name":"delta pulse count","label":"","format":"{{msg.payload}}","layout":"row-left","x":570,"y":900,"wires":[]},{"id":"22577b14.b88904","type":"change","z":"9ec36226.6064b","name":"calculate delta pulse count","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"pulse count = \" & ($flowContext(\"last_pulse_count\")-$flowContext(\"start_pulse_count\"))","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":280,"y":900,"wires":[["59b8513f.40276"]]},{"id":"c6ac7075.ecaf4","type":"comment","z":"9ec36226.6064b","name":"water meter pulse counts","info":"","x":150,"y":40,"wires":[]},{"id":"d9c79b6.baa9c68","type":"comment","z":"9ec36226.6064b","name":"nodeMCU temp and humidity  ** working **","info":"Currently there is no nodeMCU sending these MQTT messages.\n","x":180,"y":980,"wires":[]},{"id":"10181eeb.010291","type":"inject","z":"212e34f.4a0cfcc","name":"Get IP","topic":"ip","payload":"","payloadType":"str","repeat":"21600","crontab":"","once":true,"onceDelay":"5","x":140,"y":160,"wires":[["9f8f0032.233ab"]]},{"id":"971cc02b.a59d8","type":"function","z":"212e34f.4a0cfcc","name":"Compare IP","func":"context.lastip = context.lastip || 'initial';\nvar currentip = msg.payload;\n\nif (context.lastip == 'initial') {\nmsg.payload = \"My current Public IP is \"+currentip;\ncontext.lastip = currentip;\nreturn msg;\n}\nelse if (context.lastip != currentip) {\nmsg.payload = \"My New Public IP is \"+currentip;\ncontext.lastip = currentip;\nreturn msg;\n}\nelse return null;","outputs":1,"noerr":0,"x":890,"y":120,"wires":[["5e93128.9d20eec","2c406b46.2ffe84"]]},{"id":"9f8f0032.233ab","type":"exec","z":"212e34f.4a0cfcc","command":"wget -qO- http://ipv4bot.whatismyipaddress.com/ ; echo","addpay":false,"append":"","useSpawn":"","timer":"","oldrc":false,"name":"Call IP - whatismyipaddress.com","x":363,"y":159.5,"wires":[["2acb9e4a.730af2","e638d85d.fac868"],["cad03534.535d18"],["b07970f4.1e0bc"]]},{"id":"2acb9e4a.730af2","type":"switch","z":"212e34f.4a0cfcc","name":"Integrity check","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"\\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","vt":"str","case":false},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":640,"y":120,"wires":[["971cc02b.a59d8","4d11d823.b34e98"],[]]},{"id":"e638d85d.fac868","type":"debug","z":"212e34f.4a0cfcc","name":"call ip : stdout","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":640,"y":80,"wires":[]},{"id":"ebe40824.6ef138","type":"comment","z":"212e34f.4a0cfcc","name":"Flow Documentation","info":"This flow is based on : https://flows.nodered.org/flow/9559f217b08913702c38\n\nFor more information about the service used see: https://whatismyipaddress.com/api","x":130,"y":40,"wires":[]},{"id":"cad03534.535d18","type":"debug","z":"212e34f.4a0cfcc","name":"call ip - stderr","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":640,"y":180,"wires":[]},{"id":"b07970f4.1e0bc","type":"debug","z":"212e34f.4a0cfcc","name":"call ip - return code","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":240,"wires":[]},{"id":"4d11d823.b34e98","type":"debug","z":"212e34f.4a0cfcc","name":"my public ip address","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":920,"y":80,"wires":[]},{"id":"5e93128.9d20eec","type":"debug","z":"212e34f.4a0cfcc","name":"Changed IP address","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1100,"y":120,"wires":[]},{"id":"2c406b46.2ffe84","type":"slack","z":"212e34f.4a0cfcc","name":"#tweets channel","username":"pi3one","emojiIcon":"","channel":"#tweets","x":1080,"y":180,"wires":[]},{"id":"e28824d5.aa6b58","type":"link in","z":"d00c308a.cf163","name":"to ibm cloud","links":["86f7971c.e72298"],"x":235,"y":300,"wires":[["bf496e01.755e7","ce2610c.c4ac6f"]]},{"id":"bf496e01.755e7","type":"debug","z":"d00c308a.cf163","name":"emonTH24","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":330,"y":240,"wires":[]},{"id":"50d21c2f.434e94","type":"link in","z":"d00c308a.cf163","name":"","links":["366b49a2.6c53b6"],"x":235,"y":420,"wires":[["8fd78c46.70568","697d218c.c65b9"]]},{"id":"ce2610c.c4ac6f","type":"change","z":"d00c308a.cf163","name":"map to msg.payload.d","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"d\" : \t { \t   \"temp\" : payload.temp,\t   \"humidity\" : payload.humidity,\t   \"absolute_humidity\" : payload.absolute_humidity }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":300,"wires":[["9abc6b20.f98158","3eb22915.966fd6"]]},{"id":"9abc6b20.f98158","type":"debug","z":"d00c308a.cf163","name":"emonTH24 to Watson IoT","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":610,"y":240,"wires":[]},{"id":"8fd78c46.70568","type":"debug","z":"d00c308a.cf163","name":"3ch wifi relay","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":350,"y":360,"wires":[]},{"id":"ec2aa374.15e76","type":"debug","z":"d00c308a.cf163","name":"3ch wifi relay to Watson IoT","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":600,"y":360,"wires":[]},{"id":"697d218c.c65b9","type":"change","z":"d00c308a.cf163","name":"map to msg.payload.d","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"d\" : \t { \t   \"temp\" : payload.temp,\t   \"humidity\" : payload.humidity,\t   \"absolute_humidity\" : payload.absolute_humidity }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":420,"wires":[["ec2aa374.15e76","9432d198.d1c74"]]},{"id":"a05f2bed.4a7af8","type":"comment","z":"d00c308a.cf163","name":"Documentation","info":"This flow sends the temperature and humidity measured by the _emonTH24_ sensor and _3ch wifi relay_ sensor as a `sensor_status` event \nto [my watson IoT organization](https://eoxoyz.internetofthings.ibmcloud.com)\n\nThe event is processed by the following node-red flow: https://jvda-sensor.eu-gb.mybluemix.net/red/#flow/502835d4.966b8c","x":200,"y":40,"wires":[]},{"id":"3eb22915.966fd6","type":"wiotp out","z":"d00c308a.cf163","authType":"g","qs":"false","qsDeviceId":"","deviceKey":"f3a00a41.9ff0d8","deviceType":"emonTH","deviceId":"emonTH24","event":"sensor_status","format":"json","qos":"1","name":"emonTH24 via pi3one (Watson IoT)","x":920,"y":300,"wires":[]},{"id":"9432d198.d1c74","type":"wiotp out","z":"d00c308a.cf163","authType":"g","qs":"false","qsDeviceId":"","deviceKey":"f3a00a41.9ff0d8","deviceType":"3ch-wifi-relay","deviceId":"3ch-wifi-relay-01","event":"sensor_status","format":"json","qos":"1","name":"3ch-wifi-relay-01 via pi3one (Watson IoT)","x":920,"y":420,"wires":[]},{"id":"fa9e61ee.e106b","type":"wiotp in","z":"d00c308a.cf163","authType":"g","deviceKey":"f3a00a41.9ff0d8","deviceType":"","deviceId":"","command":"+","commandType":"g","qos":0,"name":"all commands send to pi3one gateway","x":190,"y":620,"wires":[["53e5a621.40f6d8","b7d79860.9de288"]]},{"id":"53e5a621.40f6d8","type":"debug","z":"d00c308a.cf163","name":"pi3one gateway command","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":330,"y":580,"wires":[]},{"id":"b7d79860.9de288","type":"switch","z":"d00c308a.cf163","name":"msg.command = \"ibmcloud_sensor_data\"","property":"command","propertyType":"msg","rules":[{"t":"eq","v":"ibmcloud_sensor_data","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":420,"y":680,"wires":[["727a5afe.9773d4","f2753553.aff5d8"]]},{"id":"727a5afe.9773d4","type":"debug","z":"d00c308a.cf163","name":"ibm cloud sensor data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":580,"y":640,"wires":[]},{"id":"f2753553.aff5d8","type":"change","z":"d00c308a.cf163","name":"convert to emoncms format","rules":[{"t":"set","p":"nodegroup","pt":"msg","to":"31","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"{\t  payload.sensor & \"_temp\": payload.temp,\t  payload.sensor & \"_rel_hum\" : payload.relative_humidity,\t  payload.sensor & \"_abs_hum\" : payload.absolute_humidity\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":596,"y":737,"wires":[["ba5f2f8f.d37a5","a4c75f96.8df92"]]},{"id":"ba5f2f8f.d37a5","type":"debug","z":"d00c308a.cf163","name":"emoncms message","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":730,"y":700,"wires":[]},{"id":"a4c75f96.8df92","type":"link out","z":"d00c308a.cf163","name":"ibmcloud_sensor_data","links":["79dec3f7.55210c"],"x":895,"y":740,"wires":[]},{"id":"e594a0d7.4f52e","type":"change","z":"d00c308a.cf163","name":"map to msg.payload.d","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"d\" : \t { \t   \"temp\" : payload.temp,\t   \"humidity\" : payload.humidity,\t   \"absolute_humidity\" : payload.absolute_humidity }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":140,"wires":[["707ae8be.8a5158","f76e5313.5a252"]]},{"id":"f76e5313.5a252","type":"wiotp out","z":"d00c308a.cf163","authType":"g","qs":"false","qsDeviceId":"","deviceKey":"f3a00a41.9ff0d8","deviceType":"emonTH","deviceId":"emonTH23","event":"sensor_status","format":"json","qos":"1","name":"emonTH23 via pi3one (Watson IoT)","x":920,"y":140,"wires":[]},{"id":"707ae8be.8a5158","type":"debug","z":"d00c308a.cf163","name":"emonTH23 to Watson IoT","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":650,"y":100,"wires":[]},{"id":"15daf13b.07e1bf","type":"debug","z":"d00c308a.cf163","name":"emonTH23","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":330,"y":100,"wires":[]},{"id":"401d76ce.e60f08","type":"link in","z":"d00c308a.cf163","name":"to ibm cloud","links":["b2f7a7e1.9ac498"],"x":235,"y":140,"wires":[["15daf13b.07e1bf","e594a0d7.4f52e"]]},{"id":"adc27151.92c12","type":"mqtt in","z":"9ec36226.6064b","name":"","topic":"water_meter/raw_pulse_count","qos":"2","broker":"9c9ae2bc.63652","x":140,"y":120,"wires":[["ed49b128.cec78","fde82430.4f7c08"]]},{"id":"ed49b128.cec78","type":"debug","z":"9ec36226.6064b","name":"water_meter/raw_pulse_count","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":490,"y":120,"wires":[]},{"id":"921066c7.7c9208","type":"range","z":"9ec36226.6064b","minin":"0","maxin":"2","minout":"0","maxout":"1","action":"scale","round":false,"property":"payload","name":"to liter","x":690,"y":580,"wires":[["5bb4b73f.bd8b98","b9ff1b09.ac6858","4cbb7d37.4d1c34","dca9872d.73d518","7d354d0b.d30e54","704e87d2.630a28","c0898a98.1c2c78"]]},{"id":"5a4feace.3cf584","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"raw_pulse_count","pt":"flow","to":"raw_pulse_count","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":300,"wires":[[]]},{"id":"54c13ed9.2bced","type":"link in","z":"d00c308a.cf163","name":"","links":["f62cf426.7009d8"],"x":235,"y":520,"wires":[["2a1e2c53.6928c4","e6af1199.d5038"]]},{"id":"2a1e2c53.6928c4","type":"debug","z":"d00c308a.cf163","name":"openweather","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":350,"y":460,"wires":[]},{"id":"e6af1199.d5038","type":"change","z":"d00c308a.cf163","name":"map to msg.payload.d","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"d\" : \t { \t   \"temp\" : payload.temp,\t   \"humidity\" : payload.humidity,\t   \"absolute_humidity\" : payload.absolute_humidity }\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":520,"wires":[["90d058c0.b356f8","b06ca770.adb938"]]},{"id":"90d058c0.b356f8","type":"debug","z":"d00c308a.cf163","name":"openweather to Watson IoT","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"payload","x":620,"y":480,"wires":[]},{"id":"b06ca770.adb938","type":"wiotp out","z":"d00c308a.cf163","authType":"g","qs":"false","qsDeviceId":"","deviceKey":"f3a00a41.9ff0d8","deviceType":"openweather","deviceId":"openweather-01","event":"sensor_status","format":"json","qos":"1","name":"openweather-01 via pi3one (Watson IoT)","x":920,"y":520,"wires":[]},{"id":"4dfa66bb.0b1df8","type":"smooth","z":"9ec36226.6064b","name":"smooth over last minute","property":"payload","action":"mean","count":"12","round":"1","mult":"single","x":1010,"y":460,"wires":[["43aae6a.e844918"]]},{"id":"43aae6a.e844918","type":"ui_gauge","z":"9ec36226.6064b","name":"water usage last minute","group":"f50c0ee3.d016b","order":1,"width":"3","height":"3","gtype":"wave","title":"","label":" l/min","format":"{{value}}","min":0,"max":10,"colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":1270,"y":460,"wires":[]},{"id":"dc140686.c1ad98","type":"ui_template","z":"9ec36226.6064b","group":"1b6e52cb.30e93d","name":"last day","order":1,"width":"10","height":"4","format":"<div ng-bind-html=\"msg.payload\"></div>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1220,"y":540,"wires":[[]]},{"id":"4c252d90.140c54","type":"ui_template","z":"9ec36226.6064b","group":"f50c02cd.1436a","name":"last hour","order":1,"width":"20","height":"4","format":"<div ng-bind-html=\"msg.payload\"></div>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1220,"y":500,"wires":[[]]},{"id":"7d354d0b.d30e54","type":"range","z":"9ec36226.6064b","minin":"0","maxin":"5","minout":"0","maxout":"60","action":"scale","round":false,"property":"payload","name":"","x":810,"y":460,"wires":[["4dfa66bb.0b1df8"]]},{"id":"dea7099d.d2cca8","type":"change","z":"9ec36226.6064b","name":"prepare for emoncms (nodegroup 29)","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"water_meter_liter_per_5min\" : payload }","tot":"jsonata"},{"t":"set","p":"nodegroup","pt":"msg","to":"29","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1170,"y":620,"wires":[["e6138e9d.01533"]]},{"id":"e6138e9d.01533","type":"link out","z":"9ec36226.6064b","name":"nodeMCU water meter pulse count","links":["79dec3f7.55210c"],"x":1375,"y":620,"wires":[]},{"id":"fde82430.4f7c08","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"raw_pulse_count","pt":"msg","to":"$number(payload)\t","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":180,"wires":[["425b7cf5.b7e024","10a0beff.571f11"]]},{"id":"10a0beff.571f11","type":"change","z":"9ec36226.6064b","name":"set msg.payload as delta","rules":[{"t":"set","p":"payload","pt":"msg","to":"raw_pulse_count - $flowContext(\"raw_pulse_count\")","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"water_meter","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":240,"wires":[["1da293ea.e3b8dc","3ae8b333.be3bcc","5a4feace.3cf584"]]},{"id":"3ae8b333.be3bcc","type":"switch","z":"9ec36226.6064b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gte","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":300,"wires":[["5cf41860.4bd058"],["e968a7f6.d106d8"]]},{"id":"5cf41860.4bd058","type":"range","z":"9ec36226.6064b","minin":"0","maxin":"2","minout":"0","maxout":"1","action":"scale","round":false,"property":"payload","name":"to liter","x":610,"y":300,"wires":[["aefbf145.531bd","679f9385.ca2f2c"]]},{"id":"1da293ea.e3b8dc","type":"debug","z":"9ec36226.6064b","name":"delta raw pulse count","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":520,"y":240,"wires":[]},{"id":"425b7cf5.b7e024","type":"debug","z":"9ec36226.6064b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"raw_pulse_count","x":500,"y":180,"wires":[]},{"id":"996ab4a3.5f8608","type":"ui_template","z":"9ec36226.6064b","group":"f50c02cd.1436a","name":"last hour (raw count)","order":1,"width":"20","height":"4","format":"<div ng-bind-html=\"msg.payload\"></div>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1140,"y":260,"wires":[[]]},{"id":"8bb8f164.85248","type":"ui_template","z":"9ec36226.6064b","group":"1b6e52cb.30e93d","name":"last day (raw count)","order":1,"width":"10","height":"4","format":"<div ng-bind-html=\"msg.payload\"></div>","storeOutMessages":true,"fwdInMessages":true,"templateScope":"local","x":1130,"y":300,"wires":[[]]},{"id":"e968a7f6.d106d8","type":"debug","z":"9ec36226.6064b","name":"negative water meter delta raw pulse count","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":730,"y":340,"wires":[]},{"id":"aefbf145.531bd","type":"sum-bars","z":"9ec36226.6064b","name":"sum bars last hour (raw count)","title":"last hour (raw count)","period":"hour","yMin":"auto","yMax":"auto","showBarsValue":true,"showScaleValue":true,"showSumValue":true,"maxBar":"25","topColor":"#950095","bottomColor":"#ff9dff","unit":"","fontColor":"#004080","barStyle":"Rectangle","decimal":1,"x":850,"y":260,"wires":[["996ab4a3.5f8608"]]},{"id":"679f9385.ca2f2c","type":"sum-bars","z":"9ec36226.6064b","name":"sum bars last day (raw count)","title":"last day (raw count)","period":"day","yMin":"auto","yMax":"auto","showBarsValue":true,"showScaleValue":true,"showSumValue":true,"maxBar":"25","topColor":"#950095","bottomColor":"#ff9dff","unit":"","fontColor":"#004080","barStyle":"Rectangle","decimal":1,"x":850,"y":300,"wires":[["8bb8f164.85248"]]},{"id":"704e87d2.630a28","type":"sum-bars","z":"9ec36226.6064b","name":"sum bars last hour","title":"last hour","period":"hour","yMin":"auto","yMax":"auto","showBarsValue":true,"showScaleValue":true,"showSumValue":true,"maxBar":"25","topColor":"#bbbbff","bottomColor":"#0000aa","unit":"","fontColor":"#004080","barStyle":"Rectangle","decimal":1,"x":970,"y":500,"wires":[["4c252d90.140c54"]]},{"id":"c0898a98.1c2c78","type":"sum-bars","z":"9ec36226.6064b","name":"sum bars last day","title":"last day","period":"day","yMin":"auto","yMax":"auto","showBarsValue":true,"showScaleValue":true,"showSumValue":true,"maxBar":"25","topColor":"#bbbbff","bottomColor":"#0000aa","unit":"","fontColor":"#004080","barStyle":"Rectangle","decimal":1,"x":970,"y":540,"wires":[["dc140686.c1ad98"]]},{"id":"85a6cdec.3fae3","type":"switch","z":"9ec36226.6064b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"jsonata_exp","v":"$flowContext(\"total_water\")=0\t","vt":"jsonata"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":770,"y":760,"wires":[["be761109.2ae26"],["75c48fe7.5fb15"],["ba22bbca.add6d8"]]},{"id":"be761109.2ae26","type":"change","z":"9ec36226.6064b","name":"flow.total_water = 0","rules":[{"t":"set","p":"total_water","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":720,"wires":[["f03bf10e.589fb"]]},{"id":"ba22bbca.add6d8","type":"change","z":"9ec36226.6064b","name":"update flow.total_water","rules":[{"t":"set","p":"total_water","pt":"flow","to":"$flowContext(\"total_water\")+payload","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1100,"y":840,"wires":[["6c1747f0.7997c8"]]},{"id":"75c48fe7.5fb15","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"start_time","pt":"flow","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":990,"y":760,"wires":[["ba22bbca.add6d8"]]},{"id":"6c1747f0.7997c8","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"\"start time = \" & $fromMillis($flowContext(\"start_time\")) & \" : total water =\" & $flowContext(\"total_water\") & \" liters \"","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":780,"wires":[["6e364ec.8642ab"]]},{"id":"6e364ec.8642ab","type":"ui_text","z":"9ec36226.6064b","group":"4fce2e4b.e9118","order":0,"width":0,"height":0,"name":"","label":"huidig verbruik","format":"{{msg.payload}}","layout":"col-center","x":1480,"y":760,"wires":[]},{"id":"f03bf10e.589fb","type":"change","z":"9ec36226.6064b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"no water used last 5 minutes.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":740,"wires":[["6e364ec.8642ab"]]}]